<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ูุธุงู ุงููุณุชูุฏุน ุงูุฐูู V9 (Polite AI)</title>

  <!-- ุงูููุชุจุงุช ุงูุฎุงุฑุฌูุฉ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#2563eb', secondary: '#10b981', dark: '#1e293b' },
          height: { 'screen-dvh': '100dvh' }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    body { font-family: 'Tajawal', sans-serif; overflow: hidden; touch-action: manipulation; }

    .mic-active { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .fade-in { animation: fadeIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen-dvh w-full flex flex-col">

  <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-[90%] max-w-md text-center">
      <div class="mb-6 bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-primary">
        <i class="fas fa-user-tie text-4xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">ุงููุณุงุนุฏ ุงูุดุฎุตู V9</h2>
      <p class="text-gray-500 mb-6 text-sm">ุฃููุงู ุจู ูุง ุฃุณุชุงุฐ</p>

      <div class="space-y-4">
        <select id="user-select" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
          <option value="1">๐ค ุญุณู (ูุณุคูู - Admin)</option>
          <option value="2">๐ ูุนุชุฒ (ุนุฑุถ ููุท)</option>
          <option value="3">๐ฆ ูุญูุฏ (ูุฏูุฑ ูุณุชูุฏุน)</option>
        </select>
        <input type="password" id="password-input" placeholder="ูููุฉ ุงููุฑูุฑ (123)" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
        <button onclick="login()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">
          ุชุณุฌูู ุงูุฏุฎูู
        </button>
      </div>
      <p id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold animate-bounce">โ๏ธ ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ</p>
    </div>
  </div>

  <!-- ูุงุฌูุฉ ุงูุชุทุจูู -->
  <div id="app-interface" class="flex h-full w-full hidden relative">

    <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (PC) -->
    <aside class="hidden lg:flex w-72 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-col shadow-xl z-20">
      <div class="p-6 border-b dark:border-gray-700 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg"><i class="fas fa-robot"></i></div>
        <div>
          <h3 id="user-greeting-pc" class="font-bold text-gray-800 dark:text-white">ูุฑุญุจุงู</h3>
          <p id="user-role-pc" class="text-xs text-gray-500 dark:text-gray-400"></p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="switchTab('chat')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-comments text-blue-500 text-xl w-6"></i> ุงููุญุงุฏุซุฉ
        </button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-boxes text-green-500 text-xl w-6"></i> ุงููุฎุฒูู
        </button>
        <button onclick="switchTab('stats')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-chart-pie text-purple-500 text-xl w-6"></i> ุงูุชูุงุฑูุฑ
        </button>
      </nav>

      <div class="p-4 border-t dark:border-gray-700 space-y-2">
        <button onclick="openSettings()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>โ๏ธ ุงูุฅุนุฏุงุฏุงุช</span><i class="fas fa-sliders text-gray-500"></i>
        </button>
        <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>ุงููุถุน ุงููููู</span><i class="fas fa-moon text-yellow-500"></i>
        </button>
        <button onclick="logout()" class="w-full bg-red-100 text-red-600 hover:bg-red-200 py-3 rounded-xl font-bold transition">
          <i class="fas fa-sign-out-alt ml-2"></i> ุฎุฑูุฌ
        </button>
      </div>
    </aside>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-100 dark:bg-gray-900">

      <!-- ุฑุฃุณ ุงูุตูุญุฉ (Mobile) -->
      <header class="lg:hidden bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center z-10 h-16 shrink-0">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm"><i class="fas fa-robot"></i></div>
          <span id="user-greeting-mobile" class="font-bold text-sm">ูุฑุญุจุงู</span>
        </div>
        <div class="flex gap-3">
          <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-sliders text-gray-600 dark:text-gray-200"></i>
          </button>
          <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-moon text-yellow-500"></i>
          </button>
          <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden relative w-full">

        <!-- 1. ุงููุญุงุฏุซุฉ -->
        <section id="tab-chat" class="h-full flex flex-col w-full">
          <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 lg:pb-4"></div>

          <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3 lg:p-4 shadow-lg z-20 shrink-0">
            <div class="flex justify-center gap-4 mb-3 text-xs overflow-x-auto pb-1">
              <button onclick="clearChat()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-trash"></i> ูุณุญ
              </button>
              <button onclick="exportChatPDF()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-blue-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="shareWhatsApp()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-green-100 text-gray-600 dark:text-gray-300">
                <i class="fab fa-whatsapp"></i> ูุงุชุณุงุจ
              </button>
            </div>

            <div class="max-w-3xl mx-auto">
              <div class="flex items-center gap-2">
                <button id="mic-btn" onclick="toggleListening()"
                  class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-white flex items-center justify-center hover:bg-gray-300 transition shadow-sm active:scale-90">
                  <i class="fas fa-microphone text-xl"></i>
                </button>

                <input type="text" id="chat-input"
                  placeholder="ุชูุถู ุจุงูููุงู ูุง ุฃุณุชุงุฐ..."
                  class="flex-1 h-12 px-4 rounded-full bg-gray-100 dark:bg-gray-900 border-none focus:ring-2 focus:ring-primary outline-none transition"
                  onkeypress="handleEnter(event)" />

                <button onclick="processInput()" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center hover:bg-blue-600 transition shadow-md active:scale-90">
                  <i class="fas fa-paper-plane text-lg"></i>
                </button>
              </div>
              <div id="mic-status" class="mt-2 text-xs text-gray-500 dark:text-gray-300 text-center"></div>
            </div>
          </div>
        </section>

        <!-- 2. ุงููุฎุฒูู -->
        <section id="tab-inventory" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2">
            <h2 class="text-xl font-bold">๐ฆ ุงููุฎุฒูู</h2>
            <div class="flex gap-2">
              <button onclick="exportExcel()" class="bg-green-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-file-excel"></i></button>
              <button id="btn-add-modal" onclick="openAddModal()" class="bg-blue-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-plus"></i></button>
            </div>
          </div>
          <div class="relative mb-4">
            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            <input type="text" id="inventory-search" onkeyup="renderInventory()" placeholder="ุจุญุซ ุนู ููุฏูู ุฃู ููุน..."
              class="w-full p-3 pr-10 rounded-xl border-none shadow-sm dark:bg-gray-800" />
          </div>
          <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </section>

        <!-- 3. ุงูุฅุญุตุงุฆูุงุช -->
        <section id="tab-stats" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-xl font-bold mb-4">๐ ุชูุงุฑูุฑ</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ุชูุฒูุน ุงูุฃุตูุงู</h3>
              <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ุชูุจููุงุช ุงูููุงูุต</h3>
              <div id="stock-alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </section>

      </div>

      <!-- ุงูุชููู ุงูุณููู (Mobile) -->
      <nav class="lg:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center h-16 shrink-0 z-30 pb-safe">
        <button onclick="switchTab('chat')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-primary">
          <i class="fas fa-comments text-xl mb-1"></i><span class="text-xs font-medium">ูุญุงุฏุซุฉ</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-boxes text-xl mb-1"></i><span class="text-xs font-medium">ูุฎุฒูู</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-xs font-medium">ุฅุญุตุงุก</span>
        </button>
      </nav>

    </main>
  </div>

  <!-- ูุงูุฐุฉ ููุจุซูุฉ: ุฅุฏุงุฑุฉ ููุชุฌ -->
  <div id="modal-form" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-all scale-100">
      <h3 class="text-xl font-bold mb-4 text-center">ุฅุฏุงุฑุฉ ููุชุฌ</h3>
      <div class="space-y-3">
        <input type="text" id="m-model" placeholder="ุฑูู ุงูููุฏูู (ูุซุงู w334)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <select id="m-type" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
          <option value="ุทุงููุฉ ูุณุท">ุทุงููุฉ ูุณุท</option>
          <option value="ุทุงููุฉ ุชููุฒููู">ุทุงููุฉ ุชููุฒููู</option>
          <option value="ุฏุฑุณูุงุฑ">ุฏุฑุณูุงุฑ</option>
        </select>
        <input type="number" id="m-count" placeholder="ุงูุนุฏุฏ" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative">
          <input type="file" id="m-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
          <p class="text-xs text-gray-500">ุงุถุบุท ูุฑูุน ุตูุฑุฉ</p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl font-bold">ุฅูุบุงุก</button>
        <button onclick="saveItem()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">ุญูุธ</button>
      </div>
    </div>
  </div>

  <!-- ูุงูุฐุฉ ููุจุซูุฉ: ุงูุฅุนุฏุงุฏุงุช -->
  <div id="settings-modal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุตูุช</h3>
        <button onclick="closeSettings()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="bg-gray-50 dark:bg-gray-900/40 rounded-xl p-4">
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
          ุงูุชุญูู ูู <b>ูุจุฑุฉ ุงูุตูุช</b> (Pitch).
        </p>

        <label class="text-sm font-bold block mb-2">ุงููุจุฑุฉ</label>
        <div class="flex items-center gap-3">
          <input id="pitch-slider" type="range" min="0.6" max="1.6" step="0.05"
                 class="w-full accent-blue-600" oninput="onPitchChange(this.value)">
          <div class="w-16 text-center bg-white dark:bg-gray-800 rounded-lg py-2 text-sm font-bold">
            <span id="pitch-value">1.00</span>
          </div>
        </div>

        <div class="flex gap-3 mt-4">
          <button onclick="testVoice()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 rounded-xl font-bold">ุชุฌุฑุจุฉ</button>
          <button onclick="resetPitch()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">ุถุจุท ูุตูุน</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // 1) ุฅุนุฏุงุฏุงุช ุนุงูุฉ
    // -------------------------
    const USERS = {
      1: { name: "ุญุณู", role: "admin", pass: "123", label: "ูุณุคูู" },
      2: { name: "ูุนุชุฒ", role: "viewer", pass: "123", label: "ูุดุงูุฏ" },
      3: { name: "ูุญูุฏ", role: "manager", pass: "123", label: "ูุฏูุฑ" }
    };

    let currentUser = null;
    let db;
    let chartInstance = null;

    const APP_TIMEZONE = null;

    // โ ูุนูููุงุช ุงููุทูุฑ
    const DEVELOPER_INFO = {
      name: "ุงููููุฏุณ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงู",
      title: "ูููุฏุณ ุจุฑูุฌูุงุช"
    };

    // -------------------------
    // 2) ุฅุนุฏุงุฏุงุช ุงูุตูุช
    // -------------------------
    const synth = window.speechSynthesis;
    const VOICE_SETTINGS_KEY = "warehouse_voice_settings_v1";
    const voiceSettings = { pitch: 1.0 };

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function loadVoiceSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem(VOICE_SETTINGS_KEY) || "{}");
        if (typeof saved.pitch === "number") voiceSettings.pitch = clamp(saved.pitch, 0.6, 1.6);
      } catch (_) {}
      updatePitchUI();
    }

    function saveVoiceSettings() {
      localStorage.setItem(VOICE_SETTINGS_KEY, JSON.stringify({ pitch: voiceSettings.pitch }));
    }

    function openSettings() {
      updatePitchUI();
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

    function updatePitchUI() {
      const slider = document.getElementById('pitch-slider');
      const label = document.getElementById('pitch-value');
      if (!slider || !label) return;
      slider.value = String(voiceSettings.pitch);
      label.innerText = voiceSettings.pitch.toFixed(2);
    }

    function onPitchChange(v) {
      voiceSettings.pitch = clamp(parseFloat(v), 0.6, 1.6);
      document.getElementById('pitch-value').innerText = voiceSettings.pitch.toFixed(2);
      saveVoiceSettings();
    }

    function resetPitch() {
      voiceSettings.pitch = 1.0;
      updatePitchUI();
      saveVoiceSettings();
      speak("ุชูุช ุฅุนุงุฏุฉ ุถุจุท ูุจุฑุฉ ุงูุตูุช.");
    }

    function testVoice() { speak("ูุฐู ุชุฌุฑุจุฉ ููุตูุช ูุง ุฃุณุชุงุฐ."); }

    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      try {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(String(text || ""));
        u.lang = 'ar-SA';
        u.pitch = voiceSettings.pitch;
        u.rate = 1.0;
        synth.speak(u);
      } catch (_) {}
    }

    // -------------------------
    // 3) ูุงุนุฏุฉ ุงูุจูุงูุงุช
    // -------------------------
    const request = indexedDB.open("WarehouseV9_Polite", 1);
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains('inventory')) {
        const store = db.createObjectStore('inventory', { keyPath: "model" });
        store.add({ model: "w334", type: "ุทุงููุฉ ูุณุท", count: 15, img: "https://placehold.co/150/png?text=W334" });
        store.add({ model: "tv500", type: "ุทุงููุฉ ุชููุฒููู", count: 5, img: "https://placehold.co/150/png?text=TV500" });
        store.add({ model: "ds120", type: "ุฏุฑุณูุงุฑ", count: 3, img: "https://placehold.co/150/png?text=DS120" });
      }
      if (!db.objectStoreNames.contains('chats')) {
        db.createObjectStore('chats', { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = (e) => { db = e.target.result; loadVoiceSettings(); loadChatHistory(); };

    // -------------------------
    // 4) ุชุณุฌูู ุงูุฏุฎูู
    // -------------------------
    function login() {
      const id = document.getElementById('user-select').value;
      const pass = document.getElementById('password-input').value;

      if (USERS[id] && USERS[id].pass === pass) {
        currentUser = { ...USERS[id], id: parseInt(id) };

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-interface').classList.remove('hidden');
        document.getElementById('app-interface').classList.add('flex');

        document.getElementById('user-greeting-pc').innerText = `ุฃููุงูุ ุฃุณุชุงุฐ ${currentUser.name}`;
        document.getElementById('user-role-pc').innerText = currentUser.label;
        document.getElementById('user-greeting-mobile').innerText = `ุฃุณุชุงุฐ ${currentUser.name}`;

        if (currentUser.role === 'viewer') document.getElementById('btn-add-modal').classList.add('hidden');

        renderInventory();
        updateStats();
        initSpeech();

        speak(`ูุฑุญุจุงู ูุง ุฃุณุชุงุฐ ${currentUser.name}ุ ุงููุธุงู ุฌุงูุฒ ูุฎุฏูุชู.`);
        setMicStatus(getMicSupportMessage(), false);
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    function logout() { location.reload(); }

    function switchTab(tabId) {
      ['chat', 'inventory', 'stats'].forEach(id => document.getElementById(`tab-${id}`).classList.add('hidden'));
      const activeSection = document.getElementById(`tab-${tabId}`);
      activeSection.classList.remove('hidden');
      activeSection.classList.add('flex');
      if (tabId === 'stats') updateStats();
    }

    function toggleTheme() { document.documentElement.classList.toggle('dark'); }

    // -------------------------
    // 5) ุงููููุฑูููู
    // -------------------------
    let recognition = null;
    let isListening = false;

    function isSecureContextForMic() {
      return window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1";
    }

    function hasSpeechRecognition() {
      return ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
    }

    function getMicSupportMessage() {
      if (!isSecureContextForMic()) return "ุงููููุฑูููู ูุญุชุงุฌ HTTPS.";
      if (!hasSpeechRecognition()) return "ุงููุชุตูุญ ูุง ูุฏุนู ุงูุตูุช.";
      return "ุงุถุบุท ุงููููุฑูููู ููุชุญุฏุซ.";
    }

    function setMicStatus(msg, danger=false) {
      const el = document.getElementById("mic-status");
      if (!el) return;
      el.textContent = msg || "";
      el.className = "mt-2 text-xs text-center " + (danger ? "text-red-500" : "text-gray-500 dark:text-gray-300");
    }

    function initSpeech() {
      if (!hasSpeechRecognition()) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isListening = true;
        document.getElementById('mic-btn').classList.add('mic-active');
        setMicStatus("ุชูุถู ุจุงูููุงู ูุง ุฃุณุชุงุฐ...", false);
      };

      recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;
        setMicStatus("ุงุถุบุท ููุชุญุฏุซ ูุฌุฏุฏุงู.", false);
      };

      recognition.onerror = () => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;
        setMicStatus("ุนุฐุฑุงู ูุง ุฃุณุชุงุฐุ ูู ุฃุณูุน ุฌูุฏุงู.", true);
      };

      recognition.onresult = (event) => {
        const raw = event.results?.[0]?.[0]?.transcript || "";
        if (!raw.trim()) return;

        const fixed = fixSpokenModels(raw);
        document.getElementById('chat-input').value = fixed;
        processInput(fixed);
      };
    }

    function toggleListening() {
      if (!recognition) initSpeech();
      if (isListening) { recognition.stop(); return; }
      try { recognition.start(); } catch (e) { console.log(e); }
    }

    // -------------------------
    // 6) ุงูุฐูุงุก ุงูุงุตุทูุงุนู + ุฅุตูุงุญ ุฃุญุฑู ุฅูุฌููุฒูุฉ ููุทููุฉ ุจุงูุนุฑุจู
    // -------------------------
    function handleEnter(e) { if (e.key === 'Enter') processInput(); }

    function normalizeArabic(s) {
      if (!s) return "";
      return s.toString().toLowerCase()
        .replace(/[\u064B-\u0652]/g, "")
        .replace(/[ุฅุฃุขุง]/g, "ุง")
        .replace(/ู/g, "ู")
        .replace(/ุค/g, "ู")
        .replace(/ุฆ/g, "ู")
        .replace(/ุฉ/g, "ู")
        .replace(/ู/g, "")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function toAsciiDigits(str) {
      return String(str || "")
        .replace(/[ู-ูฉ]/g, d => String("ููกูขูฃูคูฅูฆูงูจูฉ".indexOf(d)))
        .replace(/[ฐ-น]/g, d => String("ฐฑฒณดตถทธน".indexOf(d)));
    }

    function fixSpokenModels(input) {
      let s = String(input || "");
      s = toAsciiDigits(s);

      s = s.replace(/[ุ,.;:!?(){}\[\]"'ยซยป<>\/\\|_+=\-]/g, " ");
      s = s.replace(/\s+/g, " ").trim();

      const rawTokens = s.split(" ").filter(Boolean);

      const dict = new Map([
        ["ุฏุจููู", "w"], ["ุฏุจููู.", "w"],
        ["ุชู", "t"], ["ูู", "v"],
        ["ุชููู", "tv"], ["ุชูฺคู", "tv"],
        ["ุฏู", "d"], ["ุงุณ", "s"],
        ["ุฏูุงุณ", "ds"],
        ["ุงู", "a"], ["ุฃูู", "a"],
        ["ุจู", "b"], ["ุณู", "c"],
        ["ุงู", "f"], ["ุฌู", "g"],
        ["ุงุชุด", "h"], ["ูู", "k"],
        ["ุงู", "l"], ["ุฅู", "l"],
        ["ุงู", "m"], ["ุฅู", "m"],
        ["ุงู", "n"], ["ุฅู", "n"],
        ["ุงู", "o"], ["ููู", "q"],
        ["ุงุฑ", "r"], ["ูู", "u"],
        ["ฺคู", "v"], ["ุงูุณ", "x"],
        ["ุฅูุณ", "x"], ["ูุงู", "y"],
        ["ุฒุฏ", "z"], ["ุฒูุฏ", "z"],
      ]);

      const normTok = (t) => normalizeArabic(t);

      const out = [];
      for (let i = 0; i < rawTokens.length; i++) {
        const t1 = normTok(rawTokens[i]);
        const t2 = rawTokens[i+1] ? normTok(rawTokens[i+1]) : "";

        if ((t1 === "ุชู" || t1 === "t") && (t2 === "ูู" || t2 === "v" || t2 === "ฺคู")) {
          out.push("tv");
          i++;
          continue;
        }

        if ((t1 === "ุฏู" || t1 === "d") && (t2 === "ุงุณ" || t2 === "s")) {
          out.push("ds");
          i++;
          continue;
        }

        if (t1 === "ุฏุจููู") { out.push("w"); continue; }

        if (/^[a-z]+$/i.test(rawTokens[i]) || /^\d+$/.test(rawTokens[i])) {
          out.push(rawTokens[i].toLowerCase());
          continue;
        }

        if (dict.has(t1)) {
          out.push(dict.get(t1));
          continue;
        }

        out.push(rawTokens[i]);
      }

      let joined = out.join(" ");
      joined = joined.replace(/\b([a-z]{1,5})\s+(\d{1,6})\b/gi, (_, a, b) => `${a}${b}`);
      joined = joined.replace(/\s+/g, " ").trim();

      return joined;
    }

    function extractModels(raw) {
      const s = fixSpokenModels(raw);
      const m = s.match(/\b[a-z]{1,5}\d{1,6}\b/gi);
      return m ? [...new Set(m.map(x => x.toLowerCase()))] : [];
    }

    function bestTypeFromText(textNorm) {
      const map = [
        { type: "ุทุงููุฉ ูุณุท", keys: ["ุทุงููุฉ ูุณุท", "ุทุงููู ูุณุท", "ูุณุท"] },
        { type: "ุทุงููุฉ ุชููุฒููู", keys: ["ุทุงููุฉ ุชููุฒููู", "ุชููุฒููู", "ุชู ูู", "tv", "ุดุงุดุฉ", "ุดุงุดู"] },
        { type: "ุฏุฑุณูุงุฑ", keys: ["ุฏุฑุณูุงุฑ", "ุฏุฑูุณูุงุฑ", "ุชุณุฑูุญู", "ูููุณูู", "ูุฑุงูุฉ", "ูุฑุงูู"] }
      ];
      for (const row of map) {
        if (row.keys.map(normalizeArabic).some(k => textNorm.includes(k))) return row.type;
      }
      return null;
    }

    function parseDateTimeIntent(textNorm) {
      const has = (arr) => arr.some(k => textNorm.includes(normalizeArabic(k)));

      const wantTime = has(["ููุช","ุงูููุช","ุณุงุนู","ุงูุณุงุนุฉ","ุงูุณุงุนุฉ ูู","ูู ุงูุณุงุนู","ูู ุงูุณุงุนุฉ","ูู ุงูููุช","ุดู ุงูููุช","ุงูุด ุงูููุช"]);
      const wantDate = has(["ุชุงุฑูุฎ","ุงูุชุงุฑูุฎ","ูู ุงูุชุงุฑูุฎ","ุดู ุงูุชุงุฑูุฎ","ุงู ุชุงุฑูุฎ","ุชุงุฑูุฎ ุงูููู"]);
      const wantDay  = has(["ุงูููู ุดู","ุดู ุงูููู","ุงู ููู","ุงูุด ุงูููู","ุงุณู ุงูููู","ููุงุฑ ุงูุด","ููุงุฑ ุดู"]);
      const wantAll  = has(["ุงููู","ููู","ูู ุดู","ุงูููุช ูุงูุชุงุฑูุฎ","ุงูููุช ู ุงูุชุงุฑูุฎ","ุงูููู ูุงูุชุงุฑูุฎ","ุงูููู ู ุงูุชุงุฑูุฎ","ุงูููู ูุงูููุช","ุงูููู ู ุงูููุช","ุงูููู ูุงูุชุงุฑูุฎ ูุงูููุช","ุงูููู ู ุงูุชุงุฑูุฎ ู ุงูููุช"]);

      let offsetDays = 0;
      if (has(["ุจุนุฏ ุจูุฑุง","ุจุนุฏ ุบุฏ"])) offsetDays = 2;
      else if (has(["ุจูุฑุง","ุบุฏุง"])) offsetDays = 1;
      else if (has(["ุงูู ุงูุณ","ุงูู ูุจุงุฑุญ"])) offsetDays = -2;
      else if (has(["ุงูุณ","ูุจุงุฑุญ"])) offsetDays = -1;
      else if (has(["ุงูููู"])) offsetDays = 0;

      return {
        isAsking: wantAll || wantTime || wantDate || wantDay,
        wantTime: wantAll ? true : wantTime,
        wantDate: wantAll ? true : wantDate,
        wantDay:  wantAll ? true : wantDay,
        offsetDays
      };
    }

    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }

    function formatTime(d) {
      return new Intl.DateTimeFormat('ar-SY', {
        hour: '2-digit', minute: '2-digit', hour12: true,
        timeZone: APP_TIMEZONE || undefined
      }).format(d);
    }

    function formatDateLong(d) {
      return new Intl.DateTimeFormat('ar-SY', {
        year: 'numeric', month: 'long', day: 'numeric',
        timeZone: APP_TIMEZONE || undefined
      }).format(d);
    }

    function formatWeekday(d) {
      return new Intl.DateTimeFormat('ar-SY', {
        weekday: 'long',
        timeZone: APP_TIMEZONE || undefined
      }).format(d);
    }

    function describeOffset(offsetDays) {
      if (offsetDays === 0) return "ุงูููู";
      if (offsetDays === 1) return "ุจูุฑุง";
      if (offsetDays === 2) return "ุจุนุฏ ุจูุฑุง";
      if (offsetDays === -1) return "ุฃูุณ";
      if (offsetDays === -2) return "ุฃูู ุฃูุณ";
      return "ุจูุฐุง ุงูููู";
    }

    function buildDateTimeReply(uName, intent) {
      const now = new Date();
      const target = addDays(now, intent.offsetDays);

      const parts = [];
      if (intent.wantDay)  parts.push(`๐ ${describeOffset(intent.offsetDays)} ูู **${formatWeekday(target)}**`);
      if (intent.wantDate) parts.push(`๐๏ธ ุงูุชุงุฑูุฎ: **${formatDateLong(target)}**`);
      if (intent.wantTime) parts.push(`โฐ ุงูููุช ุงูุขู: **${formatTime(now)}**`);

      if (!parts.length) return null;
      return `ุชูุถู ูุง ${uName}:\n\n${parts.join("\n")}`;
    }








    // โ ุฏุงูุฉ ุงูุชุนุงูู ูุน ุงูุฃุณุฆูุฉ ุงูุฌุฏูุฏุฉ
 function handleSpecialQuestions(textNorm, uName) {
  // ููู ุญุงูู
  if (textNorm.match(/(ููู ุญุงูู|ูููู|ุดู ุงุฎุจุงุฑู|ุดูููู|ููู ุงูุญุงู|ุดู ุงูุงุญูุงู)/)) {
    const responses = [
      `ุงูุญูุฏ ููู ูุง ${uName}ุ ุจุฎูุฑ ูุฌุงูุฒ ูุฎุฏูุชู! ๐`,
      `ุชูุงู ูุง ${uName}ุ ุดู ุจุฏู ุณุงุนุฏู ูููุ`,
      `ุจุฎูุฑ ูุนุงููุฉ ูุง ${uName}ุ ููู ุจูุฏุฑ ุฎุฏููุ`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  // ุดู ุงุณูู
  if (textNorm.match(/(ุดู ุงุณูู|ุงูุด ุงุณูู|ุงุณูู ุดู|ุงุณูู ุงูุด|ููู ุงุณูู|ูุง ุงุณูู)/)) {
    return `ุงุณูู **ุงููุณุงุนุฏ ุงูุฐูู ูุงู ุณูุงุฑุช** ูุง ${uName}ุ ูุตูู ุฎุตูุตุงู ูุฅุฏุงุฑุฉ ุงููุณุชูุฏุนุงุช! ๐ค`;
  }

  // ูู ุตูุนู / ูู ุทูุฑู
  if (textNorm.match(/(ูู ุตูุนู|ูู ุทูุฑู|ููู ุตูุนู|ููู ุทูุฑู|ููู ุนููู|ูู ุจุฑูุฌู|ููู ุจุฑูุฌู|ูู ุงููุทูุฑ|ููู ุงููุจุฑูุฌ)/)) {
    return `ุชู ุชุทููุฑู ุจูุงุณุทุฉ **${DEVELOPER_INFO.name}** ๐จโ๐ป\n\n${DEVELOPER_INFO.title} ูุชุฎุตุต ูู ุชุทููุฑ ุงูุฃูุธูุฉ ุงูุฐููุฉ.`;
  }

  // ุดู ุจุชูุฏุฑ ุชุนูู
  if (textNorm.match(/(ุดู ุจุชูุฏุฑ ุชุนูู|ุงูุด ุจุชูุฏุฑ ุชุนูู|ุดู ุชูุฏุฑ ุชุณูู|ูุด ุชูุฏุฑ ุชุณูู|ุดู ูุธููุชู|ุงูุด ูุธููุชู|ุดู ููุงูู)/)) {
    return `ุจูุฏุฑ ุณุงุนุฏู ูุง ${uName} ูู:\n\nโ ุฅุฏุงุฑุฉ ุงููุฎุฒูู\nโ ุงูุจุญุซ ุนู ุงูููุชุฌุงุช\nโ ุนุฑุถ ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช\nโ ุชูุจููุงุช ุงูููุงูุต\nโ ุงูุชุตุฏูุฑ ูู Excel ู PDF\nโ ุงูุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุชู`;
  }

  // ุณุงุนุฏูู / ุดู ุงูุฎุฏูุงุช
  if (textNorm.match(/(ุณุงุนุฏูู|ุณุงุนุฏูู ูู ูุถูู|ุจุฏู ูุณุงุนุฏู|ุดู ุงูุฎุฏูุงุช|ุงูุด ุงูุฎุฏูุงุช|ุดู ุชูุฏู|ุงูุด ุชูุฏู)/)) {
    return `ุฃููุฏ ูุง ${uName}! ุจูุฏุฑ ุณุงุนุฏู ูู:\n\n๐ฆ **ุฅุฏุงุฑุฉ ุงููุฎุฒูู**: ุฅุถุงูุฉุ ุชุนุฏููุ ุญุฐู ุงูููุชุฌุงุช\n๐ **ุงูุจุญุซ**: ุงุจุญุซ ุนู ุฃู ููุฏูู ุฃู ููุน\n๐ **ุงูุชูุงุฑูุฑ**: ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุจููุงุช\n๐ฅ **ุงูุชุตุฏูุฑ**: ุญูุธ ุงูุจูุงูุงุช ูู Excel ุฃู PDF\n\nุฌุฑุจ ุชุณุฃููู ุนู ุฃู ููุฏูู!`;
  }

  // ุดูุฑุงู
  if (textNorm.match(/(ุดูุฑุง|ุดูุฑุง ูู|ูุนุทูู ุงูุนุงููู|ูุนุทูู ุงูู ุนุงููู|ูุดููุฑ|ููุชุงุฒ|ุฑุงุฆุน|ุชูุงู)/)) {
    const responses = [
      `ุงูุนูู ูุง ${uName}! ๐`,
      `ุงููู ูุนุงููู ูุง ${uName}!`,
      `ุฏุงููุงู ูู ุงูุฎุฏูุฉ ูุง ${uName}! ๐`,
      `ุชุญุช ุฃูุฑู ูุง ${uName}!`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  // ุตุจุงุญ ุงูุฎูุฑ
  if (textNorm.match(/(ุตุจุงุญ ุงูุฎูุฑ|ุตุจุงุญู|ุตุจุงุญ ุงูููุฑ|ุตุจุญู ุงููู ุจุงูุฎูุฑ|ุตุจุญ ุงูุฎูุฑ)/)) {
    const responses = [
      `ุตุจุงุญ ุงูููุฑ ูุง ${uName}! โ๏ธ ููู ุจูุฏุฑ ุณุงุนุฏู ุงููููุ`,
      `ุตุจุงุญ ุงููุฑุฏ ูุง ${uName}! ๐น ููู ุณุนูุฏ ุนููู`,
      `ุตุจุงุญ ุงูุฎูุฑ ูุงูุณุฑูุฑ ูุง ${uName}! ๐ ุดู ุจุฏู ุงููููุ`,
      `ุตุจุญู ุงููู ุจุงูุฎูุฑ ูุง ${uName}! ๐ ุชุญุช ุฃูุฑู`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  // ูุณุงุก ุงูุฎูุฑ
  if (textNorm.match(/(ูุณุงุก ุงูุฎูุฑ|ูุณุงู ุงููู ุจุงูุฎูุฑ|ูุณุงุก ุงูููุฑ|ูุณุงุฆู|ูุณุงูู)/)) {
    const responses = [
      `ูุณุงุก ุงูููุฑ ูุง ${uName}! ๐ ููู ุจูุฏุฑ ุฎุฏููุ`,
      `ูุณุงุก ุงููุฑุฏ ูุง ${uName}! ๐บ ุดู ุจุฏู ุณุงุนุฏู ูููุ`,
      `ูุณุงุก ุงูุฎูุฑ ูุงูุณุฑูุฑ ูุง ${uName}! โจ`,
      `ูุณุงู ุงููู ุจุงูุฎูุฑ ูุง ${uName}! ๐ ุชุญุช ุฃูุฑู`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  // ============ ุฃุณุฆูุฉ ุนู ุดุฑูุฉ ูุงู ููุจูููุง ============

  // ูุจุฐุฉ ูุฎุชุตุฑุฉ ุนู ุงูุดุฑูุฉ (ุงูุฃููููุฉ ููุณุคุงู ุงููุฎุชุตุฑ)
  if (textNorm.match(/(ุดู ุจุชุนุฑู|ุงูุด ุจุชุนุฑู|ุงุญูููู|ุงุญูู ูู|ููู ูู|ุฎุจุฑูู).*?(ูุงู ููุจูููุง|ูุงู|ุงูุดุฑูุฉ|wow)/)) {
    return `๐๏ธ **ูุงู ููุจูููุง - ูุจุฐุฉ ูุฎุชุตุฑุฉ:**\n\n๐ **ุงูุชุฃุณูุณ:** 1983 ูู ุญูุจุ ุณูุฑูุง ๐ธ๐พ\n๐น๐ท **ุงููููุน ุงูุญุงูู:** ุจูุฑุตุงุ ุชุฑููุง (ููุทูุฉ ุฅูููุบูู) ููุฐ 2019\n\nโญ **ุงูุชุฎุตุต:**\nุตูุงุนุฉ ุงูุฃุซุงุซ ุงูุนุตุฑู ุงููุงุฎุฑ:\nโข ุทุงููุงุช ุงููููุฉ โ\nโข ุทุงููุงุช ุงูุชููุฒููู ๐บ\nโข ุงูุทุงููุงุช ุงููุณุทูุฉ ๐ช\nโข ุฃุซุงุซ ุงููุฏุงุฎู ๐ช\n\nโจ **ุงููููุฒุงุช:**\nโ ุฃุฌูุฏ ุงูููุงุฏ ูุงูุฎุงูุงุช\nโ ุชุตุงููู ุนุตุฑูุฉ ูุฃูููุฉ\nโ ุฌูุฏุฉ ุนุงููุฉ ููุชุงูุฉ\nโ ุงูุชูุงู ุจุฃุฏู ุงูุชูุงุตูู\n\n๐ ูุงู ููุจูููุง - ุฑูุฒ ุงูุฌูุฏุฉ ูุงูุฅุจุฏุงุน ููุฐ 40 ุนุงูุงู!`;
  }

  // ูุชู ุชุฃุณุณุช ุงูุดุฑูุฉ
  if (textNorm.match(/(ูุชู ุชุงุณุณุช|ูุชู ุชุฃุณุณุช|ุชุงุฑูุฎ ุงูุชุงุณูุณ|ุชุงุฑูุฎ ุงูุชุฃุณูุณ|ุณูุฉ ุงูุชุงุณูุณ|ุณูุฉ ุงูุชุฃุณูุณ|ููู ุชุงุณุณุช|ููู ุชุฃุณุณุช|ูู ููู ุงูุดุฑูุฉ|ุงุตู ุงูุดุฑูุฉ).*?(ูุงู|ุงูุดุฑูุฉ)/)) {
    return `๐ข **ุชุงุฑูุฎ ุดุฑูุฉ ูุงู ููุจูููุง:**\n\nุชุฃุณุณุช ุดุฑูุฉ ูุงู ููุจูููุง ููุตูุงุนุงุช ูู ุนุงู **1983** ูู ูุฏููุฉ **ุญูุจุ ุณูุฑูุง** ๐ธ๐พ\n\nุนูู ูุฑ ุงูุณูููุ ุฃุตุจุญุช ุงูุดุฑูุฉ ุฑูุฒุงู ููุฌูุฏุฉ ูุงูุฅุจุฏุงุน ูู ุตูุงุนุฉ ุงูุฃุซุงุซ! โจ`;
  }

  // ุงูุงูุชูุงู ูุชุฑููุง
  if (textNorm.match(/(ูุชู ุงูุชููุช|ููุด ุงูุชููุช|ููู ุงูุดุฑูุฉ ุงูุงู|ููู ููุฑ ุงูุดุฑูุฉ|ุงูุดุฑูุฉ ุจุชุฑููุง|ุงูุชูุงู ุงูุดุฑูุฉ|ูููุน ุงูุดุฑูุฉ|ุนููุงู ุงูุดุฑูุฉ).*?(ุชุฑููุง|ุจูุฑุตุง|ุงููุบูู|inegol)/)) {
    return `๐น๐ท **ุงูุชูุงู ุดุฑูุฉ ูุงู ููุจูููุง:**\n\nูุน ุงูุฏูุงุน ุงูุญุฑุจ ูู ุณูุฑูุงุ ุงูุชููุช ุงูุดุฑูุฉ ูู ุนุงู **2019** ุฅูู **ุจูุฑุตุงุ ุชุฑููุง**ุ ูุชุญุฏูุฏุงู ุฅูู ููุทูุฉ **ุฅูููุบูู (ฤฐnegรถl)** ุงููุดููุฑุฉ ุจุตูุงุนุฉ ุงูุฃุซุงุซ.\n\nูููุฐ ุงูุชูุงููุงุ ูุงุตูุช ูุงู ููุจูููุง ุชูุฏูู ููุชุฌุงุชูุง ุงููุงุฎุฑุฉ ุงูุชู ุชุฌูุน ุจูู ุงูุฃูุงูุฉ ูุงููุธุงุฆู ุงูุนูููุฉ! ๐๏ธโจ`;
  }

  // ููุชุฌุงุช ุงูุดุฑูุฉ
  if (textNorm.match(/(ุดู ุจุชุตูุน|ุงูุด ุจุชุตูุน|ุดู ุงูููุชุฌุงุช|ุงูุด ุงูููุชุฌุงุช|ุดู ุจุชูุฏู|ููุชุฌุงุช ุงูุดุฑูุฉ|ุงููุงุน ุงูุงุซุงุซ|ุดู ุนูุฏูู|ุงูุด ุนูุฏูู).*?(ูุงู|ุงูุดุฑูุฉ)/)) {
    return `๐๏ธ **ููุชุฌุงุช ูุงู ููุจูููุง:**\n\nุชุชุฎุตุต ุดุฑูุฉ ูุงู ููุจูููุง ูู ุชูุฏูู ุฃุฑูุน ูุทุน ุงูุฃุซุงุซ ุงูุชู ุชุฌูุน ุจูู ุงููู ูุงููุธุงุฆู ุงูุนูููุฉ:\n\nโ **ุทุงููุงุช ุงููููุฉ (Coffee Tables)**\n๐บ **ุทุงููุงุช ุงูุชููุฒููู (TV Tables)**\n๐ช **ุทุงููุงุช ูุณุทูุฉ (Mid Tables)**\n๐ช **ุฃุซุงุซ ุงููุฏุงุฎู (Entryway Furniture)**\n\nุฌููุน ุงููุทุน ูุตููุฉ ุจุฃุณููุจ ุนุตุฑู ููุงุฎุฑ ูุฅุถุงูุฉ ููุณุฉ ูุฑูุฏุฉ ูููุฒูู! โจ`;
  }

  // ุงูุฌูุฏุฉ ูุงูุชุตููุน
  if (textNorm.match(/(ุฌูุฏุฉ ุงูููุชุฌุงุช|ููู ุงูุชุตููุน|ููุงุฏ ุงูุชุตููุน|ุฎุงูุงุช ุงูุงุซุงุซ|ุฌูุฏุฉ ุงูุงุซุงุซ|ูููุฒุงุช ุงูููุชุฌุงุช|ููุด ูุงู|ููุด ุงุฎุชุงุฑ ูุงู)/)) {
    return `โญ **ุฌูุฏุฉ ูุงู ููุจูููุง:**\n\nูู ูุทุนุฉ ูู ุฃุซุงุซ ูุงู ูุชู ุชุตููุนูุง ุจุนูุงูุฉ ูุงุฆูุฉ ูู ุฃุฌูุฏ ุงูููุงุฏุ ููุง ูุนูุณ ุงูุชูุงูู ูุงูุฅุชูุงู ูู ูู ุงูุชูุงุตูู.\n\nโ ููุงุฏ ูุงุฎุฑุฉ ุนุงููุฉ ุงูุฌูุฏุฉ\nโ ุชุตุงููู ุนุตุฑูุฉ ูุฃูููุฉ\nโ ุงูุชูุงู ุจุฃุฏู ุงูุชูุงุตูู\nโ ูุชุงูุฉ ูุทูู ุนูุฑ\nโ ุชููุน ููุงุณุจ ุฌููุน ุงูุฃุฐูุงู\n\nุจูุถู ุงูุชูุงูู ูุงูุงูุชูุงู ุจุงูุชูุงุตููุ ุชูููุช ุงูุดุฑูุฉ ูู ุงูุญูุงุธ ุนูู ุณูุนุชูุง ุงููุฑูููุฉ! ๐`;
  }

  // ุฑุคูุฉ ุงูุดุฑูุฉ / ุงูููุณูุฉ
  if (textNorm.match(/(ุฑุคูุฉ ุงูุดุฑูุฉ|ููุณูุฉ ุงูุดุฑูุฉ|ูุฏู ุงูุดุฑูุฉ|ุฑุณุงูุฉ ุงูุดุฑูุฉ|ููุด ูุงู ูููุฒุฉ|ุดู ูููุฒ ูุงู)/)) {
    return `๐ **ููุณูุฉ ูุงู ููุจูููุง:**\n\nูู ูุงู ููุจูููุงุ ูุคูู ุจุฃู ุงูุฃุซุงุซ ุงูุฌูุฏ ููููู ุชุญููู ุฃู ูุณุงุญุฉ ุฅูู ููุงู ูุฑูุญ ูุฃููู.\n\nูุฐูู ูุญู ููุชุฒููู ุจุชูุฏูู ุงูุฃูุถู ูุนููุงุฆูุง! ๐\n\n๐ **ุงุฎุชุฑ ูุงู ููุจูููุง ูุงุฌุนู ููุฒูู ููุงูุงู ูุนูุณ ุดุฎุตูุชู ูุฃุณููุจ ุญูุงุชู ุจุฃุฏู ุงูุชูุงุตูู.**\n\nููุฏู ูู ุชุดูููุฉ ูุงุณุนุฉ ูู ุงูุฃุซุงุซ ุชูุจู ุฌููุน ุงูุฃุฐูุงู ูุงูุงุญุชูุงุฌุงุชุ ููุง ูุฌุนู ูุงู ููุจูููุง ุงูุฎูุงุฑ ุงููุซุงูู ูุฎูู ุฃุฌูุงุก ูู ุงููุฎุงูุฉ ูุงูุฑุงุญุฉ ูู ูู ุฑูู ูู ููุฒูู! โจ`;
  }

  // ูุนูููุงุช ุนุงูุฉ ุนู ุงูุดุฑูุฉ
  if (textNorm.match(/(ุนุฑููู ุนู|ุนุฑููู ุนูู|ูุนูููุงุช ุนู|ุฎุจุฑูู ุนู).*?(ูุงู ููุจูููุง|ุดุฑูุฉ ูุงู|wow furniture)/)) {
    return `๐ข **ูุจุฐุฉ ุนู ุดุฑูุฉ ูุงู ููุจูููุง:**\n\n๐ ุชุฃุณุณุช ุนุงู **1983** ูู ุญูุจุ ุณูุฑูุง\n๐น๐ท ุงูุชููุช ุนุงู **2019** ุฅูู ุจูุฑุตุงุ ุชุฑููุง (ููุทูุฉ ุฅูููุบูู)\nโญ ุฑูุฒ ููุฌูุฏุฉ ูุงูุฅุจุฏุงุน ูู ุตูุงุนุฉ ุงูุฃุซุงุซ\n๐๏ธ ูุชุฎุตุตุฉ ูู ุงูุฃุซุงุซ ุงูุนุตุฑู ุงููุงุฎุฑ\n\n**ููุชุฌุงุชูุง:**\nโ ุทุงููุงุช ุงููููุฉ\n๐บ ุทุงููุงุช ุงูุชููุฒููู\n๐ช ุงูุทุงููุงุช ุงููุณุทูุฉ\n๐ช ุฃุซุงุซ ุงููุฏุงุฎู\n\nโจ ูู ูุทุนุฉ ูุตููุนุฉ ุจุนูุงูุฉ ูุงุฆูุฉ ูู ุฃุฌูุฏ ุงูููุงุฏ!\n\nูุงู ููุจูููุง - ุญูุซ ููุชูู ุงููู ุจุงููุธููุฉ ุงูุนูููุฉ! ๐จ๐`;
  }

  // ุงูุณูู ุงูุชุฑูู ูุงูุชูุณุน
  if (textNorm.match(/(ุงูุณูู ุงูุชุฑูู|ุงูุชูุณุน|ุงูุงูุชุดุงุฑ|ุงููุฌุงุญ|ุงูุณูุนุฉ|ุงูุดูุฑุฉ).*?(ูุงู|ุงูุดุฑูุฉ)/)) {
    return `๐ **ูุฌุงุญ ูุงู ููุจูููุง:**\n\nุจูุถู ุงูุชูุงูู ูุงูุงูุชูุงู ุจุงูุชูุงุตููุ ุชูููุช ุดุฑูุฉ ูุงู ููุจูููุง ูู:\n\nโ ุงูุญูุงุธ ุนูู ุณูุนุชูุง ุงููุฑูููุฉ\nโ ุงูุชูุณุน ูู ุงูุณูู ุงูุชุฑูู\nโ ุฃู ุชุตุจุญ ุงูุฎูุงุฑ ุงูููุถู ูููุซูุฑูู ูู ุชุฑููุง ูุฎุงุฑุฌูุง\nโ ุชูุฏูู ููุชุฌุงุช ูุงุฎุฑุฉ ุชุฌูุน ุจูู ุงูุฃูุงูุฉ ูุงููุธุงุฆู ุงูุนูููุฉ\n\nูุงู ููุจูููุง - ุงูุฌูุฏุฉ ุงูุชู ุชุซู ุจูุง! ๐โจ`;
  }

  // ุนุทููู ุบูุฑู / ูุญุฏุฉ ุชุงููุฉ (ูุชุบููุฑ ุงูููุชุฉ)
  if (textNorm.match(/(ุนุทููู ุบูุฑู|ุนุทูู ุบูุฑู|ูุญุฏู ุชุงููู|ูุญุฏุฉ ุซุงููุฉ|ุบูุฑ ูุงู|ุบูุฑ ุงูููุชู|ููุชู ุชุงููู|ููุชุฉ ุซุงููุฉ|ููุงู ูุญุฏู|ุจุฏู ุบูุฑูุง)/)) {
    const jokes = [
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุฑุงุญ ูุฏูุชูุฑ ุงูุฃุณูุงูุ ุงูุฏูุชูุฑ ูุงูู: "ุงูุชุญ ุชูู!"\nูุงู: "ุชูุ ุฃูุง ุฌุงู ุฃูุชุญ ููู!" ๐ฆท๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุนูู ุณุฃู ุทุงูุจ: "ุฅุฐุง ุนูุฏู 10 ุชูุงุญุงุช ูุฃุฎุฐุช ููู 6ุ ุดู ุจูุถู ูุนูุ"\nูุงู: "ูุดููุฉ ูุน ุงููู ุฃุฎุฐูู!" ๐๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุฏุฎู ุนูู ุตูุฏููุฉุ ูุงู: "ุจุฏู ุฏูุง ููุฐุงูุฑุฉ!"\nุงูุตูุฏูู ูุงูู: "ุชูุถู!"\nูุงู: "ุฏูุง ูุดูุ" ๐ค๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nุฒูุฌุฉ ุณุฃูุช ุฒูุฌูุง: "ุญุจูุจูุ ุฃูุง ุณูููุฉุ"\nูุงู: "ูุง ุญุจูุจุชูุ ุฃูุชู... ูุงุณุนุฉ ุงูุฃูู!" ๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุฑุงุญ ูุดุชุฑู ุจุจุบุงุกุ ูุงูู ุงูุจุงุฆุน: "ูุฐุง ุงูุจุจุบุงุก ุจูุญูู 5 ูุบุงุช!"\nูุงู: "ุทูุจุ ููุด ุฃูุช ุจุชุญูู ุนููุ ุฎููู ูู ูุญูููู!" ๐ฆ๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nุทุงูุจ ุฑุณุจ ุจุงูุงูุชุญุงูุ ุฃุจูู ูุงูู: "ุฃูุง ููุง ููุช ุจุนูุฑู ููุช ุงูุฃูู!"\nูุงูู: "ุทูุจ ููุด ูุง ุถููุชุ" ๐๐คฃ`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุฏุฎู ูุทุนู ูุงุฎุฑุ ูุงูู ุงููุงุฏู: "ุนูุฏูุง ุฃูู ูุฑูุณู ูุฅูุทุงูู ููุงุจุงูู!"\nูุงู: "ุนูุฏูู ุนุฑุจูุ ุฃูุง ูุง ุจููู ูุบุงุช!" ๐ฝ๏ธ๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุฏูุฑ ูุงู ูููุธู: "ุฃูุช ุฏุงููุงู ูุชุฃุฎุฑุ ุดู ุงูุณุจุจุ"\nูุงู: "ูู ูุงูุชุฉ ุจุงูุทุฑูู ููุชูุจ ุนูููุง: ุงุฐูุจ ุจุจุทุก!" ๐๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุฑุงุญ ูุชูุฏู ููุธููุฉุ ุณุฃููู: "ุดู ููุงุท ุถุนููุ"\nูุงู: "ุงูุตุฏู!"\nูุงูููู: "ุงูุตุฏู ูู ููุทุฉ ุถุนู!"\nูุงู: "ูุฃูุง ูุง ููููู ุฑุฃูู!" ๐`,
      `๐ **ููุชุฉ ุฌุฏูุฏุฉ:**\n\nูุงุญุฏ ุงุดุชุฑู ุณูุงุฑุฉ ูุณุชุนููุฉุ ุตุงุญุจู ูุงูู: "ููู ุงูุณูุงุฑุฉุ"\nูุงู: "ููุชุงุฒุฉ! ุจุณ ููุง ุจูุชุญ ุงูุฑุงุฏููุ ุงูุฅุดุงุฑุฉ ุจุชูุทูู!" ๐ป๐๐`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  // ุงูููุช - ุชุงุฌุฑ ููุจูููุง
  if (textNorm.match(/(ููุชู|ููุชุฉ|ุงุญูู ููุชู|ุงุญูููู ููุชู|ุงุถุญููู|ุจุฏู ููุชู).*?(ููุจูููุง|ุชุงุฌุฑ ููุจูููุง|ุงุซุงุซ|ุชุงุฌุฑ ุงุซุงุซ|ูุฑูุชุดุฑ)/)) {
    const jokes = [
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุชุงุฌุฑ ููุจูููุง ูุงู ูุฒุจูู: "ูุฐุง ุงูููุจ ูุฑูุญ ุฌุฏุงูุ ุชูุฏุฑ ุชูุงู ุนููู!"\nุงูุฒุจูู ูุงู: "ุทูุจุ ูููู ุฃุฌุฑุจูุ"\nุงูุชุงุฌุฑ: "ุฃููุฏ!"\nุงูุฒุจูู ูุงู ูุตุญู ุจุนุฏ 3 ุณุงุนุงุชุ ุงูุชุงุฌุฑ ูุงูู: "ุงุณุชุฑูุญุชุ"\nูุงู: "ุขูุ ุจุณ ุฃูุง ุจุฏู ุฃุดุชุฑู ุณุฑูุฑ ูู ููุจ!" ๐๏ธ๐ด`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุฒุจูู ุฏุฎู ูุญู ููุจูููุงุ ูุงู: "ุจุฏู ุทุงููุฉ ูุง ุชููุณุฑ!"\nุงูุชุงุฌุฑ ูุงูู: "ุนูุฏู ุทุงููุฉ ุญุฏูุฏ!"\nุงูุฒุจูู: "ุจุณ ุฃูุง ุจุฏู ุฃูู ุนูููุง ูู ุฃุฑูุน ุฃุซูุงู!" ๐ช๐ฝ๏ธ๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุชุงุฌุฑ ููุจูููุง ูุงู ูุฒุจูู: "ูุฐุง ุงููุฑุณู ูู ุฎุดุจ ุงููุงููุฌูู ุงูุฃุตูู!"\nุงูุฒุจูู: "ููู ุณุนุฑูุ"\nุงูุชุงุฌุฑ: "5000 ุฏููุงุฑ!"\nุงูุฒุจูู: "ุทูุจุ ุงููุงููุฌูู ุงููููุฏ ุจููุ" ๐ช๐ฐ๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุฒุจูู ุงุดุชุฑู ุฎุฒุงูุฉุ ูุงู ููุชุงุฌุฑ: "ูุชู ุจุชูุตูููุงุ"\nุงูุชุงุฌุฑ: "ุจุนุฏ ุฃุณุจูุน!"\nุงูุฒุจูู: "ุฃุณุจูุนุ! ุฃูุง ุจุฏู ุฃููู ุจูุชู ุจูุฑุฉ!"\nุงูุชุงุฌุฑ: "ุทูุจ ุฎุฐ ุงูุฎุฒุงูุฉ ูุนูุ ูุงููุญุชููุงุช ุจููุตููุง ุจุนุฏ ุฃุณุจูุน!" ๐๐ฆ๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุชุงุฌุฑ ููุจูููุง ูุชุจ ุนูู ุงููุงูุชุฉ: "ูุจูุน ุงูุฃุญูุงู!"\nุฒุจูู ุฏุฎู ููุงู: "ุจุฏู ุญูู ูููุง ูุจูุฑุฉ!"\nุงูุชุงุฌุฑ: "ุขุณูุ ุนูุฏูุง ุจุณ ุฃุญูุงู ุดูู ุตุบูุฑุฉ!" ๐๐ญ๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุฒุจูู ูุงู ูุชุงุฌุฑ: "ูุฐุง ุงูุณุฑูุฑ ูุฑูุญุ"\nุงูุชุงุฌุฑ: "ูุฑูุญ ุฌุฏุงู! ุฃูุง ููุณู ููุช ุนููู!"\nุงูุฒุจูู: "ูุชูุ"\nุงูุชุงุฌุฑ: "ูู ููู ุจุนุฏ ุงูุบุฏุง!" ๐๏ธ๐ด๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุชุงุฌุฑ ููุจูููุง ุนูุฏู ุนุฑุถ: "ุงุดุชุฑู 3 ูุฑุงุณู ูุงุญุตู ุนูู ุงูุฑุงุจุน ูุฌุงูุงู!"\nุฒุจูู ูุงู: "ุทูุจุ ุนุทูู ุงูุฑุงุจุน ุจุณ!" ๐ช๐ช๐ช๐๐`,
      `๐ **ููุชุฉ ุชุงุฌุฑ ุงูููุจูููุง:**\n\nุฒุจูู ุงุดุชุฑู ุทุงููุฉุ ุจุนุฏ ููููู ุฑุฌุนูุงุ ุงูุชุงุฌุฑ ูุงูู: "ููุดุ"\nูุงู: "ูุตูุฑุฉ!"\nุงูุชุงุฌุฑ: "ุทูุจ ูุทูููุง!"\nุงูุฒุจูู: "ูุงุ ุทูููุง ุฑุฌููู ุฃุญุณู!" ๐ฆต๐๐`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  // ุงูููุช - ุชุงุฌุฑ ุจุฎูู
  if (textNorm.match(/(ููุชู|ููุชุฉ|ุงุญูู ููุชู|ุงุญูููู ููุชู|ุงุถุญููู|ุจุฏู ููุชู).*?(ุจุฎูู|ุชุงุฌุฑ ุจุฎูู)/)) {
    const jokes = [
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงูุจุฎูู:**\n\nุชุงุฌุฑ ุจุฎูู ุฑุงุญ ูุดุชุฑู ููุจุงููุ ูุงูููู: "ูู ุนุฑุถ ุฎุงุตุ ุงุดุชุฑู ูุงุญุฏ ูุงุญุตู ุนูู ุงูุชุงูู ูุฌุงูุงู!"\nูุงู: "ุทูุจ ุนุทููู ุงููุฌุงูู ุจุณ!" ๐คฃ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงูุจุฎูู:**\n\nุชุงุฌุฑ ุจุฎูู ุฏุฎู ูุทุนู ูุทูุจ ูุฌุจุฉุ ุงููุงุฏู ูุงูู: "ุงูุจูุดูุดุ"\nูุงู: "ุงูุจูุดูุดุ! ุฃูุง ุฌุงู ุขูู ูู ุฃุชุจุฑุน!" ๐ธ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงูุจุฎูู:**\n\nุชุงุฌุฑ ุจุฎูู ุตุงุฑ ุนูุฏู ุชูุฃูุ ุณูุงูู: Ctrl+C ู Ctrl+V\nุนุดุงู ูุง ูุฏูุน ูุตุงุฑู ุงุณู ุชุงูู! ๐ถ๐ถ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงูุจุฎูู:**\n\nุชุงุฌุฑ ุจุฎูู ุฑุงุญ ูุชุฒูุฌุ ูุงูููู: "ุดู ุจุฏู ุชูุฏู ุงูุนุฑูุณุ"\nูุงู: "ุจุฏู ูุฏููุง ููุจู!"\nูุงูููู: "ุฑููุงูุณู!"\nูุงู: "ูุงุ ูุฌุงูู!" ๐๐`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  // ุงูููุช - ุชุงุฌุฑ ูุฑูู
  if (textNorm.match(/(ููุชู|ููุชุฉ|ุงุญูู ููุชู|ุงุญูููู ููุชู|ุงุถุญููู|ุจุฏู ููุชู).*?(ูุฑูู|ุชุงุฌุฑ ูุฑูู|ุณุฎู)/)) {
    const jokes = [
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงููุฑูู:**\n\nุชุงุฌุฑ ูุฑูู ูุชุญ ูุญูุ ูุชุจ ุนูู ุงููุงูุชุฉ: "ูู ุดู ุจุจูุงุด!"\nุงููุงุณ ุงุฌุช ุชุณุฃูุ ูุงู: "ุขู ุจุจูุงุด... ุจุณ ูุงุฒู ุชุฏูุนูุง!" ๐คฃ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงููุฑูู:**\n\nุชุงุฌุฑ ูุฑูู ุนุฒู ุฃุตุญุงุจู ุนูู ุงูุนุดุงุ ูุงููู: "ุงุทูุจูุง ุงููู ุจุฏูู!"\nููุง ุฌุช ุงููุงุชูุฑุฉ ูุงู: "ููุง ูู ูุงุญุฏ ูุฏูุน ูุตูุจู!" ๐๐ณ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงููุฑูู:**\n\nุชุงุฌุฑ ูุฑูู ุฑุงุญ ูุชุจุฑุน ุจูููุณุ ุณุฃููู: "ูู ุจุฏู ุชุชุจุฑุนุ"\nูุงู: "ููููู!"\nูุงูููู: "ูุงุดุงุก ุงููู!"\nูุงู: "ููููู ููุฑุฉ ุจุณุ ุงููููุณ ูุง ูุนู!" ๐ค๐ญ`,
      `๐ **ููุชุฉ ุงูุชุงุฌุฑ ุงููุฑูู:**\n\nุชุงุฌุฑ ูุฑูู ูุงู ูููุธูู: "ุฃูุช ููุธู ููุชุงุฒุ ุจุฏู ุนุทูู ุนูุงูุฉ!"\nุงูููุธู ูุฑุญุงูุ ูุงูู: "ููุ"\nูุงู: "ุนูุงูุฉ ุนูู ุดุบูู ุงูุฃุตูู!" ๐๐`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  // ุงูููุช - ุนุงูุฉ
  if (textNorm.match(/(ููุชู|ููุชุฉ|ุงุญูู ููุชู|ุงุญูููู ููุชู|ุงุถุญููู|ุจุฏู ููุชู|ูุงุช ููุชู)/)) {
    const jokes = [
      `๐ **ููุชุฉ ุงูููู:**\n\nูุงุญุฏ ุฏุฎู ุนูู ุงููุณุชูุฏุนุ ูุงูู ุตุงุญุจู: "ุดู ุจุฏูุ"\nูุงู: "ุจุฏู ููุฏูู ูุง ุญุฏุง ุจูุนุฑูู!"\nูุงูู: "ุฅุฐุง ูุง ุญุฏุง ุจูุนุฑููุ ููู ุฃูุง ุจุฏู ุนุฑููุ!" ๐คทโโ๏ธ`,
      `๐ **ููุชุฉ ุงูููู:**\n\nูุจุฑูุฌ ุณุฃู ุฒูููู: "ููู ุชูุฑู ุจูู ุงููุจุฑูุฌ ุงููุจุชุฏุฆ ูุงููุญุชุฑูุ"\nูุงูู: "ุงููุจุชุฏุฆ ููุชุจ 100 ุณุทุฑ ูุญู ูุดููุฉุ ุงููุญุชุฑู ููุณุญ 100 ุณุทุฑ!" ๐ปโจ`,
      `๐ **ููุชุฉ ุงูููู:**\n\nูุงุญุฏ ุฑุงุญ ูุดุชุฑู ููุจุงููุ ูุงูู ุงูุจุงุฆุน: "ูุฐุง ุงูููุจุงูู ุถุฏ ุงููุงุก!"\nูุงู: "ุทูุจุ ูุถุฏ ุงููููุณุ" ๐ฑ๐ธ`,
      `๐ **ููุชุฉ ุงูููู:**\n\nูุฏูุฑ ุณุฃู ููุธูู: "ููุด ูุชุฃุฎุฑุ"\nูุงู: "ูู 10 ูุงุณ ูุฏุงูู ุจุงูุทุงุจูุฑ!"\nูุงู: "ูููุ"\nูุงู: "ุจุงูููุงู!" ๐ด๐ค`,
      `๐ **ููุชุฉ ุงูููู:**\n\nูุงุญุฏ ุฏุฎู ุนูู ูุญู ููุจููุชุฑุ ูุงู: "ุจุฏู RAM!"\nูุงูู ุงูุจุงุฆุน: "ูู ุฌูุฌุงุ"\nูุงู: "ูุง ุจุฏู ุฎุฑูู ูุงูู!" ๐๐`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  return null;
}


    async function processInput(forcedText = null) {
      const input = document.getElementById('chat-input');
      const rawText = forcedText || input.value.trim();
      if (!rawText) return;

      const text = fixSpokenModels(rawText);

      addMsg('user', text);
      input.value = '';

      const textNorm = normalizeArabic(text);
      const allItems = await getAll();
      const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";

      let response = "";
      let data = [];

      // โ ูุญุต ุงูุฃุณุฆูุฉ ุงูุฎุงุตุฉ ุฃููุงู
      const specialResponse = handleSpecialQuestions(textNorm, uName);
      if (specialResponse) {
        speak(specialResponse);
        addMsg('ai', specialResponse, []);
        return;
      }

      const dtIntent = parseDateTimeIntent(textNorm);
      if (dtIntent.isAsking) {
        response = buildDateTimeReply(uName, dtIntent) || `ุฃููุฏ ูุง ${uName}ุ ุดู ุจุชุญุจ ุชุญุฏูุฏุงู: ุงูููุช ููุง ุงูุชุงุฑูุฎ ููุง ุงููููุ`;
        speak(response);
        addMsg('ai', response, []);
        return;
      }

      if (textNorm.match(/^(ูุฑุญุจุง|ููุง|ุณูุงู|ูุงู|ุงูููู|ูุง ููุง|ููู|ุงููุง ูุณููุง|ูุฑุญุจุชูู|ุงููุง ุจูู)/)) {
        const greetings = [
          `ุฃููุงู ูุณููุงู ููู ูุง ${uName}! ููู ุจูุฏุฑ ุฎุฏูู ุงููููุ`,
          `ูุง ูุฑุญุจุง ููู ูุง ${uName}! ุดู ุจุฏู ุณุงุนุฏู ูููุ`
        ];
        response = greetings[Math.floor(Math.random() * greetings.length)];
      } else if (textNorm.match(/(ูุฏุงุนุง|ุจุงู|ูุน ุงูุณูุงูุฉ|ุงููู ูุนู|ูุดููู|ููุง ุจุงู|ุจุฑูุญ|ุฎูุตุช)/)) {
        response = `ูุน ุงูุณูุงูุฉ ูุง ${uName}!`;
      } else {
        const wantsAll = ["ุงููู","ุฌุฑุฏ","ุงุนุฑุถ ุงููุฎุฒูู","ุนุฑุถ ุงููุฎุฒูู","ูุฑููู"].some(k => textNorm.includes(normalizeArabic(k)));
        const wantsLow = ["ูุงูุต","ููุงูุต","ุชูุจูู","ูููู"].some(k => textNorm.includes(normalizeArabic(k)));
        const asksCount = ["ูู","ุนุฏุฏ","ุงูุนุฏุฏ","ูููุฉ","ูููู","ุดูุฏ","ูุฏูู"].some(k => textNorm.includes(normalizeArabic(k)));

        const modelsFound = extractModels(text);
        const typeFound = bestTypeFromText(textNorm);

        if (modelsFound.length) {
          data = allItems.filter(i => modelsFound.includes((i.model || "").toLowerCase()));
          if (data.length) {
            if (asksCount && data.length === 1) response = `ุญุณุจ ุทูุจู ูุง ${uName}ุ ุงูููุฏูู ${data[0].model.toUpperCase()} ูุชููุฑ ููู ${data[0].count} ูุทุนุฉ.`;
            else response = `ุชูุถู ูุง ${uName}ุ ูุฌุฏุช ${data.length} ูุชูุฌุฉ:`;
          } else {
            response = `ุนุฐุฑุงู ููู ูุง ${uName}ุ ูู ุฃุฌุฏ ูุฐุง ุงูููุฏูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.`;
          }
        } else if (typeFound) {
          data = allItems.filter(i => i.type === typeFound);
          if (data.length) {
            const total = data.reduce((s,x) => s + (Number(x.count) || 0), 0);
            response = asksCount ? `ุฅุฌูุงูู ุนุฏุฏ ูุทุน "${typeFound}" ูู ${total} ูุง ${uName}.` : `ุฅููู ูุงุฆูุฉ ุจููุชุฌุงุช "${typeFound}" ูุง ${uName}:`;
          } else response = `ููุฃุณู ูุง ${uName}ุ ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ููุน "${typeFound}".`;
        } else if (wantsAll) {
          data = allItems;
          response = `ุงููุณุชูุฏุน ูุญุชูู ุญุงููุงู ุนูู ${data.length} ุตููุงู ูุง ${uName}.`;
        } else if (wantsLow) {
          data = allItems.filter(i => (Number(i.count) || 0) < 5);
          response = data.length ? `ุงูุชุจู ูุง ${uName}ุ ููุฌุฏ ${data.length} ุฃุตูุงู ุฃูุดูุช ุนูู ุงูููุงุฐ.` : `ุงููุถุน ููุชุงุฒ ูุง ${uName}ุ ูุง ุชูุฌุฏ ููุงูุต.`;
        } else {
          response = `ุนุฐุฑุงู ูุง ${uName}ุ ูู ุฃููู ุทูุจู ุชูุงูุงู. ุฌุฑุจ ุชุณุฃููู ุนู ููุฏูู ูุนูู ุฃู ููุน ููุชุฌ!`;
        }
      }

      speak(response);
      addMsg('ai', response, data);
    }

    // -------------------------
    // 7) ุงูุดุงุช ูุงูุนุฑุถ
    // -------------------------
    function escapeHtml(s) {
      return String(s ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function addMsg(sender, text, data = [], opts = { save: true }) {
      const box = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

      let html = `<div class="max-w-[85%] p-3 rounded-2xl ${sender === 'user' ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
        <p class="text-sm md:text-base leading-relaxed whitespace-pre-line">${escapeHtml(text)}</p>`;

      if (data.length) {
        html += `<div class="mt-2 grid grid-cols-2 gap-2">`;
        data.forEach(i => {
          html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded border border-gray-100 dark:border-gray-500 text-center">
            <img src="${escapeHtml(i.img)}" class="w-full h-16 object-cover rounded mb-1 bg-gray-100">
            <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model || "").toUpperCase())}</div>
            <div class="text-[11px] text-gray-500 dark:text-gray-200 mb-1">${escapeHtml(String(i.type || ""))}</div>
            <div class="text-green-600 font-bold">${escapeHtml(String(i.count ?? ""))}</div>
          </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      if (opts?.save !== false) {
        const tx = db.transaction("chats", "readwrite");
        tx.objectStore("chats").add({ sender, text, data, time: new Date().toISOString() });
      }
    }

    function loadChatHistory() {
      if (!db) return;
      const tx = db.transaction("chats", "readonly");
      tx.objectStore("chats").getAll().onsuccess = (e) => {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        (e.target.result || []).forEach(msg => {
          addMsg(msg.sender, msg.text, msg.data, { save: false });
        });
      };
    }

    function clearChat() {
      const tx = db.transaction("chats", "readwrite");
      tx.objectStore("chats").clear();
      document.getElementById('chat-box').innerHTML = '';
      const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
      speak(`ุชู ูุณุญ ุงููุญุงุฏุซุฉ ุจูุงุกู ุนูู ุทูุจู ูุง ${uName}.`);
    }

    // -------------------------
    // 8) ุฏูุงู ุงููุฎุฒูู (CRUD)
    // -------------------------
    async function getAll() {
      return new Promise(r => {
        db.transaction("inventory", "readonly").objectStore("inventory").getAll().onsuccess = e => r(e.target.result || []);
      });
    }

    async function renderInventory() {
      const items = await getAll();
      const search = normalizeArabic(document.getElementById('inventory-search').value);
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';

      const filtered = items.filter(i => {
        const model = normalizeArabic(i.model);
        const type = normalizeArabic(i.type);
        return !search || model.includes(search) || type.includes(search);
      });

      filtered.forEach(i => {
        const isLow = (Number(i.count) || 0) < 5;
        grid.innerHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-3 relative border-t-4 ${isLow ? 'border-red-500' : 'border-green-500'}">
            <img src="${escapeHtml(i.img)}" class="w-full h-24 object-cover rounded bg-gray-100 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model).toUpperCase())}</h3>
                <p class="text-xs text-gray-500">${escapeHtml(String(i.type))}</p>
              </div>
              <span class="text-lg font-bold text-primary">${escapeHtml(String(i.count))}</span>
            </div>
            ${currentUser.role !== 'viewer' ? `
              <div class="mt-2 flex justify-end gap-2 border-t pt-2 dark:border-gray-700">
                <button onclick="editItem('${escapeHtml(i.model)}')" class="text-blue-500 text-sm"><i class="fas fa-edit"></i></button>
                ${currentUser.role === 'admin' ? `<button onclick="delItem('${escapeHtml(i.model)}')" class="text-red-500 text-sm"><i class="fas fa-trash"></i></button>` : ''}
              </div>
            ` : ''}
          </div>`;
      });
    }

    function openAddModal() {
      document.getElementById('m-model').value = "";
      document.getElementById('m-count').value = "";
      document.getElementById('m-img').value = "";
      document.getElementById('modal-form').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modal-form').classList.add('hidden'); }

    function saveItem() {
      const model = (document.getElementById('m-model').value || "").trim().toLowerCase();
      const type = document.getElementById('m-type').value;
      const count = parseInt(document.getElementById('m-count').value, 10);
      const imgInput = document.getElementById('m-img');

      if (!model || Number.isNaN(count)) return alert("ุงูุจูุงูุงุช ูุงูุตุฉ");

      const reader = new FileReader();
      reader.onload = e => {
        const img = imgInput.files[0] ? e.target.result : `https://placehold.co/150/png?text=${encodeURIComponent(model.toUpperCase())}`;
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").put({ model, type, count, img });
        tx.oncomplete = () => {
          closeModal();
          renderInventory();
          updateStats();
          const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
          speak(`ุชู ุงูุญูุธ ุจูุฌุงุญ ูุง ${uName}.`);
        };
      };

      if (imgInput.files[0]) reader.readAsDataURL(imgInput.files[0]);
      else reader.onload({ target: { result: null } });
    }

    function delItem(model) {
      if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ")) {
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").delete(model);
        tx.oncomplete = () => {
          renderInventory();
          updateStats();
          const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
          speak(`ุชู ุญุฐู ุงูุนูุตุฑ ูุง ${uName}.`);
        };
      }
    }

    function editItem(model) {
      db.transaction("inventory").objectStore("inventory").get(model).onsuccess = e => {
        const i = e.target.result;
        document.getElementById('m-model').value = i.model;
        document.getElementById('m-type').value = i.type;
        document.getElementById('m-count').value = i.count;
        document.getElementById('modal-form').classList.remove('hidden');
      };
    }

    // -------------------------
    // 9) ุงูุฅุญุตุงุฆูุงุช ูุงูุชุตุฏูุฑ
    // -------------------------
    async function updateStats() {
      const items = await getAll();
      const types = {};
      const low = [];

      items.forEach(i => {
        const t = i.type || "ุบูุฑ ูุตูู";
        types[t] = (types[t] || 0) + (Number(i.count) || 0);
        if ((Number(i.count) || 0) < 5) low.push(i);
      });

      const canvas = document.getElementById('typeChart');
      if (canvas) {
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: Object.keys(types),
            datasets: [{ data: Object.values(types), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#ef4444'] }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      const alerts = document.getElementById('stock-alerts');
      if (!alerts) return;
      alerts.innerHTML = low.length ? '' : '<p class="text-green-500 text-sm">ุงููุฎุฒูู ููุชุงุฒ</p>';
      low.forEach(i => {
        alerts.innerHTML += `<div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded text-sm">
          <span>${escapeHtml(i.model)}</span><b>${escapeHtml(String(i.count))}</b>
        </div>`;
      });
    }

    async function exportExcel() {
      const items = await getAll();
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Inventory");
      XLSX.writeFile(wb, "Warehouse.xlsx");
    }

    function exportChatPDF() {
      html2canvas(document.getElementById('chat-box')).then(c => {
        const pdf = new window.jspdf.jsPDF();
        const imgData = c.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("chat.pdf");
      });
    }

    function shareWhatsApp() {
      window.open("https://wa.me/?text=" + encodeURIComponent("ุชูุฑูุฑ ุงููุณุชูุฏุน ุฌุงูุฒ"), '_blank');
    }
  </script>
</body>
</html>


