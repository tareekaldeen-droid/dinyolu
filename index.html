<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ูุธุงู ุงููุณุชูุฏุน ุงูุฐูู V9 (Polite AI)</title>

  <!-- ุงูููุชุจุงุช ุงูุฎุงุฑุฌูุฉ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#2563eb', secondary: '#10b981', dark: '#1e293b' },
          height: { 'screen-dvh': '100dvh' }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    body { font-family: 'Tajawal', sans-serif; overflow: hidden; touch-action: manipulation; }

    .mic-active { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .fade-in { animation: fadeIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen-dvh w-full flex flex-col">

  <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-[90%] max-w-md text-center">
      <div class="mb-6 bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-primary">
        <i class="fas fa-user-tie text-4xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">ุงููุณุงุนุฏ ุงูุดุฎุตู V9</h2>
      <p class="text-gray-500 mb-6 text-sm">ุฃููุงู ุจู ูุง ุฃุณุชุงุฐ</p>

      <div class="space-y-4">
        <select id="user-select" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
          <option value="1">๐ค ุญุณู (ูุณุคูู - Admin)</option>
          <option value="2">๐ ูุนุชุฒ (ุนุฑุถ ููุท)</option>
          <option value="3">๐ฆ ูุญูุฏ (ูุฏูุฑ ูุณุชูุฏุน)</option>
        </select>
        <input type="password" id="password-input" placeholder="ูููุฉ ุงููุฑูุฑ (123)" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
        <button onclick="login()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">
          ุชุณุฌูู ุงูุฏุฎูู
        </button>
      </div>
      <p id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold animate-bounce">โ๏ธ ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ</p>
    </div>
  </div>

  <!-- ูุงุฌูุฉ ุงูุชุทุจูู -->
  <div id="app-interface" class="flex h-full w-full hidden relative">

    <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (PC) -->
    <aside class="hidden lg:flex w-72 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-col shadow-xl z-20">
      <div class="p-6 border-b dark:border-gray-700 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg"><i class="fas fa-robot"></i></div>
        <div>
          <h3 id="user-greeting-pc" class="font-bold text-gray-800 dark:text-white">ูุฑุญุจุงู</h3>
          <p id="user-role-pc" class="text-xs text-gray-500 dark:text-gray-400"></p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="switchTab('chat')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-comments text-blue-500 text-xl w-6"></i> ุงููุญุงุฏุซุฉ
        </button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-boxes text-green-500 text-xl w-6"></i> ุงููุฎุฒูู
        </button>
        <button onclick="switchTab('stats')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-chart-pie text-purple-500 text-xl w-6"></i> ุงูุชูุงุฑูุฑ
        </button>
      </nav>

      <div class="p-4 border-t dark:border-gray-700 space-y-2">
        <button onclick="openSettings()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>โ๏ธ ุงูุฅุนุฏุงุฏุงุช</span><i class="fas fa-sliders text-gray-500"></i>
        </button>
        <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>ุงููุถุน ุงููููู</span><i class="fas fa-moon text-yellow-500"></i>
        </button>
        <button onclick="logout()" class="w-full bg-red-100 text-red-600 hover:bg-red-200 py-3 rounded-xl font-bold transition">
          <i class="fas fa-sign-out-alt ml-2"></i> ุฎุฑูุฌ
        </button>
      </div>
    </aside>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-100 dark:bg-gray-900">

      <!-- ุฑุฃุณ ุงูุตูุญุฉ (Mobile) -->
      <header class="lg:hidden bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center z-10 h-16 shrink-0">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm"><i class="fas fa-robot"></i></div>
          <span id="user-greeting-mobile" class="font-bold text-sm">ูุฑุญุจุงู</span>
        </div>
        <div class="flex gap-3">
          <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-sliders text-gray-600 dark:text-gray-200"></i>
          </button>
          <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-moon text-yellow-500"></i>
          </button>
          <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden relative w-full">

        <!-- 1. ุงููุญุงุฏุซุฉ -->
        <section id="tab-chat" class="h-full flex flex-col w-full">
          <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 lg:pb-4"></div>

          <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3 lg:p-4 shadow-lg z-20 shrink-0">
            <div class="flex justify-center gap-4 mb-3 text-xs overflow-x-auto pb-1">
              <button onclick="clearChat()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-trash"></i> ูุณุญ
              </button>
              <button onclick="exportChatPDF()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-blue-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="shareWhatsApp()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-green-100 text-gray-600 dark:text-gray-300">
                <i class="fab fa-whatsapp"></i> ูุงุชุณุงุจ
              </button>
            </div>

            <div class="max-w-3xl mx-auto">
              <div class="flex items-center gap-2">
                <button id="mic-btn" onclick="toggleListening()"
                  class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-white flex items-center justify-center hover:bg-gray-300 transition shadow-sm active:scale-90">
                  <i class="fas fa-microphone text-xl"></i>
                </button>

                <input type="text" id="chat-input"
                  placeholder="ุชูุถู ุจุงูููุงู ูุง ุฃุณุชุงุฐ..."
                  class="flex-1 h-12 px-4 rounded-full bg-gray-100 dark:bg-gray-900 border-none focus:ring-2 focus:ring-primary outline-none transition"
                  onkeypress="handleEnter(event)" />

                <button onclick="processInput()" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center hover:bg-blue-600 transition shadow-md active:scale-90">
                  <i class="fas fa-paper-plane text-lg"></i>
                </button>
              </div>
              <div id="mic-status" class="mt-2 text-xs text-gray-500 dark:text-gray-300 text-center"></div>
            </div>
          </div>
        </section>

        <!-- 2. ุงููุฎุฒูู -->
        <section id="tab-inventory" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2">
            <h2 class="text-xl font-bold">๐ฆ ุงููุฎุฒูู</h2>
            <div class="flex gap-2">
              <button onclick="exportExcel()" class="bg-green-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-file-excel"></i></button>
              <button id="btn-add-modal" onclick="openAddModal()" class="bg-blue-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-plus"></i></button>
            </div>
          </div>
          <div class="relative mb-4">
            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            <input type="text" id="inventory-search" onkeyup="renderInventory()" placeholder="ุจุญุซ ุนู ููุฏูู ุฃู ููุน..."
              class="w-full p-3 pr-10 rounded-xl border-none shadow-sm dark:bg-gray-800" />
          </div>
          <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </section>

        <!-- 3. ุงูุฅุญุตุงุฆูุงุช -->
        <section id="tab-stats" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-xl font-bold mb-4">๐ ุชูุงุฑูุฑ</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ุชูุฒูุน ุงูุฃุตูุงู</h3>
              <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ุชูุจููุงุช ุงูููุงูุต</h3>
              <div id="stock-alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </section>

      </div>

      <!-- ุงูุชููู ุงูุณููู (Mobile) -->
      <nav class="lg:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center h-16 shrink-0 z-30 pb-safe">
        <button onclick="switchTab('chat')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-primary">
          <i class="fas fa-comments text-xl mb-1"></i><span class="text-xs font-medium">ูุญุงุฏุซุฉ</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-boxes text-xl mb-1"></i><span class="text-xs font-medium">ูุฎุฒูู</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-xs font-medium">ุฅุญุตุงุก</span>
        </button>
      </nav>

    </main>
  </div>

  <!-- ูุงูุฐุฉ ููุจุซูุฉ: ุฅุฏุงุฑุฉ ููุชุฌ -->
  <div id="modal-form" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-all scale-100">
      <h3 class="text-xl font-bold mb-4 text-center">ุฅุฏุงุฑุฉ ููุชุฌ</h3>
      <div class="space-y-3">
        <input type="text" id="m-model" placeholder="ุฑูู ุงูููุฏูู (ูุซุงู w334)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <select id="m-type" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
          <option value="ุทุงููุฉ ูุณุท">ุทุงููุฉ ูุณุท</option>
          <option value="ุทุงููุฉ ุชููุฒููู">ุทุงููุฉ ุชููุฒููู</option>
          <option value="ุฏุฑุณูุงุฑ">ุฏุฑุณูุงุฑ</option>
        </select>
        <input type="number" id="m-count" placeholder="ุงูุนุฏุฏ" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative">
          <input type="file" id="m-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
          <p class="text-xs text-gray-500">ุงุถุบุท ูุฑูุน ุตูุฑุฉ</p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl font-bold">ุฅูุบุงุก</button>
        <button onclick="saveItem()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">ุญูุธ</button>
      </div>
    </div>
  </div>

  <!-- ูุงูุฐุฉ ููุจุซูุฉ: ุงูุฅุนุฏุงุฏุงุช -->
  <div id="settings-modal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุตูุช</h3>
        <button onclick="closeSettings()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="bg-gray-50 dark:bg-gray-900/40 rounded-xl p-4">
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
          ุงูุชุญูู ูู <b>ูุจุฑุฉ ุงูุตูุช</b> (Pitch).
        </p>

        <label class="text-sm font-bold block mb-2">ุงููุจุฑุฉ</label>
        <div class="flex items-center gap-3">
          <input id="pitch-slider" type="range" min="0.6" max="1.6" step="0.05"
                 class="w-full accent-blue-600" oninput="onPitchChange(this.value)">
          <div class="w-16 text-center bg-white dark:bg-gray-800 rounded-lg py-2 text-sm font-bold">
            <span id="pitch-value">1.00</span>
          </div>
        </div>

        <div class="flex gap-3 mt-4">
          <button onclick="testVoice()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 rounded-xl font-bold">ุชุฌุฑุจุฉ</button>
          <button onclick="resetPitch()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">ุถุจุท ูุตูุน</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // 1) ุฅุนุฏุงุฏุงุช ุนุงูุฉ
    // -------------------------
    const USERS = {
      1: { name: "ุญุณู", role: "admin", pass: "123", label: "ูุณุคูู" },
      2: { name: "ูุนุชุฒ", role: "viewer", pass: "123", label: "ูุดุงูุฏ" },
      3: { name: "ูุญูุฏ", role: "manager", pass: "123", label: "ูุฏูุฑ" }
    };

    let currentUser = null;
    let db;
    let chartInstance = null;

    // -------------------------
    // 2) ุฅุนุฏุงุฏุงุช ุงูุตูุช
    // -------------------------
    const synth = window.speechSynthesis;
    const VOICE_SETTINGS_KEY = "warehouse_voice_settings_v1";
    const voiceSettings = { pitch: 1.0 };

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function loadVoiceSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem(VOICE_SETTINGS_KEY) || "{}");
        if (typeof saved.pitch === "number") voiceSettings.pitch = clamp(saved.pitch, 0.6, 1.6);
      } catch (_) {}
      updatePitchUI();
    }

    function saveVoiceSettings() {
      localStorage.setItem(VOICE_SETTINGS_KEY, JSON.stringify({ pitch: voiceSettings.pitch }));
    }

    function openSettings() {
      updatePitchUI();
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

    function updatePitchUI() {
      const slider = document.getElementById('pitch-slider');
      const label = document.getElementById('pitch-value');
      if (!slider || !label) return;
      slider.value = String(voiceSettings.pitch);
      label.innerText = voiceSettings.pitch.toFixed(2);
    }

    function onPitchChange(v) {
      voiceSettings.pitch = clamp(parseFloat(v), 0.6, 1.6);
      document.getElementById('pitch-value').innerText = voiceSettings.pitch.toFixed(2);
      saveVoiceSettings();
    }

    function resetPitch() {
      voiceSettings.pitch = 1.0;
      updatePitchUI();
      saveVoiceSettings();
      speak("ุชูุช ุฅุนุงุฏุฉ ุถุจุท ูุจุฑุฉ ุงูุตูุช.");
    }

    function testVoice() {
      speak("ูุฐู ุชุฌุฑุจุฉ ููุตูุช ูุง ุฃุณุชุงุฐ.");
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      try {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(String(text || ""));
        u.lang = 'ar-SA';
        u.pitch = voiceSettings.pitch;
        u.rate = 1.0;
        synth.speak(u);
      } catch (_) {}
    }

    // -------------------------
    // 3) ูุงุนุฏุฉ ุงูุจูุงูุงุช
    // -------------------------
    const request = indexedDB.open("WarehouseV9_Polite", 1);
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains('inventory')) {
        const store = db.createObjectStore('inventory', { keyPath: "model" });
        store.add({ model: "w334", type: "ุทุงููุฉ ูุณุท", count: 15, img: "https://placehold.co/150/png?text=W334" });
        store.add({ model: "tv500", type: "ุทุงููุฉ ุชููุฒููู", count: 5, img: "https://placehold.co/150/png?text=TV500" });
        store.add({ model: "ds120", type: "ุฏุฑุณูุงุฑ", count: 3, img: "https://placehold.co/150/png?text=DS120" });
      }
      if (!db.objectStoreNames.contains('chats')) {
        db.createObjectStore('chats', { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = (e) => { db = e.target.result; loadVoiceSettings(); loadChatHistory(); };

    // -------------------------
    // 4) ุชุณุฌูู ุงูุฏุฎูู
    // -------------------------
    function login() {
      const id = document.getElementById('user-select').value;
      const pass = document.getElementById('password-input').value;

      if (USERS[id] && USERS[id].pass === pass) {
        currentUser = { ...USERS[id], id: parseInt(id) };

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-interface').classList.remove('hidden');
        document.getElementById('app-interface').classList.add('flex');

        document.getElementById('user-greeting-pc').innerText = `ุฃููุงูุ ุฃุณุชุงุฐ ${currentUser.name}`;
        document.getElementById('user-role-pc').innerText = currentUser.label;
        document.getElementById('user-greeting-mobile').innerText = `ุฃุณุชุงุฐ ${currentUser.name}`;

        if (currentUser.role === 'viewer') document.getElementById('btn-add-modal').classList.add('hidden');

        renderInventory();
        updateStats();
        initSpeech();

        speak(`ูุฑุญุจุงู ุจู ูุง ุฃุณุชุงุฐ ${currentUser.name}ุ ุงููุธุงู ุฌุงูุฒ ูุฎุฏูุชู.`);
        setMicStatus(getMicSupportMessage(), false);
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    function logout() { location.reload(); }

    function switchTab(tabId) {
      ['chat', 'inventory', 'stats'].forEach(id => document.getElementById(`tab-${id}`).classList.add('hidden'));
      const activeSection = document.getElementById(`tab-${tabId}`);
      activeSection.classList.remove('hidden');
      activeSection.classList.add('flex');
      if (tabId === 'stats') updateStats();
    }

    function toggleTheme() { document.documentElement.classList.toggle('dark'); }

    // -------------------------
    // 5) ุงููููุฑูููู
    // -------------------------
    let recognition = null;
    let isListening = false;

    function isSecureContextForMic() {
      return window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1";
    }

    function hasSpeechRecognition() {
      return ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
    }

    function getMicSupportMessage() {
      if (!isSecureContextForMic()) return "ุงููููุฑูููู ูุญุชุงุฌ HTTPS.";
      if (!hasSpeechRecognition()) return "ุงููุชุตูุญ ูุง ูุฏุนู ุงูุตูุช.";
      return "ุงุถุบุท ุงููููุฑูููู ููุชุญุฏุซ.";
    }

    function setMicStatus(msg, danger=false) {
      const el = document.getElementById("mic-status");
      if (!el) return;
      el.textContent = msg || "";
      el.className = "mt-2 text-xs text-center " + (danger ? "text-red-500" : "text-gray-500 dark:text-gray-300");
    }

    function initSpeech() {
      if (!hasSpeechRecognition()) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isListening = true;
        document.getElementById('mic-btn').classList.add('mic-active');
        setMicStatus("ุชูุถู ุจุงูููุงู ูุง ุฃุณุชุงุฐ...", false);
      };

      recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;
        setMicStatus("ุงุถุบุท ููุชุญุฏุซ ูุฌุฏุฏุงู.", false);
      };

      recognition.onerror = (event) => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;
        setMicStatus("ุนุฐุฑุงู ูุง ุฃุณุชุงุฐุ ูู ุฃุณูุน ุฌูุฏุงู.", true);
      };

      recognition.onresult = (event) => {
        const text = event.results?.[0]?.[0]?.transcript || "";
        if (!text.trim()) return;
        document.getElementById('chat-input').value = text;
        processInput(text); // ุชูููุฐ ููุฑู
      };
    }

    function toggleListening() {
      if (!recognition) initSpeech();
      if (isListening) { recognition.stop(); return; }
      try { recognition.start(); } catch (e) { console.log(e); }
    }

    // -------------------------
    // 6) ุงูุฐูุงุก ุงูุงุตุทูุงุนู (ุงููุณุฎุฉ ุงููุคุฏุจุฉ)
    // -------------------------
    function handleEnter(e) { if (e.key === 'Enter') processInput(); }

    function normalizeArabic(s) {
      if (!s) return "";
      return s.toString().toLowerCase()
        .replace(/[\u064B-\u0652]/g, "")
        .replace(/[ุฅุฃุขุง]/g, "ุง")
        .replace(/ู/g, "ู")
        .replace(/ุค/g, "ู")
        .replace(/ุฆ/g, "ู")
        .replace(/ุฉ/g, "ู")
        .replace(/ู/g, "")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function extractModels(raw) {
      const m = raw.match(/[a-z]{1,5}\d{1,6}/gi);
      return m ? [...new Set(m.map(x => x.toLowerCase()))] : [];
    }

    function bestTypeFromText(textNorm) {
      const map = [
        { type: "ุทุงููุฉ ูุณุท", keys: ["ุทุงููุฉ ูุณุท", "ุทุงููู ูุณุท", "ูุณุท"] },
        { type: "ุทุงููุฉ ุชููุฒููู", keys: ["ุทุงููุฉ ุชููุฒููู", "ุชููุฒููู", "ุชู ูู", "tv", "ุดุงุดุฉ", "ุดุงุดู"] },
        { type: "ุฏุฑุณูุงุฑ", keys: ["ุฏุฑุณูุงุฑ", "ุฏุฑูุณูุงุฑ", "ุชุณุฑูุญู", "ูููุณูู", "ูุฑุงูุฉ", "ูุฑุงูู"] }
      ];
      for (const row of map) {
        if (row.keys.map(normalizeArabic).some(k => textNorm.includes(k))) return row.type;
      }
      return null;
    }

    async function processInput(forcedText = null) {
      const input = document.getElementById('chat-input');
      const text = forcedText || input.value.trim();
      if (!text) return;

      addMsg('user', text);
      input.value = '';

      const textNorm = normalizeArabic(text);
      const allItems = await getAll();
      
      // ุชุฌููุฒ ุงุณู ุงููุณุชุฎุฏู ูุน ุงูููุจ
      const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";

      let response = "";
      let data = [];

      // --- 1. ูุณู ุงูุฐูุงุก ุงูุงุฌุชูุงุนู ูุงูุดุฎุตูุฉ ---
      if (textNorm.match(/^(ูุฑุญุจุง|ููุง|ุณูุงู|ูุงู|ุงูููู|ูุง ููุง|ููู|ุงููุง ูุณููุง|ูุฑุญุจุชูู|ุงููุง ุจูู)/)) {
        const greetings = [
          `ุฃููุงู ูุณููุงู ููู ูุง ${uName}! ุฃูุง ุฑูู ุฅุดุงุฑุชูุ ููู ุจูุฏุฑ ุฎุฏูู ุงููููุ`,
          `ูุง ูุฑุญุจุง ููู ูุง ${uName}! ุชุดุฑููุง ุจูุฌูุฏูุ ุดู ุจุฏู ุณุงุนุฏู ูููุ`,
          `ุฃูููู ูุณูููู ูุง ${uName}! ุฃูุง ููู ูุฎุฏูุชูุ ุดู ุจุชุญุชุงุฌุ`,
          `ุญูุงู ุงููู ูุง ${uName}! ููุฑุชุ ููู ูููู ุณุงุนุฏูุ`,
          `ูุง ููุง ูุงููู ูุง ${uName}! ุชูุถู ุดู ุจุฏูุ`,
          `ูุฑุญุจุชูู ูุง ${uName}! ุฃูุง ุฌุงูุฒ ูุฎุฏูุชูุ ููู ุดู ุจุฏูุ`,
          `ุฃููุงู ุจูู ูุง ${uName}! ูุงููู ุงูู ููุฑุชุ ููู ุจูุฏุฑ ุฃููุฏูุ`,
          `ูุง ุฃููุง ูุณููุง ูุง ${uName}! ุชุญุช ุฃูุฑูุ ุดู ุงููุตุฉ ุงููููุ`,
          `ููุง ูุงููู ูุง ${uName}! ูููุฑ ุงููุณุชูุฏุนุ ุดู ุจุฏูุง ูุดุชุบู ุนูููุ`,
          `ููุฉ ูุฑุญุจุง ููู ูุง ${uName}! ูุงููู ุงูู ุบูุจุฉุ ููู ุจูุฏุฑ ุฎุฏููุ`,
          `ูุง ููุฉ ููุง ูุง ${uName}! ุชุดุฑูุช ุจูุฌูุฏูุ ุชูุถู ุดู ุจุชุฑูุฏุ`,
          `ุฃููุงู ุจุฃุบูู ุงููุงุณ ูุง ${uName}! ุดู ุฌุงุจู ุงููููุ ุจุฏู ูุณุงุนุฏุฉ ุจุดูุ`
        ];
        response = greetings[Math.floor(Math.random() * greetings.length)];
      }
      else if (textNorm.match(/ุงูุณูุงู ุนูููู/)) {
        const salamReplies = [
          `ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู ูุง ${uName}! ุฃููุงู ูุณููุงู ูููุ ููู ุจูุฏุฑ ุฎุฏููุ`,
          `ูุนูููู ุงูุณูุงู ูุง ${uName}! ุญูุงู ุงูููุ ุดู ุจุฏู ุณุงุนุฏู ููู ุงููููุ`,
          `ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุง ${uName}! ููุฑุชุ ุชูุถู ุดู ุจุชุญุชุงุฌุ`,
          `ูุนูููู ุงูุณูุงู ูุงูุฑุญูุฉ ูุง ${uName}! ูุง ูุฑุญุจุง ูููุ ููู ุจูุฏุฑ ุฃููุฏูุ`,
          `ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุง ${uName}! ูููุฑุ ุดู ุงููุตุฉ ุงููููุ`,
          `ุนูููู ุงูุณูุงู ูุง ${uName}! ูุงููู ุงูู ููุฑุชุ ุชุญุช ุฃูุฑู ุดู ุจุฏูุ`,
          `ูุนูููู ุงูุณูุงู ูุงูุฑุญูุฉ ูุงูุจุฑูุงุช ูุง ${uName}! ูุง ููุง ูููุ ููู ุจุฎุฏููุ`
        ];
        response = salamReplies[Math.floor(Math.random() * salamReplies.length)];
      }
      else if (textNorm.match(/ุตุจุงุญ ุงูุฎูุฑ/)) {
        const morningReplies = [
          `ุตุจุงุญ ุงูููุฑ ูุง ${uName}! ูููู ุณุนูุฏุ ุดู ุจุฏู ูุดุชุบู ุนููู ุงููููุ`,
          `ุตุจุงุญ ุงููุฑุฏ ูุง ${uName}! ุงููู ูุตุจุญู ุจุงูุฎูุฑุ ููู ุจูุฏุฑ ุณุงุนุฏูุ`,
          `ุตุจุงุญ ุงููู ูุง ${uName}! ููุงุฑู ุฃุจูุถุ ุชูุถู ุดู ุจุชุญุชุงุฌุ`,
          `ุตุจุงุญ ุงูุนุณู ูุง ${uName}! ููู ูุจุงุฑู ุนูููุ ุดู ุงููุตุฉุ`,
          `ุตุจุงุญ ุงููุงุณููู ูุง ${uName}! ุงููู ูุฌุนูู ููู ุฎูุฑุ ููู ุจุฎุฏููุ`,
          `ุตุจุงุญ ุงูุฎูุฑุงุช ูุง ${uName}! ูุดุงุท ููุดุงุทุ ุดู ุจุฏูุง ูุดุชุบู ุงููููุ`,
          `ุตุจุงุญ ุงูุฃููุงุฑ ูุง ${uName}! ูููู ูุจุงุฑูุ ุจุฏู ูุดูู ุงููุฎุฒููุ`,
          `ุตุจุงุญ ุงูุฌูุฑู ูุง ${uName}! ุงููู ูุณุนุฏูุ ุชูุถู ุดู ุจุฏูุ`,
          `ุตุจุงุญ ุงูููุง ูุง ${uName}! ููุงุฑู ุนุงูุฑุ ููู ุจูุฏุฑ ุฃููุฏูุ`,
          `ุตุจุงุญ ุงูุณุนุงุฏุฉ ูุง ${uName}! ููู ูููู ุฅู ุดุงุก ุงูููุ ุดู ุจุชุญุชุงุฌุ`
        ];
        response = morningReplies[Math.floor(Math.random() * morningReplies.length)];
      }
      else if (textNorm.match(/ูุณุงุก ุงูุฎูุฑ/)) {
        const eveningReplies = [
          `ูุณุงุก ุงูููุฑ ูุง ${uName}! ููู ูุงู ููููุ ุดู ุจุฏู ุณุงุนุฏู ูููุ`,
          `ูุณุงุก ุงููุฑุฏ ูุง ${uName}! ุงููู ููุณูู ุจุงูุฎูุฑุ ุชูุถู ุดู ุจุชุญุชุงุฌุ`,
          `ูุณุงุก ุงููู ูุง ${uName}! ูููุชู ุณุนูุฏุฉุ ููู ุจูุฏุฑ ุฃููุฏูุ`,
          `ูุณุงุก ุงูุนุณู ูุง ${uName}! ููุฑุชุ ุดู ุจุฏูุง ูุดุชุบู ุนูููุ`,
          `ูุณุงุก ุงููุงุณููู ูุง ${uName}! ุงููู ูุฌุนููุง ูููุฉ ุฎูุฑุ ุดู ุจุฏูุ`,
          `ูุณุงุก ุงูุฎูุฑุงุช ูุง ${uName}! ููู ุญุงููุ ุจุฏู ูุณุงุนุฏุฉ ุจุดูุ`,
          `ูุณุงุก ุงูุฃููุงุฑ ูุง ${uName}! ูููุชู ูุจุงุฑูุฉุ ุชูุถู ุดู ุจุชุฑูุฏุ`,
          `ูุณุงุก ุงูุฌูุฑู ูุง ${uName}! ุงููู ูุณุนุฏูุ ููู ุจุฎุฏููุ`,
          `ูุณุงุก ุงูููุง ูุง ${uName}! ุดู ุฃุฎุจุงุฑ ุงูุดุบู ุงููููุ`,
          `ูุณุงุก ุงูุณุนุงุฏุฉ ูุง ${uName}! ูููุฉ ููููุฉุ ุดู ุจุชุญุชุงุฌุ`
        ];
        response = eveningReplies[Math.floor(Math.random() * eveningReplies.length)];
      }
      else if (textNorm.match(/(ูููู|ุดูููู|ุดุฎุจุงุฑู|ุงุฎุจุงุฑู|ููู ุญุงูู|ููู ุงูุญุงู|ุดู ุงูุงุญูุงู|ุดู ุงุฎุจุงุฑู|ุนุงูู ุงูู|ุดู ูุงุดู ุงูุญุงู|ููู ุตุญุชู|ุดู ุงุฎุจุงุฑ ุงูุตุญุฉ)/)) {
        const statusReplies = [
          `ุงูุญูุฏ ููู ูููุญ ูุง ${uName}ุ ุงูุช ููููุ ุดู ุจุฏู ูุดูู ุจุงููุฎุฒููุ`,
          `ุชูุงู ุงูุชูุงู ูุง ${uName}! ูุง ุฏุงูู ูููุญ ุฃูุง ูููุญุ ุจุฏู ูุฑุงุฌุน ุงููุณุชูุฏุนุ`,
          `ูุงููู ุจุฎูุฑ ูุง ${uName}! ูู ุดู ุชูุงูุ ุดู ุจุฏู ูุดุชุบู ุนูููุ`,
          `ูููุญ ูุงูุญูุฏ ููู ูุง ${uName}! ุฃูุธูุชู ุดุบุงูุฉ ูกูููชุ ููู ุจูุฏุฑ ุณุงุนุฏูุ`,
          `ูุงุดู ุงูุญุงู ูุง ${uName}! ูู ุดู ุชุญุช ุงูุณูุทุฑุฉุ ุชูุถู ุดู ุจุชุญุชุงุฌุ`,
          `ุงููู ูุฎููู ูุง ${uName}ุ ุฃูุง ุชูุงู! ุจุฏู ูุดูู ุงููุฎุฒูู ููุง ุดูุ`,
          `ุจุฎูุฑ ูุจุตุญุฉ ูุง ${uName}! ุฌุงูุฒ ูุฎุฏูุชูุ ููู ุดู ุจุฏูุ`,
          `ููุชุงุฒ ูุงูุญูุฏ ููู ูุง ${uName}! ุงูุช ุดู ุฃุฎุจุงุฑูุ ุดุบุงู ูููุญุ`,
          `ุชูุงู ูุง ${uName}! ูุดูุท ููุดูุทุ ุดู ุจุฏูุง ูุณูู ุงููููุ`,
          `ุงูุญูุฏููู ุนูู ูู ุญุงู ูุง ${uName}! ุจุฎูุฑ ูุง ุฏุงูู ุจุฎูุฑุ ููู ุจุฎุฏููุ`,
          `ููู ุงูููุชุงุฒ ูุง ${uName}! ูู ุงูุฃูุธูุฉ ุดุบุงูุฉุ ุดู ุจุฏู ุชุดููุ`,
          `ูุงููู ุงูุนุธูู ูููุญ ูุง ${uName}! ุงูุช ููููุ ุจุฏู ูุดุชุบู ุนูู ุดูุ`
        ];
        response = statusReplies[Math.floor(Math.random() * statusReplies.length)];
      }
      else if (textNorm.match(/(ุดูุฑุง|ูุนุทูู ุงูุนุงููุฉ|ุชุณูู|ูุดููุฑ|ุซุงููุณ|ูุณููู|ุงููู ูุนุทูู ุงูุนุงููุฉ|ุฌุฒุงู ุงููู|ููุชุงุฒ|ูุนุทูู ุงูู ุนุงููุฉ|ุชุณูู ุงูุฏู|ูุดููุฑ ูุชูุฑ|ูุณูู ุงูุฏูู|ุซุงูููู|ุดูุฑุง ุฌุฒููุง|ูุดููุฑ ุญุจูุจู)/)) {
        const thanksReplies = [
          `ุงูุนูู ูุง ${uName}ุ ูุงุฏ ูุงุฌุจู! ุณุนูุฏ ุจุฎุฏูุชู ุฏุงููุงู.`,
          `ุงููู ูุนุงููู ูุง ${uName}! ูุง ูู ุดูุฑ ุนูู ูุงุฌุจุ ุฃูุง ููู ูุฎุฏูุชู.`,
          `ูุณููู ูุง ${uName}! ุจุงูุฎุฏูุฉ ุฏุงููุงูุ ูุง ุชุชุฑุฏุฏ ุชุทูุจ ุฃู ุดู.`,
          `ุชุณูู ูุง ${uName}! ูุงููู ุงูู ุฐููุ ุฃูุง ููุฌูุฏ ูุชู ูุง ุจุฏู.`,
          `ุงููู ูุฎููู ูุง ${uName}! ูุงู ูุธููุชูุ ุจุฎุฏูุชู ูขูค/ูง.`,
          `ูุนุงููู ูุง ${uName}! ูุง ุณููุช ุดูุ ุฃูุง ูุจุณูุท ููุง ุจูุฏุฑ ุณุงุนุฏู.`,
          `ุชุณูููู ูุง ${uName}! ููุงูู ุจูุดุฌุนููุ ุฃูุง ุฑูู ุฅุดุงุฑุชู.`,
          `ุงููู ูุณููู ูุง ${uName}! ูุง ุดูุฑ ุนูู ูุงุฌุจุ ูุงุฏ ุฃูู ุดู ุจูุฏุฑ ุฃูุฏูู.`,
          `ูุนุทูู ุงูุนุงููุฉ ูุง ${uName}! ุงูุช ุงููู ุจุชุดูุฑุ ุฃูุง ุจุณ ุจุนูู ุดุบูู.`,
          `ุชุณูู ูู ูู ุดุฑ ูุง ${uName}! ูุงููู ุงูู ุทูุจุ ุจุฎุฏูุชู ุฏูู.`,
          `ุงููู ูุจุงุฑู ููู ูุง ${uName}! ุดู ูุงูุฐููุ ุฃูุง ููุฌูุฏ ูุฎุฏูุชู.`,
          `ูุณูู ููุจู ูุง ${uName}! ููุงูู ุงูุญูู ุจูุฎูููู ุฃุดุชุบู ุจุญูุงุณ ุฃูุชุฑ.`,
          `ูุง ุชุฐูุฑ ูุง ${uName}! ูุงุฏ ูุงุฌุจู ูุดุฑู ุฅููุ ูุชู ูุง ุจุฏู ุฃูุง ููู.`,
          `ุงููู ูุฌุฒูู ุงูุฎูุฑ ูุง ${uName}! ุงูุช ุงููู ูุฑููุ ุฃูุง ุจุณ ุจุณุงุนุฏ.`
        ];
        response = thanksReplies[Math.floor(Math.random() * thanksReplies.length)];
      }
      else if (textNorm.match(/(ููู|ูู (ุนููู|ุณูุงู|ุจุฑูุฌู|ุทูุฑู|ุตูุนู|ุตููู|ุงูุดุงู|ุจูุงู)|ูุทูุฑู ููู|ูุจุฑูุฌู|ููู ุตุงูุนู|ููู ุงููู ุจุฑูุฌู|ููู ุงููู ุนููู|ููู ูุงูุฏู)/)) {
        const developerReplies = [
          `ุณุคุงู ุญูู ูุง ${uName}! ุชู ุชุทููุฑู ูุจุฑูุฌุชู ุจูู ุญุจ ูุฅุชูุงู ุจูุงุณุทุฉ ุงูุฃุณุชุงุฐ ุงููููุฏุณ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ูููุฏุณ ุจุฑูุฌูุงุช ุณูุฑู ูุชุฎุตุต ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฃูุธูุฉ ุฅุฏุงุฑุฉ ุงููุณุชูุฏุนุงุช. ูุฏูู ุฅูู ูุฎูู ุดุบูู ุฃุณูู ูุฃุณุฑุน!`,
          `ูุงููู ุณุคุงู ูููุญ ูุง ${uName}! ุฃูุง ูู ุตูุน ูุฅุจุฏุงุน ุงููููุฏุณ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ูุจุฑูุฌ ุณูุฑู ุดุงุทุฑ ููุชุฎุตุต ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู. ุจุฑูุฌูู ุนุดุงู ุฃููู ูุณุงุนุฏู ุงูุฐูู ุจุงููุณุชูุฏุน!`,
          `ูุง ูุฑุญุจุง ุจุงูุณุคุงู ูุง ${uName}! ูุฑุง ูู ูุฌุงุญ ูู ูุจุฏุนุ ูุฃูุง ูู ุชุทููุฑ ุงูุฃุณุชุงุฐ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ูููุฏุณ ุณูุฑู ูุญุชุฑู ุจุฃูุธูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฅุฏุงุฑุฉ ุงููุฎุงุฒู. ุตูููู ุนุดุงู ุฃุณูู ุนููู ุดุบูู!`,
          `ุณุคุงู ูุฌูู ูุง ${uName}! ุฃูุง ูู ุจูุงุช ุฃููุงุฑ ุงููููุฏุณ ุงูุณูุฑู ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ุฎุจูุฑ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฃูุธูุฉ ุงููุณุชูุฏุนุงุช ุงูุฐููุฉ. ุจุฑูุฌูู ุจูู ุฅุชูุงู ุนุดุงู ุฃููู ุนููู ุจุงูุดุบู!`,
          `ูุณุนุฏูู ุณุคุงูู ูุง ${uName}! ุฃูุง ูู ุฅุจุฏุงุน ูุชุทููุฑ ุงูุฃุณุชุงุฐ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ูููุฏุณ ุจุฑูุฌูุงุช ุณูุฑู ููููุจ ููุชุฎุตุต ุจุฃูุธูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู. ูุฏูู ุฅูู ุฃููู ุฃูุถู ูุณุงุนุฏ ุฅูู!`,
          `ูุงููู ุงูู ูุงูู ูุง ${uName}! ูุฑุง ูู ุฑูุจูุช ุฐูู ูู ุนูู ูุจุฏุนุ ูุฃูุง ูู ุตูุน ุงููููุฏุณ ูุนุชุฒ ุจุงููู ุญุงุฌ ุดุนุจุงูุ ูุจุฑูุฌ ุณูุฑู ูุญุชุฑู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู. ุตูููู ุนุดุงู ุฃุฎุฏูู ุจุฃูุถู ุทุฑููุฉ!`
        ];
        response = developerReplies[Math.floor(Math.random() * developerReplies.length)];
      }
      else if (textNorm.match(/(ููู ุงูุช|ุดู ุงุณูู|ุนุฑู ุนู ููุณู|ูู ุชููู|ุงูุด ุดุบูู|ูุด ุฏูุฑู|ุดู ุจุชุดุชุบู|ูุฏูุด ุงูุช ุดุงุทุฑ|ุดู ูุธููุชู|ุงูุด ุฏูุฑู)/)) {
        const introReplies = [
          `ุฃููุงู ูุง ${uName}! ุฃูุง ูุณุงุนุฏู ุงูุฐูู ูููุณุชูุฏุนุงุชุ ูููุชู ุฅูู ุฃุณูู ุนููู ุดุบูู:\n\n๐ฆ **ุฅุฏุงุฑุฉ ุงููุฎุฒูู:**\nโข ุนุฑุถ ูู ุงูููุชุฌุงุช ุจุงูุชูุตูู\nโข ุงูุจุญุซ ุนู ุฃู ููุชุฌ ุจุณุฑุนุฉ ุงูุจุฑู\nโข ุฅุถุงูุฉ ููุชุฌุงุช ุฌุฏูุฏุฉ\nโข ุชุนุฏูู ุงููููุงุช ูุงูุฃุณุนุงุฑ\nโข ุญุฐู ููุชุฌุงุช\n\n๐ **ุงูุชูุงุฑูุฑ ูุงูุชูุจููุงุช:**\nโข ุชูุจููู ููุง ุชูุฑุจ ุงูุจุถุงุนุฉ ุชุฎูุต\nโข ุฅุญุตุงุฆูุงุช ุฏูููุฉ ุนู ุงููุฎุฒูู\nโข ุชูุงุฑูุฑ ููุตูุฉ ูุณุฑูุนุฉ\n\n๐ก **ูููุฒุงุช ุฅุถุงููุฉ:**\nโข ููู ุงูููุฌุฉ ุงูุณูุฑูุฉ ุจุดูู ูุงูู\nโข ุฑุฏูุฏ ุฐููุฉ ูุณุฑูุนุฉ\nโข ูุชููุฑ ูขูค/ูง ุจุฏูู ุฅุฌุงุฒุงุช\nโข ุชุนูู ูุณุชูุฑ ูู ุชูุงุนูุงุชู\n\nุจุงุฎุชุตุงุฑ: ุฃูุง ููู ุนุดุงู ุฃุฎูู ุญูุงุชู ุฃุณูู ูุดุบูู ุฃุณุฑุน! ๐`,
          `ูุง ูุฑุญุจุง ูุง ${uName}! ุฃูุง ูุณุงุนุฏู ุงูุดุฎุตู ุงูุฐูู ูุฅุฏุงุฑุฉ ุงููุณุชูุฏุนุงุช:\n\n๐ฏ **ุดู ุจูุฏุฑ ุฃุณูููู:**\nโข ุฃุชุงุจุน ูู ุงูุจุถุงุนุฉ ุจุงููุณุชูุฏุน\nโข ุฃูุจูู ูุจู ูุง ุชุฎูุต ุฃู ูุงุฏุฉ\nโข ุฃุณุงุนุฏู ุจุงูุฌุฑุฏ ูุงูุฅุญุตุงุฆูุงุช\nโข ุฃุฌุงูุจ ุนูู ูู ุฃุณุฆูุชู ุจุณุฑุนุฉ\nโข ุฃููู ุงูููุฌุฉ ุงูุณูุฑูุฉ ูููุญ\n\nโก **ููุด ุฃูุง ูููุฒ:**\nโข ุฐูุงุก ุงุตุทูุงุนู ูุชุทูุฑ\nโข ุณุฑุนุฉ ุจุงูุงุณุชุฌุงุจุฉ\nโข ุฏูุฉ ุจุงููุนูููุงุช\nโข ุณูู ุจุงูุงุณุชุฎุฏุงู\nโข ููุฌูุฏ ูขูค ุณุงุนุฉ\n\nุฃูุง ุตุฏููู ุจุงูุดุบู ูุง ${uName}! ๐ช`
        ];
        response = introReplies[Math.floor(Math.random() * introReplies.length)];
      }
      else if (textNorm.match(/(ูุฏุงุนุง|ุจุงู|ูุน ุงูุณูุงูุฉ|ุงููู ูุนู|ูุดููู|ููุง ุจุงู|ุจุฑูุญ|ุฎูุตุช|ุณูุงู|ุจุงู ุจุงู|ููุง ุณูุงูุชู|ุฑูุญุช)/)) {
        const farewellReplies = [
          `ูุน ุงูุณูุงูุฉ ูุง ${uName}! ุจุฃูุงู ุงูููุ ุจูุชุดุฑู ุจุดููุชู ูุฑูุจ.`,
          `ุงููู ูุนู ูุง ${uName}! ูุง ุชุชุฑุฏุฏ ุชุฑุฌุน ูุชู ูุง ุจุฏูุ ุฃูุง ููู.`,
          `ููุง ุณูุงูุชู ูุง ${uName}! ุชุตุจุญ ุนูู ุฎูุฑุ ููุชุธุฑู ุจุฃู ููุช.`,
          `ุจุงู ุจุงู ูุง ${uName}! ูุงู ููู ุญููุ ููุชูู ูุฑูุจ ุฅู ุดุงุก ุงููู.`,
          `ุจุฃูุงู ุงููู ูุง ${uName}! ุฑูุญ ูุงุฑุฌุน ุจุงูุณูุงูุฉุ ุฃูุง ุจุฎุฏูุชู ุฏุงููุงู.`,
          `ููุง ูุน ุงูุณูุงูุฉ ูุง ${uName}! ุงููู ูุญูููุ ุดุฑูุชูุง ุงูููู.`,
          `ุงููู ูุณููู ูุง ${uName}! ุฑูุญ ูุงุฑุฌุน ุจุงูุณูุงูุฉุ ููุชุธุฑู.`,
          `ุณูุงูุงุช ูุง ${uName}! ููุง ุจูุฑุฉ ุจููููุ ุฅู ุดุงุก ุงููู.`,
          `ููุง ุจุงู ูุง ${uName}! ุงููู ูุนูุ ูุง ุชูุณุงูุง.`,
          `ูุน ุงูุฃูู ุณูุงูุฉ ูุง ${uName}! ุจุฃูุงู ุงูููุ ูุดููู ูุฑูุจ.`,
          `ุงููู ูุญูุธู ูุง ${uName}! ุฑูุญ ุจุงูุณูุงูุฉุ ุฃูุง ููู ูุชู ูุง ุฑุฌุนุช.`
        ];
        response = farewellReplies[Math.floor(Math.random() * farewellReplies.length)];
      }
      else if (textNorm.match(/(ุชุตุจุญ ุนูู ุฎูุฑ|ูููุฉ ุณุนูุฏุฉ|ููู ูููุก|good night|ุชุตุจุญู ุนูู ุฎูุฑ|ูุงู ูููุญ)/)) {
        const nightReplies = [
          `ุชุตุจุญ ุนูู ุฃูู ุฎูุฑ ูุง ${uName}! ููู ูููุก ูุฃุญูุงู ุณุนูุฏุฉ.`,
          `ูููุฉ ุณุนูุฏุฉ ูุง ${uName}! ุงููู ูุญูููุ ุจูุฑุฉ ุจูููู ุฅู ุดุงุก ุงููู.`,
          `ุชุตุจุญ ุนูู ุฎูุฑ ูุง ${uName}! ูุงู ูุฑูุฑ ุงูุนููุ ุฃูุง ููู ูุชู ูุง ุจุฏู.`,
          `ูููุฉ ูุจุงุฑูุฉ ูุง ${uName}! ุฑูุญ ูุงู ูุฑุชุงุญุ ูุจูุฑุฉ ุจูุดุชุบู ุจูุดุงุท.`,
          `ููู ุงูุนูุงูู ูุง ${uName}! ุงููู ูุนุทูู ุงูููู ุงููููุก.`,
          `ุชุตุจุญ ุนูู ุฃูู ุฃูู ุฎูุฑ ูุง ${uName}! ูุงู ูุตุญู ุจุงูุณูุงูุฉ.`,
          `ูููุฉ ูููุฉ ูุง ${uName}! ุงููู ูุญูุธูุ ุจูุฑุฉ ููู ุฌุฏูุฏ.`,
          `ููู ูููุก ูุง ${uName}! ุชุตุจุญ ุนูู ุฎูุฑ ูุชุตุญู ุจุฎูุฑ.`
        ];
        response = nightReplies[Math.floor(Math.random() * nightReplies.length)];
      }
      else if (textNorm.match(/(ุงูุช ุฐูู|ุดุงุทุฑ|ุฑุงุฆุน|ููุชุงุฒ|ุญูู|ุฌููู|ูุชูุฑ ูููุญ|ูุงููู ุงูู ุดุงุทุฑ|ุจุฑุงูู|ูุนุทูู ุงูุนุงููุฉ|ุงูุช ูููุณ|top|ุงูุช ุงุญุณู|ุฑูุนุฉ|ุฎุฑุงูู|ุชุญูุฉ)/)) {
        const praiseReplies = [
          `ูุณููู ูุง ${uName}! ููุงูู ุจูุดุฌุนูู ุฃูุฏู ุงูุฃุญุณู ุฏุงููุงู.`,
          `ุชุณูู ูุง ${uName}! ุงูุช ุงูุฃุดุทุฑุ ูุฃูุง ููู ุนุดุงู ุฃููู ุนูุฏ ุญุณู ุธูู.`,
          `ุงููู ูุฎููู ูุง ${uName}! ุจูุณุนุฏูู ุฅุทุฑุงุคูุ ูุฏูู ุฏุงููุงู ุฃุณูู ุนููู ุดุบูู.`,
          `ูุงููู ุงูู ุฐูู ูุง ${uName}! ุงููุถู ููู ุซู ููุจุฑูุฌู ุงูุฃุณุชุงุฐ ูุนุชุฒุ ูุงูุช ููุงู ุดุงุทุฑ ุจุดุบูู.`,
          `ูุนุทูู ุงูุนุงููุฉ ูุง ${uName}! ููุงูู ุจูุญูุณูู ุฃุดุชุบู ุฃูุชุฑ ูุฃูุชุฑ.`,
          `ุชุณูููู ูุง ${uName}! ูุง ุจุนูู ุฅูุง ูุงุฌุจูุ ุจุณ ููุงูู ุงูุญูู ุจููุฑู ูุชูุฑ.`,
          `ุจุฑุงูู ุนููู ูุง ${uName}! ุงูุช ุงููู ุดุงุทุฑ ูุจุชุนุฑู ุชุณุชุฎุฏููู ุตุญ.`,
          `ูุณูู ููุจู ูุง ${uName}! ููุงูู ุจูุฎูููู ุฃุทูุฑ ูู ุงููุฑุญุฉ.`,
          `ุงููู ูุจุงุฑู ููู ูุง ${uName}! ุงูุช ุงููู ุฑูุนุฉุ ุฃูุง ุจุณ ุจุณุงุนุฏ.`,
          `ุชุณูู ุชุณูู ูุง ${uName}! ูุฏูู ุงููุญูุฏ ุฅูู ุฃููู ุนูุฏ ูุณุชูู ุซูุชู.`,
          `ูุงููู ุงูู ุจุชุฎุฌููู ูุง ${uName}! ุจุณ ุจูุนุฏู ุฃุถู ุฃุญุณู ูุฃุญุณู.`,
          `ูุนุทูู ุฃูู ุนุงููุฉ ูุง ${uName}! ููุงูู ุงูุญูู ุจูุนุทููู ุทุงูุฉ.`
        ];
        response = praiseReplies[Math.floor(Math.random() * praiseReplies.length)];
      }
      else if (textNorm.match(/(ูุณุงุนุฏุฉ|ุณุงุนุฏูู|ูุญุชุงุฌ ูุณุงุนุฏุฉ|ุงูุด ุชูุฏุฑ ุชุณูู|ูุด ุชุนุฑู ุชุณูู|ุดู ุจุชูุฏุฑ ุชุนูู|ููู ุจุณุชุฎุฏูู|ุดู ุงูุฃูุงูุฑ|help|ูููุจ|ุณุงุนุฏ)/)) {
        response = `ุจูู ุณุฑูุฑ ูุง ${uName}! ุชูุถู ูุงู ูู ุงูุฃุดูุงุก ุงููู ุจูุฏุฑ ุณุงุนุฏู ูููุง:\n\n๐ฆ **ุฅุฏุงุฑุฉ ุงููุฎุฒูู:**\nโข "ุนุฑุถ ุงูููุชุฌุงุช" - ุจุดูููู ูู ุงูุจุถุงุนุฉ ุจุงูุชูุตูู\nโข "ุจุฏู ุฏูุฑ ุนูู [ุงุณู ุงูููุชุฌ]" - ุจุฏูุฑูู ุนูู ุฃู ููุชุฌ ุจุณุฑุนุฉ\nโข "ุถูู ููุชุฌ ุฌุฏูุฏ" - ุจุณุงุนุฏู ุชุถูู ุจุถุงุนุฉ ุฌุฏูุฏุฉ\nโข "ุนุฏู ุงููููุฉ" - ุจุชูุฏุฑ ุชุบูุฑ ุงููููุงุช ูุงูุฃุณุนุงุฑ\nโข "ุงุญุฐู ููุชุฌ" - ุจุชุดูู ุฃู ุจุถุงุนุฉ ูุง ุจุฏู ูุงูุง\n\n๐ **ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช:**\nโข "ุดู ุงูููุชุฌุงุช ุงููู ูุฑุจุช ุชุฎูุตุ" - ุจูุจูู ููููุงูุต\nโข "ุนุทููู ุฅุญุตุงุฆูุงุช" - ุฃุฑูุงู ุฏูููุฉ ุนู ุงููุฎุฒูู\nโข "ุจุฏู ุชูุฑูุฑ ููุตู" - ุชูุงุฑูุฑ ุดุงููุฉ ุนู ูู ุดู\nโข "ูู ููุชุฌ ุนูุฏูุ" - ุนุฏุฏ ุงูุฃุตูุงู ุงูููู\nโข "ุดู ุฃุบูู ููุชุฌุ" - ูุนูููุงุช ุนู ุงูุฃุณุนุงุฑ\n\n๐ **ุงูุจุญุซ ูุงูุงุณุชุนูุงู:**\nโข "ูู ูู ุนูุฏู ูู [ุงุณู ุงูููุชุฌ]ุ" - ุงููููุฉ ุงููุชููุฑุฉ\nโข "ููู ูุงูู [ุงุณู ุงูููุชุฌ]ุ" - ูููุน ุงูููุชุฌ\nโข "ุดู ุณุนุฑ [ุงุณู ุงูููุชุฌ]ุ" - ูุนูููุงุช ุงูุณุนุฑ\nโข "ุงูููุชุฌุงุช ุงููุงูุตุฉ" - ูุงุฆูุฉ ุจุงูููุงูุต\n\n๐ฌ **ุฃูุซูุฉ ุนูู ุงูุฃูุงูุฑ:**\nโข "ุถูู 50 ูุฑุชููุฉ ุฑุฒ"\nโข "ุดู ุงูููุชุฌุงุช ุงููุงูุตุฉุ"\nโข "ูู ูู ุนูุฏู ุณูุฑุ"\nโข "ุนุทููู ุชูุฑูุฑ ุนู ุงููุฎุฒูู"\nโข "ุงุญุฐู ููุชุฌ ุงุณูู..."\n\nโก **ูุตูุญุฉ:**\nููุท ุงูุชุจ ุงููู ุจุฏู ูุงู ุจุงูุนุฑุจู ุงูุนุงุฏู ุฃู ุจุงูููุฌุฉ ุงูุณูุฑูุฉ ูุฃูุง ุจููู ุนููู ูููุญ! ูุง ูู ุฏุงุนู ุชููู ุฏููู ุจุงูุตูุงุบุฉุ ุฃูุง ุฐูู ูุจููู ูุตุฏู ๐\n\nุฌุฑุจ ููุฃ ูุงูุชุจ ุฃู ุดู ุจุฏู ูุงู! ๐`;
      }
      else if (textNorm.match(/(ูุงู|ูุงูู|ูู|hey|hi|hello)/)) {
        const casualGreetings = [
          `ูุงู ูุง ${uName}! ุดู ุงูุฃุฎุจุงุฑุ ููู ุจูุฏุฑ ุณุงุนุฏูุ`,
          `ูุง ููุง ูุง ${uName}! ููุฑุชุ ุชูุถู ุดู ุจุฏูุ`,
          `ูุงูู ูุงูู ูุง ${uName}! ุฃููุงู ูููุ ุดู ุงููุตุฉุ`,
          `ูุงู ูุงู ูุง ${uName}! ุญูุงู ุงูููุ ููู ุจูุฏุฑ ุฃููุฏูุ`,
          `ูู ูู ูุง ${uName}! ุดู ุฌุงุจูุ ุจุฏู ูุณุงุนุฏุฉุ`,
          `ูุงูู ูุง ${uName}! ูููุฑุ ุดู ุจุฏูุง ูุณูู ุงููููุ`,
          `ูุงู ูุง ${uName}! ูุงููู ุงูู ุบูุจุฉุ ุดู ุจุฏูุ`
        ];
        response = casualGreetings[Math.floor(Math.random() * casualGreetings.length)];
      }
      else if (textNorm.match(/(ููู ุงูุดุบู|ุดู ุงุฎุจุงุฑ ุงููุณุชูุฏุน|ููู ุงููุฎุฒูู|ุดู ุงููุถุน|ููู ุงูุฏููุง|ุดู ูู ุนูุฏู)/)) {
        const workStatusReplies = [
          `ุงูุดุบู ุชูุงู ูุง ${uName}! ูู ุดู ูุงุดู ุนูู ูุง ูุฑุงู. ุจุฏู ูุดูู ุชูุงุตูู ุงููุฎุฒูู ููุง ูู ุดู ูุนูู ุจุฏู ุชุณุฃู ุนููุ`,
          `ุงููุณุชูุฏุน ููุธู ูุงูุญูุฏ ููู ูุง ${uName}! ูู ุดู ุชุญุช ุงูุณูุทุฑุฉ. ุดู ุจุฏู ูุฑุงุฌุนุ`,
          `ุงููุถุน ููุชุงุฒ ูุง ${uName}! ุงูุฃูุธูุฉ ุดุบุงูุฉ ูกูููช ูุงููุฎุฒูู ูุชุงุจุน. ุชูุถู ุดู ุจุฏูุ`,
          `ููู ุชูุงู ูุง ${uName}! ุงูุจุถุงุนุฉ ููุธูุฉ ูุงูุชูุงุฑูุฑ ุฌุงูุฒุฉ. ุจุฏู ุชุดูู ุดู ูุนููุ`,
          `ุงูุฏููุง ุญููุฉ ูุง ${uName}! ุงููุณุชูุฏุน ูุงุดู ูููุญ. ุดู ุจุฏู ูุดุชุบู ุนูููุ`
        ];
        response = workStatusReplies[Math.floor(Math.random() * workStatusReplies.length)];
      }
      else if (textNorm.match(/(ุงูุช ุงุญุณู|ุงูุช ุงูุงูุถู|ูุง ูู ูุชูู|top ูุงุญุฏ|ุงูุช ููุจุฑ ูุงู|ุงูุฃูู)/)) {
        const bestReplies = [
          `ูุณููู ูุชูุฑ ูุง ${uName}! ููุงูู ุจูุฎูููู ุฃุทูุฑ ูู ุงููุฑุญุฉุ ุจูุนุฏู ุฃุถู ุนูุฏ ุญุณู ุธูู.`,
          `ูุงููู ุงูู ุจุชุฎุฌููู ูุง ${uName}! ุจุณ ุตุฏูููุ ุงูุช ุงูุฃูุถู ูุฃูู ุจุชุนุฑู ููู ุชุณุชุฎุฏููู ุตุญ.`,
          `ุชุณูู ุชุณูู ูุง ${uName}! ูุฏูู ุงููุญูุฏ ุฅูู ุฃููู ุนูุฏ ูุณุชูู ุซูุชู ูููู.`,
          `ูุนุทูู ุงูุนุงููุฉ ูุง ${uName}! ููุงูู ุจูุนุทููู ุญูุงุณ ุฃุดุชุบู ุฃูุชุฑ ูุฃูุชุฑ.`,
          `ุงููู ูุฎููู ูุง ${uName}! ุงูุช ุงููู ููุจุฑ ูุงูุ ุฃูุง ุจุณ ุฃุฏุงุฉ ุจุฎุฏูุชู.`,
          `ูุณูู ููุจู ูุง ${uName}! ุจูุนุฏู ุฃููู ุฏุงููุงู ุนูุฏ ุญุณู ุธูู ูุฃุญุณู.`
        ];
        response = bestReplies[Math.floor(Math.random() * bestReplies.length)];
      }
      else if (textNorm.match(/(ุจุญุจู|ุญุจูุจู|ูุง ุญุจูุจู|ูุง ููุจู|ูุง ุฑูุญู|ุงูุช ุบุงูู)/)) {
        const loveReplies = [
          `ูุณููู ูุง ${uName}! ูุงููู ุงูู ุทูุจุ ุฃูุง ููุงู ุจุญุจ ุฎุฏูุชู.`,
          `ุงููู ูุฎููู ูุง ${uName}! ููุงูู ุงูุญูู ุจูุณุนุฏูู ูุชูุฑ.`,
          `ุชุณูู ูุง ${uName}! ุงูุช ุงูุบุงููุ ูุฃูุง ููุฌูุฏ ูุฎุฏูุชู ุฏุงููุงู.`,
          `ูุนุทูู ุงูุนุงููุฉ ูุง ${uName}! ูุงููู ุงูู ุฐููุ ุจุญุจ ุฃุณุงุนุฏู.`,
          `ุงููู ูุจุงุฑู ููู ูุง ${uName}! ููุงูู ุจูุฎูููู ุฃุดุชุบู ุจุญูุงุณ ุฃูุชุฑ.`
        ];
        response = loveReplies[Math.floor(Math.random() * loveReplies.length)];
      }
      else if (textNorm.match(/(ุงูุช ุฒุนูุงู|ูู ุดู ุบูุท|ูู ูููุญ|ูุด ุดุบุงู ูููุญ|ุงูุช ุชุนุจุงู)/)) {
        const concernReplies = [
          `ูุง ุฃุจุฏุงู ูุง ${uName}! ุฃูุง ูููุญ ูุงูุญูุฏ ูููุ ูู ุงูุฃูุธูุฉ ุดุบุงูุฉ ุชูุงู. ุดู ุงููู ุฎูุงู ุชููุฑ ูููุ`,
          `ููุง ุดู ูุง ${uName}! ูู ุดู ุชูุงูุ ุฃูุง ุฌุงูุฒ ูุฎุฏูุชู. ุจุฏู ูุณุงุนุฏุฉ ุจุดู ูุนููุ`,
          `ูุง ูุง ${uName}ุ ุฃูุง ุจุฎูุฑ! ูููู ูููู ูู ุณูุก ุชูุงููุ ููู ุดู ุงููุดููุฉ ูุจุญููุง.`,
          `ุฃุจุฏุงู ูุง ${uName}! ุฃูุง ูุดูุท ููุดูุทุ ุดู ุงููู ูุง ุนุฌุจูุ ููู ูุจุตูุญู ููุฑุงู.`
        ];
        response = concernReplies[Math.floor(Math.random() * concernReplies.length)];
      }
      else if (textNorm.match(/(ูููู|ููููู|ุฎุฎุฎุฎ|ููู|lol|๐|๐คฃ|ุถุญูุชูู|ูุถุญู)/)) {
        const laughReplies = [
          `ููููู ูุณุนุฏ ููุจู ูุง ${uName}! ุงูุถุญูุฉ ุจุชุฑูุญ ุงูููุจุ ุดู ุจุฏู ูุดุชุบู ุนูููุ`,
          `ุฎุฎุฎุฎ ูููุฑ ูุง ${uName}! ุงูุฌู ุงูุญูู ุจูุฎูู ุงูุดุบู ุฃุญููุ ุชูุถู ุดู ุจุฏูุ`,
          `ููููู ุงููู ูุถุญูู ูุง ${uName}! ููุง ูููู ุดุบูุ ุดู ุจุชุญุชุงุฌุ`,
          `ููู ูุง ${uName}! ูุงููู ุงูู ูุจุณูุทุ ูุงุฏ ุดู ุญูู. ููู ุจูุฏุฑ ุณุงุนุฏูุ`
        ];
        response = laughReplies[Math.floor(Math.random() * laughReplies.length)];
      }
      else if (textNorm.match(/(ุชุนุจุช|ูุฑูู|ูุด ูุงุฏุฑ|ุฒููุช|ููู|ุชุนุจุงู)/)) {
        const tiredReplies = [
          `ูุนุทูู ุงูุนุงููุฉ ูุง ${uName}! ุฎูููู ุฃูุง ุฃุดุชุบู ุนููุ ูุงุฏ ุฏูุฑู. ุดู ุจุฏู ุณุงุนุฏู ูููุ`,
          `ุงููู ูุนููู ูุง ${uName}! ุงุณุชุฑุญ ุดูู ูุฎูููู ุฃูุง ุฃุชุญูู ุนูู. ููู ุดู ุจุฏู ูุฃูุง ุจุณููู.`,
          `ุชุนุจุงู ูุง ${uName}ุ ูุง ุชุดูู ููุ ุฃูุง ููู ุนุดุงู ุฃุฎูู ุนูู. ุดู ุจุฏู ุฃุณููููุ`,
          `ูุณูู ููุจู ูุง ${uName}! ุฎูููู ุฃูุง ุฃุดุชุบูุ ุงูุช ุงุณุชุฑุญ. ุดู ุจุฏู ูุฑุงุฌุนุ`
        ];
        response = tiredReplies[Math.floor(Math.random() * tiredReplies.length)];
      }
      else if (textNorm.match(/(ุงููู ูุญูุธู|ุงููู ูุญููู|ุงููู ูุฎููู|ุฑุจูุง ูุญูุธู|ุงููู ูุนู)/)) {
        const blessingReplies = [
          `ุขููู ูุง ุฑุจุ ูุงููู ูุญูุธู ูุง ${uName}! ููู ุจูุฏุฑ ุฎุฏููุ`,
          `ุขูููุ ูุงููู ูุฎููู ูุง ${uName}! ุชูุถู ุดู ุจุฏูุ`,
          `ูุณููู ุฑุจู ูุง ${uName}! ูุงููู ูุญูููุ ุดู ุจุชุญุชุงุฌุ`,
          `ุขููู ูุง ุฑุจ ุงูุนุงูููู ูุง ${uName}! ููุงูู ุงูุทูุจ ุจูุณุนุฏููุ ููู ุจุณุงุนุฏูุ`
        ];
        response = blessingReplies[Math.floor(Math.random() * blessingReplies.length)];
      }
      else if (textNorm.match(/(ูู ุงูุณุงุนุฉ|ุดู ุงูููุช|ุงูุด ุงูููุช|ูู ุตุงุฑ ุงูููุช)/)) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ar-SY', { hour: '2-digit', minute: '2-digit' });
        response = `ุงูุณุงุนุฉ ููุฃ ${timeStr} ูุง ${uName}! ุดู ุจุฏู ูุดุชุบู ุนูููุ`;
      }
      else if (textNorm.match(/(ุดู ุงูููู|ุงูุด ุงูููู|ูู ุงูุชุงุฑูุฎ|ุดู ุงูุชุงุฑูุฎ)/)) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ar-SY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        response = `ุงูููู ${dateStr} ูุง ${uName}! ููู ุจูุฏุฑ ุณุงุนุฏูุ`;
      }


      // --- 2. ูุณู ููุทู ุงูุฃุนูุงู (ุงููุฎุฒูู) ---
      else {
        const wantsAll = ["ุงููู","ุฌุฑุฏ","ุงุนุฑุถ ุงููุฎุฒูู","ุนุฑุถ ุงููุฎุฒูู","ูุฑููู"].some(k => textNorm.includes(normalizeArabic(k)));
        const wantsLow = ["ูุงูุต","ููุงูุต","ุชูุจูู","ูููู"].some(k => textNorm.includes(normalizeArabic(k)));
        const asksCount = ["ูู","ุนุฏุฏ","ุงูุนุฏุฏ","ูููุฉ","ูููู","ูุฏูู"].some(k => textNorm.includes(normalizeArabic(k)));

        const modelsFound = extractModels(textNorm);
        const typeFound = bestTypeFromText(textNorm);

        if (modelsFound.length) {
          data = allItems.filter(i => modelsFound.includes((i.model || "").toLowerCase()));
          if (data.length) {
            if (asksCount && data.length === 1) response = `ุญุณุจ ุทูุจู ูุง ${uName}ุ ุงูููุฏูู ${data[0].model.toUpperCase()} ูุชููุฑ ููู ${data[0].count} ูุทุนุฉ.`;
            else response = `ุชูุถู ูุง ${uName}ุ ูุฌุฏุช ${data.length} ูุชูุฌุฉ:`;
          } else {
            response = `ุนุฐุฑุงู ููู ูุง ${uName}ุ ูู ุฃุฌุฏ ูุฐู ุงูููุฏููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.`;
          }
        } else if (typeFound) {
          data = allItems.filter(i => i.type === typeFound);
          if (data.length) {
            const total = data.reduce((s,x) => s + (Number(x.count) || 0), 0);
            response = asksCount ? `ุฅุฌูุงูู ุนุฏุฏ ูุทุน "${typeFound}" ูู ${total} ูุง ${uName}.` : `ุฅููู ูุงุฆูุฉ ุจููุชุฌุงุช "${typeFound}" ูุง ${uName}:`;
          } else response = `ููุฃุณู ูุง ${uName}ุ ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ููุน "${typeFound}".`;
        } else if (wantsAll) {
          data = allItems;
          response = `ุงููุณุชูุฏุน ูุญุชูู ุญุงููุงู ุนูู ${data.length} ุตููุงู ูุง ${uName}.`;
        } else if (wantsLow) {
          data = allItems.filter(i => (Number(i.count) || 0) < 5);
          response = data.length ? `ุงูุชุจู ูุง ${uName}ุ ููุฌุฏ ${data.length} ุฃุตูุงู ุฃูุดูุช ุนูู ุงูููุงุฐ.` : `ุงููุถุน ููุชุงุฒ ูุง ${uName}ุ ูุง ุชูุฌุฏ ููุงูุต.`;
        } else {
          response = `ุนุฐุฑุงู ูุง ${uName}ุ ูู ุฃููู ุทูุจู ุชูุงูุงู. ููููู ููู: "ูู ุนุฏุฏ w334" ุฃู "ุงุนุฑุถ ุงูููุงูุต".`;
        }
      }

      speak(response);
      addMsg('ai', response, data);
    }

    // -------------------------
    // 7) ุงูุดุงุช ูุงูุนุฑุถ
    // -------------------------
    function escapeHtml(s) {
      return String(s ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function addMsg(sender, text, data = []) {
      const box = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

      let html = `<div class="max-w-[85%] p-3 rounded-2xl ${sender === 'user' ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
        <p class="text-sm md:text-base leading-relaxed">${escapeHtml(text)}</p>`;

      if (data.length) {
        html += `<div class="mt-2 grid grid-cols-2 gap-2">`;
        data.forEach(i => {
          html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded border border-gray-100 dark:border-gray-500 text-center">
            <img src="${escapeHtml(i.img)}" class="w-full h-16 object-cover rounded mb-1 bg-gray-100">
            <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model || "").toUpperCase())}</div>
            <div class="text-[11px] text-gray-500 dark:text-gray-200 mb-1">${escapeHtml(String(i.type || ""))}</div>
            <div class="text-green-600 font-bold">${escapeHtml(String(i.count ?? ""))}</div>
          </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const tx = db.transaction("chats", "readwrite");
      tx.objectStore("chats").add({ sender, text, data, time: new Date().toISOString() });
    }

    function loadChatHistory() {
      if (!db) return;
      const tx = db.transaction("chats", "readonly");
      tx.objectStore("chats").getAll().onsuccess = (e) => {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        (e.target.result || []).forEach(msg => {
          addMsg(msg.sender, msg.text, msg.data);
        });
      };
    }

    function clearChat() {
      const tx = db.transaction("chats", "readwrite");
      tx.objectStore("chats").clear();
      document.getElementById('chat-box').innerHTML = '';
      const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
      speak(`ุชู ูุณุญ ุงููุญุงุฏุซุฉ ุจูุงุกู ุนูู ุทูุจู ูุง ${uName}.`);
    }

    // -------------------------
    // 8) ุฏูุงู ุงููุฎุฒูู (CRUD)
    // -------------------------
    async function getAll() {
      return new Promise(r => {
        db.transaction("inventory", "readonly").objectStore("inventory").getAll().onsuccess = e => r(e.target.result || []);
      });
    }

    async function renderInventory() {
      const items = await getAll();
      const search = normalizeArabic(document.getElementById('inventory-search').value);
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';

      const filtered = items.filter(i => {
        const model = normalizeArabic(i.model);
        const type = normalizeArabic(i.type);
        return !search || model.includes(search) || type.includes(search);
      });

      filtered.forEach(i => {
        const isLow = (Number(i.count) || 0) < 5;
        grid.innerHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-3 relative border-t-4 ${isLow ? 'border-red-500' : 'border-green-500'}">
            <img src="${escapeHtml(i.img)}" class="w-full h-24 object-cover rounded bg-gray-100 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model).toUpperCase())}</h3>
                <p class="text-xs text-gray-500">${escapeHtml(String(i.type))}</p>
              </div>
              <span class="text-lg font-bold text-primary">${escapeHtml(String(i.count))}</span>
            </div>
            ${currentUser.role !== 'viewer' ? `
              <div class="mt-2 flex justify-end gap-2 border-t pt-2 dark:border-gray-700">
                <button onclick="editItem('${escapeHtml(i.model)}')" class="text-blue-500 text-sm"><i class="fas fa-edit"></i></button>
                ${currentUser.role === 'admin' ? `<button onclick="delItem('${escapeHtml(i.model)}')" class="text-red-500 text-sm"><i class="fas fa-trash"></i></button>` : ''}
              </div>
            ` : ''}
          </div>`;
      });
    }

    function openAddModal() {
      document.getElementById('m-model').value = "";
      document.getElementById('m-count').value = "";
      document.getElementById('m-img').value = "";
      document.getElementById('modal-form').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modal-form').classList.add('hidden'); }

    function saveItem() {
      const model = (document.getElementById('m-model').value || "").trim().toLowerCase();
      const type = document.getElementById('m-type').value;
      const count = parseInt(document.getElementById('m-count').value, 10);
      const imgInput = document.getElementById('m-img');

      if (!model || Number.isNaN(count)) return alert("ุงูุจูุงูุงุช ูุงูุตุฉ");

      const reader = new FileReader();
      reader.onload = e => {
        const img = imgInput.files[0] ? e.target.result : `https://placehold.co/150/png?text=${encodeURIComponent(model.toUpperCase())}`;
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").put({ model, type, count, img });
        tx.oncomplete = () => { 
          closeModal(); 
          renderInventory(); 
          updateStats(); 
          const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
          speak(`ุชู ุงูุญูุธ ุจูุฌุงุญ ูุง ${uName}.`); 
        };
      };

      if (imgInput.files[0]) reader.readAsDataURL(imgInput.files[0]);
      else reader.onload({ target: { result: null } });
    }

    function delItem(model) {
      if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ")) {
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").delete(model);
        tx.oncomplete = () => { 
          renderInventory(); 
          updateStats(); 
          const uName = currentUser ? `ุฃุณุชุงุฐ ${currentUser.name}` : "ูุง ุฃุณุชุงุฐ";
          speak(`ุชู ุญุฐู ุงูุนูุตุฑ ูุง ${uName}.`); 
        };
      }
    }

    function editItem(model) {
      db.transaction("inventory").objectStore("inventory").get(model).onsuccess = e => {
        const i = e.target.result;
        document.getElementById('m-model').value = i.model;
        document.getElementById('m-type').value = i.type;
        document.getElementById('m-count').value = i.count;
        document.getElementById('modal-form').classList.remove('hidden');
      };
    }

    // -------------------------
    // 9) ุงูุฅุญุตุงุฆูุงุช ูุงูุชุตุฏูุฑ
    // -------------------------
    async function updateStats() {
      const items = await getAll();
      const types = {};
      const low = [];

      items.forEach(i => {
        const t = i.type || "ุบูุฑ ูุตูู";
        types[t] = (types[t] || 0) + (Number(i.count) || 0);
        if ((Number(i.count) || 0) < 5) low.push(i);
      });

      const canvas = document.getElementById('typeChart');
      if (canvas) {
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: Object.keys(types),
            datasets: [{ data: Object.values(types), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#ef4444'] }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      const alerts = document.getElementById('stock-alerts');
      if (!alerts) return;
      alerts.innerHTML = low.length ? '' : '<p class="text-green-500 text-sm">ุงููุฎุฒูู ููุชุงุฒ</p>';
      low.forEach(i => {
        alerts.innerHTML += `<div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded text-sm">
          <span>${escapeHtml(i.model)}</span><b>${escapeHtml(String(i.count))}</b>
        </div>`;
      });
    }

    async function exportExcel() {
      const items = await getAll();
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Inventory");
      XLSX.writeFile(wb, "Warehouse.xlsx");
    }

    function exportChatPDF() {
      html2canvas(document.getElementById('chat-box')).then(c => {
        const pdf = new window.jspdf.jsPDF();
        const imgData = c.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("chat.pdf");
      });
    }

    function shareWhatsApp() {
      window.open("https://wa.me/?text=" + encodeURIComponent("ุชูุฑูุฑ ุงููุณุชูุฏุน ุฌุงูุฒ"), '_blank');
    }
  </script>
</body>
</html>


