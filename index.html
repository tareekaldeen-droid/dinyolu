<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ Pro V7 (Updated)</title>

  <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#2563eb', secondary: '#10b981', dark: '#1e293b' },
          height: { 'screen-dvh': '100dvh' }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    body { font-family: 'Tajawal', sans-serif; overflow: hidden; touch-action: manipulation; }

    .mic-active { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .fade-in { animation: fadeIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen-dvh w-full flex flex-col">

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-[90%] max-w-md text-center">
      <div class="mb-6 bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-primary">
        <i class="fas fa-boxes text-4xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h2>
      <p class="text-gray-500 mb-6 text-sm">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>

      <div class="space-y-4">
        <select id="user-select" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
          <option value="1">ğŸ‘¤ Ø­Ø³Ù† (Ù…Ø³Ø¤ÙˆÙ„ - Admin)</option>
          <option value="2">ğŸ‘€ Ù…Ø¹ØªØ² (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</option>
          <option value="3">ğŸ“¦ Ù…Ø­Ù…Ø¯ (Ù…Ø¯ÙŠØ± Ù…Ø³ØªÙˆØ¯Ø¹)</option>
        </select>
        <input type="password" id="password-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (123)" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
        <button onclick="login()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>
      </div>
      <p id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold animate-bounce">âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>

      <div class="mt-6 text-xs text-gray-500 leading-relaxed">
        <b>Ù…Ù‡Ù…:</b> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙŠØ­ØªØ§Ø¬ HTTPS Ø£Ùˆ localhost. Ø¹Ù„Ù‰ iPhone/Safari Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ.
      </div>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div id="app-interface" class="flex h-full w-full hidden relative">

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (PC) -->
    <aside class="hidden lg:flex w-72 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-col shadow-xl z-20">
      <div class="p-6 border-b dark:border-gray-700 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg"><i class="fas fa-user"></i></div>
        <div>
          <h3 id="user-greeting-pc" class="font-bold text-gray-800 dark:text-white">Ù…Ø±Ø­Ø¨Ø§Ù‹</h3>
          <p id="user-role-pc" class="text-xs text-gray-500 dark:text-gray-400"></p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="switchTab('chat')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-comments text-blue-500 text-xl w-6"></i> Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©
        </button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-boxes text-green-500 text-xl w-6"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        </button>
        <button onclick="switchTab('stats')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-chart-pie text-purple-500 text-xl w-6"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        </button>
      </nav>

      <div class="p-4 border-t dark:border-gray-700 space-y-2">
        <button onclick="openSettings()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span><i class="fas fa-sliders text-gray-500"></i>
        </button>
        <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span><i class="fas fa-moon text-yellow-500"></i>
        </button>
        <button onclick="logout()" class="w-full bg-red-100 text-red-600 hover:bg-red-200 py-3 rounded-xl font-bold transition">
          <i class="fas fa-sign-out-alt ml-2"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </aside>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-100 dark:bg-gray-900">

      <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© (Mobile) -->
      <header class="lg:hidden bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center z-10 h-16 shrink-0">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm"><i class="fas fa-user"></i></div>
          <span id="user-greeting-mobile" class="font-bold text-sm">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
        </div>
        <div class="flex gap-3">
          <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-sliders text-gray-600 dark:text-gray-200"></i>
          </button>
          <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-moon text-yellow-500"></i>
          </button>
          <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden relative w-full">

        <!-- 1. Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <section id="tab-chat" class="h-full flex flex-col w-full">
          <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 lg:pb-4"></div>

          <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3 lg:p-4 shadow-lg z-20 shrink-0">
            <div class="flex justify-center gap-4 mb-3 text-xs overflow-x-auto pb-1">
              <button onclick="clearChat()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-trash"></i> Ù…Ø³Ø­
              </button>
              <button onclick="exportChatPDF()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-blue-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="shareWhatsApp()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-green-100 text-gray-600 dark:text-gray-300">
                <i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
              </button>
              <button onclick="openSettings()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 text-gray-600 dark:text-gray-300">
                <i class="fas fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
              </button>
            </div>

            <div class="max-w-3xl mx-auto">
              <div class="flex items-center gap-2">
                <!-- Ø¥ØµÙ„Ø§Ø­: Ø²Ø± ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø¯Ù„ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„ -->
                <button id="mic-btn" onclick="toggleListening()"
                  class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-white flex items-center justify-center hover:bg-gray-300 transition shadow-sm active:scale-90">
                  <i class="fas fa-microphone text-xl"></i>
                </button>

                <input type="text" id="chat-input"
                  placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø«Ù… ØªÙƒÙ„Ù…..."
                  class="flex-1 h-12 px-4 rounded-full bg-gray-100 dark:bg-gray-900 border-none focus:ring-2 focus:ring-primary outline-none transition"
                  onkeypress="handleEnter(event)" />

                <button onclick="processInput()" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center hover:bg-blue-600 transition shadow-md active:scale-90">
                  <i class="fas fa-paper-plane text-lg"></i>
                </button>
              </div>

              <!-- Ø³Ø·Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† -->
              <div id="mic-status" class="mt-2 text-xs text-gray-500 dark:text-gray-300 text-center"></div>
            </div>
          </div>
        </section>

        <!-- 2. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
        <section id="tab-inventory" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2">
            <h2 class="text-xl font-bold">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
            <div class="flex gap-2">
              <button onclick="exportExcel()" class="bg-green-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-file-excel"></i></button>
              <button id="btn-add-modal" onclick="openAddModal()" class="bg-blue-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center"><i class="fas fa-plus"></i></button>
            </div>
          </div>
          <div class="relative mb-4">
            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            <input type="text" id="inventory-search" onkeyup="renderInventory()" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ù†ÙˆØ¹..."
              class="w-full p-3 pr-10 rounded-xl border-none shadow-sm dark:bg-gray-800" />
          </div>
          <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </section>

        <!-- 3. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <section id="tab-stats" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-xl font-bold mb-4">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
              <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</h3>
              <div id="stock-alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </section>

      </div>

      <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ (Mobile) -->
      <nav class="lg:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center h-16 shrink-0 z-30 pb-safe">
        <button onclick="switchTab('chat')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-primary">
          <i class="fas fa-comments text-xl mb-1"></i><span class="text-xs font-medium">Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-boxes text-xl mb-1"></i><span class="text-xs font-medium">Ù…Ø®Ø²ÙˆÙ†</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-xs font-medium">Ø¥Ø­ØµØ§Ø¡</span>
        </button>
      </nav>

    </main>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©: Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬ -->
  <div id="modal-form" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-all scale-100">
      <h3 class="text-xl font-bold mb-4 text-center">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬</h3>
      <div class="space-y-3">
        <input type="text" id="m-model" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Ù…Ø«Ø§Ù„ w334)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <select id="m-type" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
          <option value="Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·">Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·</option>
          <option value="Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†">Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†</option>
          <option value="Ø¯Ø±Ø³ÙˆØ§Ø±">Ø¯Ø±Ø³ÙˆØ§Ø±</option>
        </select>
        <input type="number" id="m-count" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative">
          <input type="file" id="m-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
          <p class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
        <button onclick="saveItem()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù†Ø¨Ø±Ø© ÙÙ‚Ø·) -->
  <div id="settings-modal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <button onclick="closeSettings()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="bg-gray-50 dark:bg-gray-900/40 rounded-xl p-4">
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
          Ø§Ù„ØªØ­ÙƒÙ… Ù‡Ù†Ø§ ÙÙŠ <b>Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª ÙÙ‚Ø·</b> (Pitch).
        </p>

        <label class="text-sm font-bold block mb-2">Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª</label>
        <div class="flex items-center gap-3">
          <input id="pitch-slider" type="range" min="0.6" max="1.6" step="0.05"
                 class="w-full accent-blue-600" oninput="onPitchChange(this.value)">
          <div class="w-16 text-center bg-white dark:bg-gray-800 rounded-lg py-2 text-sm font-bold">
            <span id="pitch-value">1.00</span>
          </div>
        </div>

        <div class="flex gap-3 mt-4">
          <button onclick="testVoice()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 rounded-xl font-bold">ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØµÙˆØª</button>
          <button onclick="resetPitch()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>

        <div class="mt-4 text-xs text-gray-500 dark:text-gray-300 leading-relaxed">
          <b>Ø­Ù„ Ø³Ø±ÙŠØ¹ Ù„Ùˆ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ø§ ÙŠØ¹Ù…Ù„:</b> Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± HTTPSØŒ Ø«Ù… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ù…ÙˆÙ‚Ø¹.
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // 1) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
    // -------------------------
    const USERS = {
      1: { name: "Ø­Ø³Ù†", role: "admin", pass: "123", label: "Ù…Ø³Ø¤ÙˆÙ„" },
      2: { name: "Ù…Ø¹ØªØ²", role: "viewer", pass: "123", label: "Ù…Ø´Ø§Ù‡Ø¯" },
      3: { name: "Ù…Ø­Ù…Ø¯", role: "manager", pass: "123", label: "Ù…Ø¯ÙŠØ±" }
    };

    let currentUser = null;
    let db;
    let chartInstance = null;

    // -------------------------
    // 2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª (Pitch ÙÙ‚Ø·)
    // -------------------------
    const synth = window.speechSynthesis;
    const VOICE_SETTINGS_KEY = "warehouse_voice_settings_v1";
    const voiceSettings = { pitch: 1.0 };

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function loadVoiceSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem(VOICE_SETTINGS_KEY) || "{}");
        if (typeof saved.pitch === "number") voiceSettings.pitch = clamp(saved.pitch, 0.6, 1.6);
      } catch (_) {}
      updatePitchUI();
    }

    function saveVoiceSettings() {
      localStorage.setItem(VOICE_SETTINGS_KEY, JSON.stringify({ pitch: voiceSettings.pitch }));
    }

    function openSettings() {
      updatePitchUI();
      document.getElementById('settings-modal').classList.remove('hidden');
    }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

    function updatePitchUI() {
      const slider = document.getElementById('pitch-slider');
      const label = document.getElementById('pitch-value');
      if (!slider || !label) return;
      slider.value = String(voiceSettings.pitch);
      label.innerText = voiceSettings.pitch.toFixed(2);
    }

    function onPitchChange(v) {
      voiceSettings.pitch = clamp(parseFloat(v), 0.6, 1.6);
      document.getElementById('pitch-value').innerText = voiceSettings.pitch.toFixed(2);
      saveVoiceSettings();
    }

    function resetPitch() {
      voiceSettings.pitch = 1.0;
      updatePitchUI();
      saveVoiceSettings();
      speak("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª.");
    }

    function testVoice() {
      speak("Ù‡Ø°Ù‡ ØªØ¬Ø±Ø¨Ø© Ù„Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      try {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(String(text || ""));
        u.lang = 'ar-SA';
        u.pitch = voiceSettings.pitch; // ÙÙ‚Ø·
        u.rate = 1.0;
        u.volume = 1.0;
        synth.speak(u);
      } catch (_) {}
    }

    // -------------------------
    // 3) Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // -------------------------
    const request = indexedDB.open("WarehouseV7_MicFixed", 1);
    request.onupgradeneeded = (e) => {
      db = e.target.result;

      if (!db.objectStoreNames.contains('inventory')) {
        const store = db.createObjectStore('inventory', { keyPath: "model" });
        store.add({ model: "w334", type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", count: 15, img: "https://placehold.co/150/png?text=W334" });
        store.add({ model: "tv500", type: "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", count: 5, img: "https://placehold.co/150/png?text=TV500" });
        store.add({ model: "ds120", type: "Ø¯Ø±Ø³ÙˆØ§Ø±", count: 3, img: "https://placehold.co/150/png?text=DS120" });
      }
      if (!db.objectStoreNames.contains('chats')) {
        db.createObjectStore('chats', { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = (e) => { db = e.target.result; loadVoiceSettings(); loadChatHistory(); };

    // -------------------------
    // 4) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / ØªÙ†Ù‚Ù„
    // -------------------------
    function login() {
      const id = document.getElementById('user-select').value;
      const pass = document.getElementById('password-input').value;

      if (USERS[id] && USERS[id].pass === pass) {
        currentUser = { ...USERS[id], id: parseInt(id) };

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-interface').classList.remove('hidden');
        document.getElementById('app-interface').classList.add('flex');

        document.getElementById('user-greeting-pc').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø£Ø³ØªØ§Ø° ${currentUser.name}`;
        document.getElementById('user-role-pc').innerText = currentUser.label;
        document.getElementById('user-greeting-mobile').innerText = `Ø£Ø³ØªØ§Ø° ${currentUser.name}`;

        if (currentUser.role === 'viewer') document.getElementById('btn-add-modal').classList.add('hidden');

        renderInventory();
        updateStats();
        initSpeech();

        speak(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø³ØªØ§Ø° ${currentUser.name}ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø².`);
        setMicStatus(getMicSupportMessage(), false);
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    function logout() { location.reload(); }

    function switchTab(tabId) {
      ['chat', 'inventory', 'stats'].forEach(id => document.getElementById(`tab-${id}`).classList.add('hidden'));
      const activeSection = document.getElementById(`tab-${tabId}`);
      activeSection.classList.remove('hidden');
      activeSection.classList.add('flex');
      if (tabId === 'stats') updateStats();
    }

    function toggleTheme() { document.documentElement.classList.toggle('dark'); }

    // -------------------------
    // 5) Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Recognition)
    // -------------------------
    let recognition = null;
    let isListening = false;
    let stopRequested = false;

    function isSecureContextForMic() {
      return window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1";
    }

    function hasSpeechRecognition() {
      return ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
    }

    function isLikelySafari() {
      const ua = navigator.userAgent.toLowerCase();
      const isSafari = ua.includes("safari") && !ua.includes("chrome") && !ua.includes("crios") && !ua.includes("android");
      return isSafari;
    }

    function getMicSupportMessage() {
      if (!isSecureContextForMic()) return "Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙŠØ­ØªØ§Ø¬ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± HTTPS Ø£Ùˆ localhost.";
      if (isLikelySafari() && !hasSpeechRecognition()) return "Safari ØºØ§Ù„Ø¨Ø§Ù‹ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ (Web Speech). Ø¬Ø±Ù‘Ø¨ Chrome/Edge.";
      if (!hasSpeechRecognition()) return "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ. Ø¬Ø±Ù‘Ø¨ Chrome/Edge.";
      return "Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„ØªØ­Ø¯Ø«.";
    }

    function setMicStatus(msg, danger=false) {
      const el = document.getElementById("mic-status");
      if (!el) return;
      el.textContent = msg || "";
      el.className = "mt-2 text-xs text-center " + (danger ? "text-red-500" : "text-gray-500 dark:text-gray-300");
    }

    async function ensureMicPermission() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error("getUserMedia ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
      }
      // ÙŠØ·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† (Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ØªØ±ÙŠÙ…)
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
      return true;
    }

    function initSpeech() {
      // Ù„Ø§ ØªØ¬Ù‡Ø² Ø¹Ù„Ù‰ Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
      if (!hasSpeechRecognition()) return;

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        isListening = true;
        stopRequested = false;
        document.getElementById('mic-btn').classList.add('mic-active');
        setMicStatus("ÙŠØ³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†... ØªÙƒÙ„Ù… Ø¨ÙˆØ¶ÙˆØ­.", false);
      };

      recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;

        // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Ø¥ÙŠÙ‚Ø§Ù Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„
        if (stopRequested) {
          setMicStatus("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹.", false);
          return;
        }
        // Ù„Ùˆ Ø§Ù†ØªÙ‡Ù‰ Ø¨Ø¯ÙˆÙ† Ù†ØªÙŠØ¬Ø©ØŒ Ø£Ø¹Ø·ÙŠ Ø±Ø³Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©
        setMicStatus("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹. Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", false);
      };

      recognition.onerror = (event) => {
        document.getElementById('mic-btn').classList.remove('mic-active');
        isListening = false;

        const code = event.error || "";
        if (code === "not-allowed" || code === "service-not-allowed") {
          setMicStatus("ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ù…ÙˆÙ‚Ø¹.", true);
        } else if (code === "no-speech") {
          setMicStatus("Ù„Ù… Ø£Ø³Ù…Ø¹ ØµÙˆØªØ§Ù‹. Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­Ø¯Ø« Ø£Ù‚Ø±Ø¨ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.", true);
        } else if (code === "audio-capture") {
          setMicStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªØ§Ø­ Ø£Ùˆ Ù…Ø´ØºÙˆÙ„ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±.", true);
        } else if (code === "network") {
          setMicStatus("Ø®Ø·Ø£ Ø´Ø¨ÙƒØ© ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ. Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.", true);
        } else {
          setMicStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + code, true);
        }
      };

      recognition.onresult = (event) => {
        const text = event.results?.[0]?.[0]?.transcript || "";
        if (!text.trim()) return;
        document.getElementById('chat-input').value = text;
        processInput(text);
      };
    }

    async function toggleListening() {
      if (!isSecureContextForMic()) {
        setMicStatus("Ù„Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¹Ù„Ù‰ HTTP. Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS.", true);
        return;
      }
      if (!hasSpeechRecognition()) {
        setMicStatus(getMicSupportMessage(), true);
        return;
      }
      if (!recognition) initSpeech();

      if (isListening) {
        stopRequested = true;
        try { recognition.stop(); } catch(_) {}
        return;
      }

      // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹: Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø£ÙˆÙ„Ø§Ù‹
      try {
        await ensureMicPermission();
      } catch (e) {
        setMicStatus("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + (e?.message || "Ø®Ø·Ø£"), true);
        return;
      }

      // Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ø±Ù
      try {
        recognition.start();
      } catch (e) {
        // Ø®Ø·Ø£ Ø´Ø§Ø¦Ø¹: start called twice
        setMicStatus("ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
      }
    }

    // -------------------------
    // 6) Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¨Ø³ÙŠØ·)
    // -------------------------
    function handleEnter(e) { if (e.key === 'Enter') processInput(); }

    function normalizeArabic(s) {
      if (!s) return "";
      return s.toString().toLowerCase()
        .replace(/[\u064B-\u0652]/g, "")
        .replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§")
        .replace(/Ù‰/g, "ÙŠ")
        .replace(/Ø¤/g, "Ùˆ")
        .replace(/Ø¦/g, "ÙŠ")
        .replace(/Ø©/g, "Ù‡")
        .replace(/Ù€/g, "")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function extractModels(raw) {
      const m = raw.match(/[a-z]{1,5}\d{1,6}/gi);
      return m ? [...new Set(m.map(x => x.toLowerCase()))] : [];
    }

    function bestTypeFromText(textNorm) {
      const map = [
        { type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", keys: ["Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", "Ø·Ø§ÙˆÙ„Ù‡ ÙˆØ³Ø·", "ÙˆØ³Ø·"] },
        { type: "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", keys: ["Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", "Ø·Ø§ÙˆÙ„Ù‡ ØªÙ„ÙØ²ÙŠÙˆÙ†", "ØªÙ„ÙØ²ÙŠÙˆÙ†", "ØªÙŠ ÙÙŠ", "tv"] },
        { type: "Ø¯Ø±Ø³ÙˆØ§Ø±", keys: ["Ø¯Ø±Ø³ÙˆØ§Ø±", "Ø¯Ø±ÙŠØ³ÙˆØ§Ø±", "ØªØ³Ø±ÙŠØ­Ù‡", "ÙƒÙˆÙ†Ø³ÙˆÙ„"] }
      ];
      for (const row of map) {
        if (row.keys.map(normalizeArabic).some(k => textNorm.includes(k))) return row.type;
      }
      return null;
    }

    async function processInput(forcedText = null) {
      const input = document.getElementById('chat-input');
      const text = forcedText || input.value.trim();
      if (!text) return;

      addMsg('user', text);
      input.value = '';

      const textNorm = normalizeArabic(text);
      const allItems = await getAll();

      const wantsAll = ["Ø§Ù„ÙƒÙ„","Ø¬Ø±Ø¯","Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"].some(k => textNorm.includes(normalizeArabic(k)));
      const wantsLow = ["Ù†Ø§Ù‚Øµ","Ù†ÙˆØ§Ù‚Øµ","ØªÙ†Ø¨ÙŠÙ‡"].some(k => textNorm.includes(normalizeArabic(k)));
      const asksCount = ["ÙƒÙ…","Ø¹Ø¯Ø¯","Ø§Ù„Ø¹Ø¯Ø¯","ÙƒÙ…ÙŠØ©","ÙƒÙ…ÙŠÙ‡"].some(k => textNorm.includes(normalizeArabic(k)));

      const modelsFound = extractModels(textNorm);
      const typeFound = bestTypeFromText(textNorm);

      let response = "";
      let data = [];

      // ----------------------------------------------------
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø§ØµØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      // ----------------------------------------------------
      if (textNorm.includes("Ù…Ø±Ø­Ø¨Ø§") || textNorm.includes("Ø§Ù‡Ù„Ø§")) {
        response = "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ";
      }
      else if (textNorm.includes("Ù…Ù† ØµÙ†Ø¹Ùƒ") || textNorm.includes("Ù…ÙŠÙ† Ø¹Ù…Ù„Ùƒ") || textNorm.includes("Ù…ÙŠÙ† Ø¨Ø±Ù…Ø¬Ùƒ")) {
        response = "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¹ØªØ² Ø¨Ø§Ù„Ù„Ù‡ Ø­Ø§Ø¬ Ø´Ø¹Ø¨Ø§Ù† Ù…Ù† ÙˆØ§Ùˆ Ù…ÙˆØ¨ÙŠÙ„ÙŠØ§";
      }
      // ----------------------------------------------------
      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      // ----------------------------------------------------
      else if (modelsFound.length) {
        data = allItems.filter(i => modelsFound.includes((i.model || "").toLowerCase()));
        if (data.length) {
          if (asksCount && data.length === 1) response = `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${data[0].model.toUpperCase()} Ø¹Ø¯Ø¯Ù‡ ${data[0].count}.`;
          else response = `ÙˆØ¬Ø¯Øª ${data.length} Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:`;
        } else {
          response = `Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
        }
      } else if (typeFound) {
        data = allItems.filter(i => i.type === typeFound);
        if (data.length) {
          const total = data.reduce((s,x) => s + (Number(x.count) || 0), 0);
          response = asksCount ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ "${typeFound}" Ù‡Ùˆ ${total}.` : `Ù‡Ø°Ù‡ Ù…Ù†ØªØ¬Ø§Øª "${typeFound}":`;
        } else response = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù†ÙˆØ¹ "${typeFound}".`;
      } else if (wantsAll) {
        data = allItems;
        response = `Ù„Ø¯ÙŠÙƒ ${data.length} ØµÙ†Ù ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.`;
      } else if (wantsLow) {
        data = allItems.filter(i => (Number(i.count) || 0) < 5);
        response = data.length ? `ÙŠÙˆØ¬Ø¯ ${data.length} ØµÙ†Ù Ù†Ø§Ù‚Øµ (Ø£Ù‚Ù„ Ù…Ù† 5).` : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ Ø­Ø§Ù„ÙŠØ§Ù‹.`;
      } else {
        response = `Ù„Ù… Ø£ÙÙ‡Ù…. Ø¬Ø±Ù‘Ø¨: "ÙƒÙ… w334" Ø£Ùˆ "Ù†ÙˆØ§Ù‚Øµ" Ø£Ùˆ "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·".`;
      }

      speak(response);
      addMsg('ai', response, data);
    }

    // -------------------------
    // 7) Ø§Ù„Ø´Ø§Øª + ØªØ®Ø²ÙŠÙ†Ù‡
    // -------------------------
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(s) { return escapeHtml(s); }

    function addMsg(sender, text, data = []) {
      const box = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

      let html = `<div class="max-w-[85%] p-3 rounded-2xl ${sender === 'user' ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
        <p class="text-sm md:text-base leading-relaxed">${escapeHtml(text)}</p>`;

      if (data.length) {
        html += `<div class="mt-2 grid grid-cols-2 gap-2">`;
        data.forEach(i => {
          html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded border border-gray-100 dark:border-gray-500 text-center">
            <img src="${escapeAttr(i.img)}" class="w-full h-16 object-cover rounded mb-1 bg-gray-100">
            <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model || "").toUpperCase())}</div>
            <div class="text-[11px] text-gray-500 dark:text-gray-200 mb-1">${escapeHtml(String(i.type || ""))}</div>
            <div class="text-green-600 font-bold">${escapeHtml(String(i.count ?? ""))}</div>
          </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const tx = db.transaction("chats", "readwrite");
      tx.objectStore("chats").add({ sender, text, data, time: new Date().toISOString() });
    }

    function loadChatHistory() {
      if (!db) return;
      const tx = db.transaction("chats", "readonly");
      tx.objectStore("chats").getAll().onsuccess = (e) => {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        (e.target.result || []).forEach(msg => {
          const div = document.createElement('div');
          div.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
          div.innerHTML = `<div class="max-w-[85%] p-3 rounded-2xl ${msg.sender === 'user' ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
            <p class="text-sm md:text-base leading-relaxed">${escapeHtml(msg.text)}</p>
          </div>`;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      };
    }

    function clearChat() {
      const tx = db.transaction("chats", "readwrite");
      tx.objectStore("chats").clear();
      document.getElementById('chat-box').innerHTML = '';
      speak("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.");
    }

    // -------------------------
    // 8) Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    // -------------------------
    async function getAll() {
      return new Promise(r => {
        db.transaction("inventory", "readonly").objectStore("inventory").getAll().onsuccess = e => r(e.target.result || []);
      });
    }

    async function renderInventory() {
      const items = await getAll();
      const search = normalizeArabic(document.getElementById('inventory-search').value);
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';

      const filtered = items.filter(i => {
        const model = normalizeArabic(i.model);
        const type = normalizeArabic(i.type);
        return !search || model.includes(search) || type.includes(search);
      });

      filtered.forEach(i => {
        const isLow = (Number(i.count) || 0) < 5;
        grid.innerHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-3 relative border-t-4 ${isLow ? 'border-red-500' : 'border-green-500'}">
            <img src="${escapeAttr(i.img)}" class="w-full h-24 object-cover rounded bg-gray-100 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-gray-800 dark:text-white">${escapeHtml(String(i.model).toUpperCase())}</h3>
                <p class="text-xs text-gray-500">${escapeHtml(String(i.type))}</p>
              </div>
              <span class="text-lg font-bold text-primary">${escapeHtml(String(i.count))}</span>
            </div>

            ${currentUser.role !== 'viewer' ? `
              <div class="mt-2 flex justify-end gap-2 border-t pt-2 dark:border-gray-700">
                <button onclick="editItem('${escapeAttr(i.model)}')" class="text-blue-500 text-sm"><i class="fas fa-edit"></i></button>
                ${currentUser.role === 'admin' ? `<button onclick="delItem('${escapeAttr(i.model)}')" class="text-red-500 text-sm"><i class="fas fa-trash"></i></button>` : ''}
              </div>
            ` : ''}
          </div>`;
      });
    }

    function openAddModal() {
      document.getElementById('m-model').value = "";
      document.getElementById('m-count').value = "";
      document.getElementById('m-img').value = "";
      document.getElementById('modal-form').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modal-form').classList.add('hidden'); }

    function saveItem() {
      const model = (document.getElementById('m-model').value || "").trim().toLowerCase();
      const type = document.getElementById('m-type').value;
      const count = parseInt(document.getElementById('m-count').value, 10);
      const imgInput = document.getElementById('m-img');

      if (!model || Number.isNaN(count)) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

      const reader = new FileReader();
      reader.onload = e => {
        const img = imgInput.files[0] ? e.target.result : `https://placehold.co/150/png?text=${encodeURIComponent(model.toUpperCase())}`;
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").put({ model, type, count, img });
        tx.oncomplete = () => { closeModal(); renderInventory(); updateStats(); speak("ØªÙ… Ø§Ù„Ø­ÙØ¸."); };
      };

      if (imgInput.files[0]) reader.readAsDataURL(imgInput.files[0]);
      else reader.onload({ target: { result: null } });
    }

    function delItem(model) {
      if (confirm("Ø­Ø°ÙØŸ")) {
        const tx = db.transaction("inventory", "readwrite");
        tx.objectStore("inventory").delete(model);
        tx.oncomplete = () => { renderInventory(); updateStats(); speak("ØªÙ… Ø§Ù„Ø­Ø°Ù."); };
      }
    }

    function editItem(model) {
      db.transaction("inventory").objectStore("inventory").get(model).onsuccess = e => {
        const i = e.target.result;
        document.getElementById('m-model').value = i.model;
        document.getElementById('m-type').value = i.type;
        document.getElementById('m-count').value = i.count;
        document.getElementById('m-img').value = "";
        document.getElementById('modal-form').classList.remove('hidden');
      };
    }

    // -------------------------
    // 9) Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª + Ø§Ù„ØªØµØ¯ÙŠØ±
    // -------------------------
    async function updateStats() {
      const items = await getAll();
      const types = {};
      const low = [];

      items.forEach(i => {
        const t = i.type || "ØºÙŠØ± Ù…ØµÙ†Ù";
        types[t] = (types[t] || 0) + (Number(i.count) || 0);
        if ((Number(i.count) || 0) < 5) low.push(i);
      });

      const canvas = document.getElementById('typeChart');
      if (canvas) {
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: Object.keys(types),
            datasets: [{ data: Object.values(types), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#ef4444'] }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      const alerts = document.getElementById('stock-alerts');
      if (!alerts) return;
      alerts.innerHTML = low.length ? '' : '<p class="text-green-500 text-sm">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù…ØªØ§Ø²</p>';
      low.forEach(i => {
        alerts.innerHTML += `<div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded text-sm">
          <span>${escapeHtml(i.model)}</span><b>${escapeHtml(String(i.count))}</b>
        </div>`;
      });
    }

    async function exportExcel() {
      const items = await getAll();
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Inventory");
      XLSX.writeFile(wb, "Warehouse.xlsx");
    }

    function exportChatPDF() {
      html2canvas(document.getElementById('chat-box')).then(c => {
        const pdf = new window.jspdf.jsPDF();
        const imgData = c.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("chat.pdf");
      });
    }

    function shareWhatsApp() {
      window.open("https://wa.me/?text=" + encodeURIComponent("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø§Ù‡Ø²"), '_blank');
    }
  </script>
</body>
</html>
