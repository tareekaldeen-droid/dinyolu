<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ Pro V8 (Smart + Fixed Mic)</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#2563eb', secondary: '#10b981', dark: '#1e293b' },
          height: { 'screen-dvh': '100dvh' }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    body { font-family: 'Tajawal', sans-serif; overflow: hidden; touch-action: manipulation; }

    .mic-active { animation: pulse-red 1.2s infinite; background-color: #ef4444 !important; color: white !important; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.65); }
      70% { box-shadow: 0 0 0 14px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .animate-fade-in { animation: fadeIn 220ms ease-out; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:translateY(0)} }

    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .65rem; border-radius:9999px; font-size:.75rem; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen-dvh w-full flex flex-col">

  <!-- Login -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-[90%] max-w-md text-center">
      <div class="mb-6 bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-primary">
        <i class="fas fa-boxes text-4xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h2>
      <p class="text-gray-500 mb-6 text-sm">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>

      <div class="space-y-4">
        <select id="user-select" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
          <option value="1">ğŸ‘¤ Ø­Ø³Ù† (Ù…Ø³Ø¤ÙˆÙ„ - Admin)</option>
          <option value="2">ğŸ‘€ Ù…Ø¹ØªØ² (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</option>
          <option value="3">ğŸ“¦ Ù…Ø­Ù…Ø¯ (Ù…Ø¯ÙŠØ± Ù…Ø³ØªÙˆØ¯Ø¹)</option>
        </select>

        <input type="password" id="password-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (123)"
          class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none" />

        <button onclick="login()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>
      </div>

      <div id="env-warning" class="mt-4 text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-xl p-3 hidden text-right">
        <div class="font-bold mb-1">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù… Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
        <div>Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙŠØ¹Ù…Ù„ Ø¹Ø§Ø¯Ø©Ù‹ ÙÙ‚Ø· Ø¹Ù„Ù‰ <b>HTTPS</b> Ø£Ùˆ <b>localhost</b>. Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ/Ø§Ø³ØªØ¶Ø§ÙØ© Ø¢Ù…Ù†Ø©.</div>
      </div>

      <p id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold">âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
  </div>

  <!-- App -->
  <div id="app-interface" class="flex h-full w-full hidden relative">

    <!-- Sidebar (PC) -->
    <aside class="hidden lg:flex w-72 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-col shadow-xl z-20">
      <div class="p-6 border-b dark:border-gray-700 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <h3 id="user-greeting-pc" class="font-bold text-gray-800 dark:text-white">Ù…Ø±Ø­Ø¨Ø§Ù‹</h3>
          <p id="user-role-pc" class="text-xs text-gray-500 dark:text-gray-400"></p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="switchTab('chat')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-comments text-blue-500 text-xl w-6"></i> Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©
        </button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-boxes text-green-500 text-xl w-6"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        </button>
        <button onclick="switchTab('stats')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium">
          <i class="fas fa-chart-pie text-purple-500 text-xl w-6"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        </button>
      </nav>

      <div class="p-4 border-t dark:border-gray-700 space-y-2">
        <button onclick="openSettings()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span><i class="fas fa-sliders text-primary"></i>
        </button>
        <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span><i class="fas fa-moon text-yellow-500"></i>
        </button>
        <button onclick="logout()" class="w-full bg-red-100 text-red-600 hover:bg-red-200 py-3 rounded-xl font-bold transition">
          <i class="fas fa-sign-out-alt ml-2"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-100 dark:bg-gray-900">

      <!-- Header (Mobile) -->
      <header class="lg:hidden bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center z-10 h-16 shrink-0">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm">
            <i class="fas fa-user"></i>
          </div>
          <span id="user-greeting-mobile" class="font-bold text-sm">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
        </div>
        <div class="flex gap-3">
          <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-sliders text-primary"></i>
          </button>
          <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-moon text-yellow-500"></i>
          </button>
          <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden relative w-full">

        <!-- Chat -->
        <section id="tab-chat" class="h-full flex flex-col w-full">
          <div class="px-4 pt-4 pb-2">
            <div class="flex flex-wrap gap-2 items-center">
              <span id="stt-status" class="chip bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-200">
                <i class="fas fa-microphone-slash"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„
              </span>
              <span id="tts-status" class="chip bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-200">
                <i class="fas fa-volume-up"></i> Ø§Ù„ØµÙˆØª: â€”
              </span>
              <span class="chip bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200">
                <i class="fas fa-lightbulb"></i> Ù…Ø«Ø§Ù„: "ÙƒÙ… w334" Ø£Ùˆ "Ù†ÙˆØ§Ù‚Øµ" Ø£Ùˆ "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†"
              </span>
            </div>
          </div>

          <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 lg:pb-4"></div>

          <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3 lg:p-4 shadow-lg z-20 shrink-0">
            <div class="flex justify-center gap-2 mb-3 text-xs overflow-x-auto pb-1">
              <button onclick="clearChat()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-trash"></i> Ù…Ø³Ø­
              </button>
              <button onclick="exportChatPDF()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-blue-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="shareWhatsApp()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-green-100 text-gray-600 dark:text-gray-300">
                <i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
              </button>
              <button onclick="openSettings()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-purple-100 text-gray-600 dark:text-gray-300">
                <i class="fas fa-sliders"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
              </button>
            </div>

            <div class="flex items-center gap-2 max-w-3xl mx-auto">
              <!-- Fixed mic: toggle click -->
              <button id="mic-btn" onclick="toggleListening()"
                class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-white flex items-center justify-center hover:bg-gray-300 transition shadow-sm active:scale-90"
                title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                <i class="fas fa-microphone text-xl"></i>
              </button>

              <input type="text" id="chat-input"
                placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†â€¦"
                class="flex-1 h-12 px-4 rounded-full bg-gray-100 dark:bg-gray-900 border-none focus:ring-2 focus:ring-primary outline-none transition"
                onkeypress="handleEnter(event)" />

              <button onclick="processInput()" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center hover:bg-blue-600 transition shadow-md active:scale-90">
                <i class="fas fa-paper-plane text-lg"></i>
              </button>
            </div>

            <div class="max-w-3xl mx-auto mt-2 text-xs text-gray-500 dark:text-gray-400 leading-5">
              Ø£ÙˆØ§Ù…Ø±: <b>Ø¬Ø±Ø¯</b> â€” <b>Ù†ÙˆØ§Ù‚Øµ</b> â€” <b>Ø¨Ø­Ø«: Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·</b> â€” <b>ÙƒÙ… tv500</b> â€” <b>Ø§Ø¹Ø±Ø¶ w334</b>
            </div>
          </div>
        </section>

        <!-- Inventory -->
        <section id="tab-inventory" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2">
            <h2 class="text-xl font-bold">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
            <div class="flex gap-2">
              <button onclick="exportExcel()" class="bg-green-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center">
                <i class="fas fa-file-excel"></i>
              </button>
              <button id="btn-add-modal" onclick="openAddModal()" class="bg-blue-600 text-white w-10 h-10 rounded-lg shadow flex items-center justify-center">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>

          <div class="relative mb-4">
            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            <input type="text" id="inventory-search" onkeyup="renderInventory()"
              placeholder="Ø¨Ø­Ø«: Ù…ÙˆØ¯ÙŠÙ„/Ù†ÙˆØ¹/ÙƒÙ„Ù…Ø© (Ù…Ø«Ø§Ù„: w334 Ø£Ùˆ ØªÙ„ÙØ²ÙŠÙˆÙ†)"
              class="w-full p-3 pr-10 rounded-xl border-none shadow-sm dark:bg-gray-800" />
          </div>

          <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </section>

        <!-- Stats -->
        <section id="tab-stats" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-xl font-bold mb-4">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
              <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-2 text-sm text-gray-500">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</h3>
              <div id="stock-alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Bottom nav -->
      <nav class="lg:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center h-16 shrink-0 z-30 pb-safe">
        <button onclick="switchTab('chat')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-primary">
          <i class="fas fa-comments text-xl mb-1"></i><span class="text-xs font-medium">Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-boxes text-xl mb-1"></i><span class="text-xs font-medium">Ù…Ø®Ø²ÙˆÙ†</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-xs font-medium">Ø¥Ø­ØµØ§Ø¡</span>
        </button>
      </nav>
    </main>
  </div>

  <!-- Modal: Add/Edit -->
  <div id="modal-form" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
      <h3 class="text-xl font-bold mb-4 text-center">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬</h3>

      <div class="space-y-3">
        <input type="text" id="m-model" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Ù…Ø«Ø§Ù„ w334)"
          class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none" />
        <select id="m-type" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none">
          <option value="Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·">Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·</option>
          <option value="Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†">Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†</option>
          <option value="Ø¯Ø±Ø³ÙˆØ§Ø±">Ø¯Ø±Ø³ÙˆØ§Ø±</option>
        </select>
        <input type="number" id="m-count" placeholder="Ø§Ù„Ø¹Ø¯Ø¯"
          class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none" />

        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative">
          <input type="file" id="m-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
          <p class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
        <button onclick="saveItem()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div id="modal-settings" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <button onclick="closeSettings()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-900/40">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold">ğŸ”Š ØµÙˆØª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.</div>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="set-tts-enabled" type="checkbox" class="sr-only peer" onchange="saveSettingsFromUI()">
              <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:bg-primary relative">
                <div class="absolute top-[2px] right-[2px] bg-white w-5 h-5 rounded-full transition-all peer-checked:translate-x-[-20px]"></div>
              </div>
            </label>
          </div>

          <div class="mt-4 space-y-3">
            <div>
              <div class="flex justify-between text-sm"><span>Ø§Ù„Ø³Ø±Ø¹Ø©</span><span id="val-rate" class="font-bold">1.00</span></div>
              <input id="set-rate" type="range" min="0.75" max="1.35" step="0.05" class="w-full"
                oninput="previewSettingValue('rate')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="flex justify-between text-sm"><span>Ø§Ù„Ù†Ø¨Ø±Ø©</span><span id="val-pitch" class="font-bold">1.00</span></div>
              <input id="set-pitch" type="range" min="0.8" max="1.35" step="0.05" class="w-full"
                oninput="previewSettingValue('pitch')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="flex justify-between text-sm"><span>Ø¹Ù„Ùˆ Ø§Ù„ØµÙˆØª</span><span id="val-volume" class="font-bold">1.00</span></div>
              <input id="set-volume" type="range" min="0" max="1" step="0.05" class="w-full"
                oninput="previewSettingValue('volume')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="text-sm mb-1">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª</div>
              <select id="set-voice" class="w-full p-3 rounded-xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600"
                onchange="saveSettingsFromUI()">
                <option value="">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª...</option>
              </select>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ ØµÙˆØª Ø¹Ø±Ø¨ÙŠØŒ Ù†Ø®Ù„ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.</div>
            </div>

            <div class="flex gap-2">
              <button onclick="testVoice()" class="flex-1 py-3 rounded-xl bg-secondary text-white font-bold">Ø§Ø®ØªØ¨Ø§Ø±</button>
              <button onclick="resetVoiceSettings()" class="flex-1 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 font-bold">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            </div>
          </div>
        </div>

        <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-900/40">
          <div class="font-bold">ğŸ™ï¸ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù. Ù„Ø§Ø²Ù… HTTPS.</div>

          <div class="mt-3 space-y-2">
            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
              <span class="text-sm">Ù„ØºØ© Ø§Ù„ØªØ¹Ø±Ù</span>
              <select id="set-stt-lang" class="bg-transparent outline-none" onchange="saveSettingsFromUI()">
                <option value="ar-SA">ar-SA (Ø³Ø¹ÙˆØ¯ÙŠ)</option>
                <option value="ar">ar (Ø¹Ø§Ù…)</option>
                <option value="ar-EG">ar-EG (Ù…ØµØ±ÙŠ)</option>
              </select>
            </label>

            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
              <span class="text-sm">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ÙÙ‡Ù…</span>
              <input id="set-suggestions" type="checkbox" onchange="saveSettingsFromUI()">
            </label>

            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
              <span class="text-sm">ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ (Ø£/Ø¥/Ø¢â€¦)</span>
              <input id="set-normalize" type="checkbox" onchange="saveSettingsFromUI()">
            </label>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* =========================
   0) Helpers UI
========================= */
function $(id){ return document.getElementById(id); }
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   1) Users + state
========================= */
const USERS = {
  1: { name: "Ø­Ø³Ù†", role: "admin", pass: "123", label: "Ù…Ø³Ø¤ÙˆÙ„" },
  2: { name: "Ù…Ø¹ØªØ²", role: "viewer", pass: "123", label: "Ù…Ø´Ø§Ù‡Ø¯" },
  3: { name: "Ù…Ø­Ù…Ø¯", role: "manager", pass: "123", label: "Ù…Ø¯ÙŠØ±" }
};
let currentUser = null;
let db;
let recognition = null;
let isListening = false;
let chartInstance = null;

/* =========================
   2) Settings (saved)
========================= */
const SETTINGS_KEY = "WarehouseV8Settings";
const defaultSettings = {
  // TTS
  ttsEnabled: true,
  rate: 1.0,
  pitch: 1.0,
  volume: 1.0,
  voiceURI: "",

  // STT
  sttLang: "ar-SA",

  // Smart behavior
  suggestions: true,
  normalizeArabic: true,
};
let settings = loadSettings();

function loadSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(!raw) return { ...defaultSettings };
    return { ...defaultSettings, ...JSON.parse(raw) };
  }catch{ return { ...defaultSettings }; }
}
function saveSettings(){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  updateBadges();
}

/* =========================
   3) Environment warning for mic
========================= */
(function showEnvWarning(){
  const isSecure = window.isSecureContext;
  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  if(!isSecure && !isLocalhost) $("env-warning").classList.remove("hidden");
})();

/* =========================
   4) IndexedDB
========================= */
const request = indexedDB.open("WarehouseV8", 1);
request.onupgradeneeded = (e) => {
  db = e.target.result;
  if (!db.objectStoreNames.contains('inventory')) {
    const store = db.createObjectStore('inventory', { keyPath: "model" });
    store.add({ model: "w334", type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", count: 15, img: "https://placehold.co/150/png?text=W334" });
    store.add({ model: "tv500", type: "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", count: 5, img: "https://placehold.co/150/png?text=TV500" });
    store.add({ model: "ds110", type: "Ø¯Ø±Ø³ÙˆØ§Ø±", count: 2, img: "https://placehold.co/150/png?text=DS110" });
    store.add({ model: "w120", type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", count: 7, img: "https://placehold.co/150/png?text=W120" });
  }
  if (!db.objectStoreNames.contains('chats')) {
    db.createObjectStore('chats', { keyPath: "id", autoIncrement: true });
  }
};
request.onsuccess = (e) => { db = e.target.result; loadChatHistory(); };

/* =========================
   5) Login + navigation
========================= */
function login() {
  const id = $("user-select").value;
  const pass = $("password-input").value;

  if (USERS[id] && USERS[id].pass === pass) {
    currentUser = { ...USERS[id], id: parseInt(id, 10) };

    $("login-screen").classList.add("hidden");
    $("app-interface").classList.remove("hidden");
    $("app-interface").classList.add("flex");

    $("user-greeting-pc").innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø£Ø³ØªØ§Ø° ${currentUser.name}`;
    $("user-role-pc").innerText = currentUser.label;
    $("user-greeting-mobile").innerText = `Ø£Ø³ØªØ§Ø° ${currentUser.name}`;

    if (currentUser.role === "viewer") $("btn-add-modal").classList.add("hidden");

    initTTS();
    initSTT();
    renderInventory();
    updateStats();
    updateBadges();

    speak(buildAssistantReply({
      title: `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø³ØªØ§Ø° ${currentUser.name}`,
      body: `Ø¬Ø§Ù‡Ø². Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ù†ÙˆØ¹. ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø§Ù„Ø²Ø±.`,
      tips: [`Ù…Ø«Ø§Ù„: ÙƒÙ… w334`, `Ù…Ø«Ø§Ù„: Ù†ÙˆØ§Ù‚Øµ`, `Ù…Ø«Ø§Ù„: Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†`]
    }));
  } else {
    $("login-error").classList.remove("hidden");
  }
}
function logout(){ location.reload(); }

function switchTab(tabId) {
  ['chat','inventory','stats'].forEach(id => $(`tab-${id}`).classList.add('hidden'));
  const active = $(`tab-${tabId}`);
  active.classList.remove('hidden');
  active.classList.add('flex');
  if(tabId === 'stats') updateStats();
}
function toggleTheme(){ document.documentElement.classList.toggle('dark'); }

/* =========================
   6) Settings modal
========================= */
function openSettings(){
  $("modal-settings").classList.remove("hidden");
  hydrateSettingsUI();
  refreshVoices(true);
}
function closeSettings(){ $("modal-settings").classList.add("hidden"); }

function hydrateSettingsUI(){
  $("set-tts-enabled").checked = !!settings.ttsEnabled;
  $("set-rate").value = settings.rate;
  $("set-pitch").value = settings.pitch;
  $("set-volume").value = settings.volume;
  $("set-suggestions").checked = !!settings.suggestions;
  $("set-normalize").checked = !!settings.normalizeArabic;
  $("set-stt-lang").value = settings.sttLang;

  $("val-rate").innerText = Number(settings.rate).toFixed(2);
  $("val-pitch").innerText = Number(settings.pitch).toFixed(2);
  $("val-volume").innerText = Number(settings.volume).toFixed(2);
}
function previewSettingValue(which){
  if(which==='rate') $("val-rate").innerText = Number($("set-rate").value).toFixed(2);
  if(which==='pitch') $("val-pitch").innerText = Number($("set-pitch").value).toFixed(2);
  if(which==='volume') $("val-volume").innerText = Number($("set-volume").value).toFixed(2);
}
function saveSettingsFromUI(){
  settings.ttsEnabled = $("set-tts-enabled").checked;
  settings.rate = parseFloat($("set-rate").value);
  settings.pitch = parseFloat($("set-pitch").value);
  settings.volume = parseFloat($("set-volume").value);
  settings.voiceURI = $("set-voice").value || "";
  settings.suggestions = $("set-suggestions").checked;
  settings.normalizeArabic = $("set-normalize").checked;
  settings.sttLang = $("set-stt-lang").value || "ar-SA";
  saveSettings();

  // update STT language live
  if(recognition) recognition.lang = settings.sttLang;
}
function resetVoiceSettings(){
  settings.ttsEnabled = true;
  settings.rate = 1.0;
  settings.pitch = 1.0;
  settings.volume = 1.0;
  settings.voiceURI = "";
  saveSettings();
  hydrateSettingsUI();
  refreshVoices(true);
  speak("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª.");
}
function updateBadges(){
  $("tts-status").innerHTML = settings.ttsEnabled
    ? `<i class="fas fa-volume-up"></i> Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù‘Ù„`
    : `<i class="fas fa-volume-mute"></i> Ø§Ù„ØµÙˆØª: Ù…ØªÙˆÙ‚Ù`;
}

/* =========================
   7) TTS: better selection + cleaner reading
========================= */
const synth = window.speechSynthesis;
let cachedVoices = [];

function initTTS(){
  if(!('speechSynthesis' in window)) return;
  synth.onvoiceschanged = () => refreshVoices();
  setTimeout(() => refreshVoices(), 200);
  setTimeout(() => refreshVoices(), 1000);
}
function refreshVoices(force=false){
  if(!('speechSynthesis' in window)) return;
  const voices = synth.getVoices();
  if(voices.length === 0 && !force) return;
  cachedVoices = voices;

  const sel = $("set-voice");
  if(!sel) return;
  const prev = settings.voiceURI;

  sel.innerHTML = `<option value="">Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø²)</option>`;

  const ar = voices.filter(v => (v.lang||'').toLowerCase().startsWith('ar'));
  const other = voices.filter(v => !(v.lang||'').toLowerCase().startsWith('ar'));
  [...ar, ...other].forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} â€” ${v.lang}${v.default ? " (Ø§ÙØªØ±Ø§Ø¶ÙŠ)" : ""}`;
    sel.appendChild(opt);
  });

  if(prev) sel.value = prev;
}
function getSelectedVoice(){
  if(!settings.voiceURI) return null;
  return cachedVoices.find(v => v.voiceURI === settings.voiceURI) || null;
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  if(!settings.ttsEnabled) return;

  const cleaned = (text || "")
    .replace(/\s+/g,' ')
    .replace(/\.\s*\./g,'.')
    .trim();

  if(!cleaned) return;

  try{
    if(synth.speaking) synth.cancel();

    const u = new SpeechSynthesisUtterance(cleaned);
    u.lang = settings.sttLang || 'ar-SA'; // Ø¹Ø§Ø¯Ø© ÙŠØ¹Ø·ÙŠ Ù†Ø·Ù‚ Ø£Ù‚Ø±Ø¨

    u.rate = settings.rate;
    u.pitch = settings.pitch;
    u.volume = settings.volume;

    const v = getSelectedVoice();
    if(v) u.voice = v;

    synth.speak(u);
  }catch{}
}
function testVoice(){
  const name = currentUser?.name || "ØµØ¯ÙŠÙ‚ÙŠ";
  speak(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}. Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø±. Ø§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø© Ù…Ø¶Ø¨ÙˆØ·ØªØ§Ù†.`);
}

/* =========================
   8) STT (microphone) FIXED
   - Toggle start/stop
   - Better error messages
========================= */
function initSTT(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    setSttStatus("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­", false);
    return;
  }
  recognition = new SR();
  recognition.lang = settings.sttLang || 'ar-SA';
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 3;

  recognition.onstart = () => {
    isListening = true;
    $("mic-btn").classList.add("mic-active");
    setSttStatus("ÙŠØ³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†â€¦", true);
  };
  recognition.onend = () => {
    isListening = false;
    $("mic-btn").classList.remove("mic-active");
    setSttStatus("Ù…ØªÙˆÙ‚Ù", false);
  };
  recognition.onerror = (e) => {
    isListening = false;
    $("mic-btn").classList.remove("mic-active");

    // Common errors: not-allowed, service-not-allowed, audio-capture, network, no-speech
    const msg = ({
      "not-allowed": "Ù…Ø±ÙÙˆØ¶: ÙØ¹Ù‘Ù„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù†Ø¸Ø§Ù….",
      "service-not-allowed": "Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©. Ø¬Ø±Ù‘Ø¨ Chrome/Edge Ø£Ùˆ HTTPS.",
      "audio-capture": "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­.",
      "network": "Ù…Ø´ÙƒÙ„Ø© Ø´Ø¨ÙƒØ© (Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„).",
      "no-speech": "Ù„Ù… Ø£Ù„ØªÙ‚Ø· ØµÙˆØªØ§Ù‹. Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­.",
      "aborted": "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù."
    })[e.error] || `Ø®Ø·Ø£ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${e.error}`;

    setSttStatus(msg, false);
    addMsg('ai', buildAssistantReply({ title: "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†", body: msg, tips: [
      "ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø¹Ù„Ù‰ HTTPS Ø£Ùˆ localhost",
      "Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹",
      "Ø¬Ø±Ù‘Ø¨ Chrome Ø£Ùˆ Edge"
    ]}));
  };

  recognition.onresult = (event) => {
    const results = event.results?.[0];
    if(!results) return;

    // pick best transcript
    let best = "";
    let bestConf = -1;
    for(let i=0;i<results.length;i++){
      const t = results[i].transcript || "";
      const c = results[i].confidence ?? 0;
      if(c > bestConf){ bestConf = c; best = t; }
    }
    best = (best || "").trim();
    if(!best) return;

    $("chat-input").value = best;
    processInput(best);
  };

  // Initial status
  setSttStatus("Ø¬Ø§Ù‡Ø²", false);
}

function setSttStatus(text, active){
  $("stt-status").innerHTML = active
    ? `<i class="fas fa-microphone"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${escapeHtml(text)}`
    : `<i class="fas fa-microphone-slash"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${escapeHtml(text)}`;
}

async function toggleListening(){
  if(!recognition){
    addMsg('ai', buildAssistantReply({
      title: "Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…",
      body: "Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome Ø£Ùˆ Edge.",
      tips: ["Ø¹Ù„Ù‰ iPhone Safari Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„", "Ù„Ø§Ø²Ù… HTTPS Ø£Ùˆ localhost"]
    }));
    return;
  }

  // Check secure context
  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  if(!window.isSecureContext && !isLocalhost){
    addMsg('ai', buildAssistantReply({
      title: "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†",
      body: "Ù„Ø§Ø²Ù… HTTPS Ø£Ùˆ localhost Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª.",
      tips: ["Ø´ØºÙ‘Ù„ Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ", "Ø£Ùˆ Ø§Ø±ÙØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¶Ø§ÙØ© HTTPS"]
    }));
    return;
  }

  // Try to pre-request permission (best-effort)
  try{
    if(navigator.mediaDevices?.getUserMedia){
      await navigator.mediaDevices.getUserMedia({ audio: true });
    }
  }catch(err){
    addMsg('ai', buildAssistantReply({
      title: "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø±ÙÙˆØ¶Ø©",
      body: "ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¬Ù‡Ø§Ø² Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.",
      tips: ["Settings > Site settings > Microphone", "ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ù…ÙˆØ­"]
    }));
    return;
  }

  // Toggle
  try{
    if(isListening){
      recognition.stop();
    }else{
      recognition.start();
    }
  }catch(e){
    // Some browsers throw if start called too quickly
    setSttStatus("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©", false);
  }
}

/* =========================
   9) Smart understanding (more accurate)
   - Arabic normalize
   - synonyms
   - fuzzy match (edit distance + token scoring)
   - intents: all, low, count, show, type
========================= */
function normalizeArabicText(s){
  if(!settings.normalizeArabic) return (s||"").toLowerCase().trim();
  return (s||"")
    .toLowerCase()
    .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,'') // tashkeel
    .replace(/[Ø¥Ø£Ø¢Ø§]/g,'Ø§')
    .replace(/Ù‰/g,'ÙŠ')
    .replace(/Ø¤/g,'Ùˆ')
    .replace(/Ø¦/g,'ÙŠ')
    .replace(/Ø©/g,'Ù‡')
    .replace(/Ù€/g,'')
    .replace(/[^\p{L}\p{N}\s]/gu,' ') // remove punctuation
    .replace(/\s+/g,' ')
    .trim();
}
function tokens(s){ return normalizeArabicText(s).split(' ').filter(Boolean); }

const TYPE_SYNONYMS = {
  "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·": ["Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·","Ø·Ø§ÙˆÙ„Ù‡ ÙˆØ³Ø·","Ø·Ø§ÙˆÙ„Ø©","Ø·Ø§ÙˆÙ„Ù‡","ÙˆØ³Ø·","ØªØ±Ø§Ø¨ÙŠØ²Ù‡ ÙˆØ³Ø·","ØªØ±Ø§Ø¨ÙŠØ²Ù‡"],
  "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†": ["Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†","Ø·Ø§ÙˆÙ„Ù‡ ØªÙ„ÙØ²ÙŠÙˆÙ†","ØªÙ„ÙØ²ÙŠÙˆÙ†","tv","ØªÙŠ ÙÙŠ","Ø·Ø§ÙˆÙ„Ø© tv","Ø·Ø§ÙˆÙ„Ù‡ tv","Ø·Ø§ÙˆÙ„Ø© Ø´Ø§Ø´Ù‡","Ø·Ø§ÙˆÙ„Ø© Ø´Ø§Ø´Ø©","Ø´Ø§Ø´Ø©"],
  "Ø¯Ø±Ø³ÙˆØ§Ø±": ["Ø¯Ø±Ø³ÙˆØ§Ø±","Ø¯Ø±ÙŠØ³ÙˆØ§Ø±","ØªØ³Ø±ÙŠØ­Ù‡","ØªØ³Ø±ÙŠØ­Ù‡ Ù…Ø¯Ø®Ù„","ÙƒÙˆÙ†Ø³ÙˆÙ„","ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù…Ø¯Ø®Ù„","Ù…Ø¯Ø®Ù„"]
};

// Fuzzy helpers
function levenshtein(a,b){
  a = a || ""; b = b || "";
  const m=a.length,n=b.length;
  if(!m) return n; if(!n) return m;
  const dp = Array.from({length:m+1}, (_,i)=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
function similarity(a,b){
  a = normalizeArabicText(a); b = normalizeArabicText(b);
  if(!a || !b) return 0;
  if(a===b) return 1;
  const dist = levenshtein(a,b);
  return 1 - dist / Math.max(a.length,b.length);
}
function extractModels(raw){
  const m = (raw||"").match(/[a-z]+\d+/gi);
  return m ? m.map(x=>x.toLowerCase()) : [];
}
function detectTypeFromQuery(qNorm){
  // returns best matching canonical type or null
  let best = { type: null, score: 0 };
  for(const [type, variants] of Object.entries(TYPE_SYNONYMS)){
    for(const v of variants){
      if(qNorm.includes(normalizeArabicText(v))){
        return type; // strong hit
      }
      const s = similarity(qNorm, v);
      if(s > best.score){
        best = { type, score: s };
      }
    }
  }
  return best.score >= 0.72 ? best.type : null;
}
function parseIntent(raw){
  const q = normalizeArabicText(raw);
  const toks = tokens(raw);

  const isAll = /(Ø§Ù„ÙƒÙ„|Ø¬Ø±Ø¯|Ø¬Ø±Ø¯Ù‡|inventory|ÙƒÙ„ Ø§Ù„Ø§ØµÙ†Ø§Ù|ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)/.test(q);
  const isLow = /(Ù†Ø§Ù‚Øµ|Ù†ÙˆØ§Ù‚Øµ|Ù‚Ù„ÙŠÙ„|Ø§Ù‚Ù„ Ù…Ù†|Ù…Ù†Ø®ÙØ¶|ØªÙ†Ø¨ÙŠÙ‡)/.test(q);
  const isCount = /(ÙƒÙ…|Ø¹Ø¯Ø¯|ÙƒÙ…ÙŠÙ‡|ÙƒÙ…ÙŠØ©)/.test(q);
  const isShow = /(Ø§Ø¹Ø±Ø¶|Ø¹Ø±Ø¶|Ù‡Ø§Øª|Ø¬ÙŠØ¨|Ø·Ù„Ù‘Ø¹|Ø·Ù„Ø¹|ÙˆØ±ÙŠÙ†ÙŠ|Ø§Ø±Ù†ÙŠ)/.test(q);

  // threshold "Ø§Ù‚Ù„ Ù…Ù† X"
  let lessThan = null;
  const m = q.match(/Ø§Ù‚Ù„ Ù…Ù†\s*(\d+)/);
  if(m) lessThan = parseInt(m[1],10);

  const models = extractModels(raw);
  const type = detectTypeFromQuery(q);

  return { q, toks, isAll, isLow, isCount, isShow, lessThan, models, type };
}

function buildAssistantReply({title="", body="", tips=[]}){
  // Ù†Øµ Ù…Ù‚Ø±ÙˆØ¡ Ø¬ÙŠØ¯Ø§Ù‹: Ø¬Ù…Ù„ Ù‚ØµÙŠØ±Ø© + ÙÙˆØ§ØµÙ„ ÙˆØ§Ø¶Ø­Ø©
  let out = "";
  if(title) out += `${title}. `;
  if(body) out += `${body} `;
  if(tips?.length){
    out += "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ";
    out += tips.slice(0,3).map(t=>t.replace(/\.$/,'')).join("ØŒ ");
    out += ".";
  }
  return out.replace(/\s+/g,' ').trim();
}

function scoreItem(item, intent){
  const model = (item.model||"").toLowerCase();
  const type = item.type || "";
  const q = intent.q;
  const toks = intent.toks;

  let score = 0;

  // strong: model exact
  if(intent.models.length && intent.models.includes(model)) score += 120;
  if(q.includes(model)) score += 80;
  if(model.startsWith(q) && q.length>=2) score += 50;

  // type hit via synonyms + similarity
  if(intent.type && item.type === intent.type) score += 70;

  // token matches
  const typeNorm = normalizeArabicText(type);
  toks.forEach(t=>{
    if(t.length<2) return;
    if(model.includes(t)) score += 14;
    if(typeNorm.includes(t)) score += 16;
  });

  // fuzzy similarity for short typos (especially model)
  if(q.length >= 3){
    score += Math.round(similarity(q, model) * 35);
    score += Math.round(similarity(q, type) * 25);
  }

  return score;
}

/* =========================
   10) Chat flow
========================= */
function handleEnter(e){ if(e.key === 'Enter') processInput(); }

async function processInput(forcedText=null){
  const input = $("chat-input");
  const raw = (forcedText ?? input.value ?? "").trim();
  if(!raw) return;

  addMsg('user', raw);
  input.value = "";

  const allItems = await getAll();
  const intent = parseIntent(raw);

  // Intent: all inventory
  if(intent.isAll){
    const data = allItems;
    const reply = buildAssistantReply({
      title: `ØªÙØ¶Ù„ Ø£Ø³ØªØ§Ø° ${currentUser.name}`,
      body: `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${data.length}.`
    });
    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Intent: low stock
  if(intent.isLow || intent.lessThan !== null){
    const th = intent.lessThan ?? 5;
    const data = allItems.filter(i => (i.count ?? 0) < th);
    const reply = data.length
      ? buildAssistantReply({ title: "ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙˆØ§Ù‚Øµ", body: `ÙˆØ¬Ø¯Øª ${data.length} Ø£ØµÙ†Ø§Ù Ø£Ù‚Ù„ Ù…Ù† ${th}.` })
      : buildAssistantReply({ title: "ØªÙ…Ø§Ù…", body: `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ø£Ù‚Ù„ Ù…Ù† ${th}.` });

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Model direct query
  if(intent.models.length){
    const found = allItems.filter(i => intent.models.includes((i.model||"").toLowerCase()));
    if(found.length){
      let reply = "";
      if(intent.isCount && found.length === 1){
        reply = buildAssistantReply({
          title: "Ø§Ù„ÙƒÙ…ÙŠØ©",
          body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${found[0].model.toUpperCase()} Ø¹Ø¯Ø¯Ù‡ ${found[0].count}.`
        });
      }else{
        reply = buildAssistantReply({
          title: `ÙˆØ¬Ø¯Øª ${found.length} Ù†ØªÙŠØ¬Ø©`,
          body: `Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø·Ù„Ø¨Ùƒ.`
        });
      }
      speak(reply);
      addMsg('ai', reply, found);
    }else{
      const reply = buildAssistantReply({
        title: "Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„",
        body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„: ${intent.models.join(", ").toUpperCase()}.`,
        tips: ["ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù…Ø«Ù„ w334", "Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†ÙˆØ¹ Ù…Ø«Ù„ Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·"]
      });
      speak(reply);
      addMsg('ai', reply);
    }
    return;
  }

  // Type direct query
  if(intent.type){
    const data = allItems.filter(i => i.type === intent.type);
    const reply = data.length
      ? buildAssistantReply({ title: "Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹", body: `Ù†ÙˆØ¹: ${intent.type}. Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${data.length}.` })
      : buildAssistantReply({ title: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬", body: `Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù†ÙˆØ¹ ${intent.type}.` });

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Ranked fuzzy search
  const ranked = allItems
    .map(item => ({ item, score: scoreItem(item, intent) }))
    .filter(x => x.score >= 25)
    .sort((a,b)=> b.score - a.score);

  if(ranked.length){
    const data = ranked.slice(0, 12).map(x=>x.item);

    // If user asked count but query was generic, try to answer if top is very confident
    const top = ranked[0];
    let reply = "";
    if(intent.isCount && top.score >= 90){
      reply = buildAssistantReply({
        title: "Ø£Ù‚Ø±Ø¨ Ù†ØªÙŠØ¬Ø©",
        body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${top.item.model.toUpperCase()} Ø¹Ø¯Ø¯Ù‡ ${top.item.count}.`
      });
    }else{
      reply = buildAssistantReply({
        title: "ÙˆØ¬Ø¯Øª Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±ÙŠØ¨Ø©",
        body: `Ù‡Ø°Ù‡ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø·Ù„Ø¨Ùƒ. Ù„Ùˆ ØªÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø£Ø¯Ù‚ ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙØ¶Ù„.`
      });
    }

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Not understood
  const reply = settings.suggestions
    ? buildAssistantReply({
        title: `Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø·Ù„Ø¨`,
        body: `Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ù†ÙˆØ¹.`,
        tips: ["ÙƒÙ… w334", "Ù†ÙˆØ§Ù‚Øµ", "Ø¬Ø±Ø¯", "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", "Ø¯Ø±Ø³ÙˆØ§Ø±"]
      })
    : `Ù„Ù… Ø£ÙÙ‡Ù….`;

  speak(reply);
  addMsg('ai', reply);
}

function addMsg(sender, text, data=[]){
  const box = $("chat-box");
  const div = document.createElement('div');
  div.className = `flex ${sender==='user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

  const safeText = escapeHtml(text).replaceAll("\n","<br>");
  let html = `<div class="max-w-[85%] p-3 rounded-2xl ${sender==='user'
    ? 'bg-primary text-white rounded-br-none'
    : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
      <p class="text-sm md:text-base leading-6">${safeText}</p>`;

  if(data?.length){
    html += `<div class="mt-2 grid grid-cols-2 gap-2">`;
    data.forEach(i=>{
      html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded border border-gray-100 dark:border-gray-500 text-center">
        <img src="${i.img}" class="w-full h-16 object-cover rounded mb-1" alt="img">
        <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</div>
        <div class="text-xs text-gray-500 dark:text-gray-300 mb-1">${escapeHtml(i.type||'')}</div>
        <div class="text-green-600 font-bold">${escapeHtml(i.count)}</div>
      </div>`;
    });
    html += `</div>`;
  }

  html += `</div>`;
  div.innerHTML = html;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  if(db){
    const tx = db.transaction("chats","readwrite");
    tx.objectStore("chats").add({ sender, text, data, time: new Date() });
  }
}

function loadChatHistory(){
  if(!db) return;
  const tx = db.transaction("chats","readonly");
  tx.objectStore("chats").getAll().onsuccess = (e)=>{
    const box = $("chat-box");
    box.innerHTML = "";
    (e.target.result||[]).forEach(msg=>{
      // render without re-saving
      const div = document.createElement('div');
      div.className = `flex ${msg.sender==='user' ? 'justify-end' : 'justify-start'}`;
      const safeText = escapeHtml(msg.text).replaceAll("\n","<br>");

      let html = `<div class="max-w-[85%] p-3 rounded-2xl ${msg.sender==='user'
        ? 'bg-primary text-white rounded-br-none'
        : 'bg-white dark:bg-gray-700 shadow rounded-bl-none'}">
        <p class="text-sm md:text-base leading-6">${safeText}</p>`;

      if(msg.data?.length){
        html += `<div class="mt-2 grid grid-cols-2 gap-2">`;
        msg.data.forEach(i=>{
          html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded border border-gray-100 dark:border-gray-500 text-center">
            <img src="${i.img}" class="w-full h-16 object-cover rounded mb-1" alt="img">
            <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</div>
            <div class="text-xs text-gray-500 dark:text-gray-300 mb-1">${escapeHtml(i.type||'')}</div>
            <div class="text-green-600 font-bold">${escapeHtml(i.count)}</div>
          </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  };
}

function clearChat(){
  if(!db) return;
  const tx = db.transaction("chats","readwrite");
  tx.objectStore("chats").clear();
  $("chat-box").innerHTML = "";
}

/* =========================
   11) Inventory
========================= */
async function getAll(){
  return new Promise(res=>{
    if(!db) return res([]);
    db.transaction("inventory","readonly").objectStore("inventory").getAll().onsuccess = e => res(e.target.result || []);
  });
}
async function renderInventory(){
  const items = await getAll();
  const q = normalizeArabicText($("inventory-search").value || "");
  const grid = $("inventory-grid");
  grid.innerHTML = "";

  const filtered = items.filter(i=>{
    if(!q) return true;
    const model = (i.model||"").toLowerCase();
    const type = normalizeArabicText(i.type||"");
    return model.includes(q) || type.includes(q) || similarity(q, model) >= 0.72 || similarity(q, type) >= 0.72;
  });

  filtered.forEach(i=>{
    const isLow = (i.count ?? 0) < 5;
    grid.innerHTML += `
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-3 relative border-t-4 ${isLow ? 'border-red-500' : 'border-green-500'}">
        <img src="${i.img}" class="w-full h-24 object-cover rounded bg-gray-100 mb-2" alt="img">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-bold text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</h3>
            <p class="text-xs text-gray-500">${escapeHtml(i.type||'')}</p>
          </div>
          <span class="text-lg font-bold text-primary">${escapeHtml(i.count)}</span>
        </div>

        ${currentUser?.role !== 'viewer' ? `
        <div class="mt-2 flex justify-end gap-2 border-t pt-2 dark:border-gray-700">
          <button onclick="editItem('${i.model}')" class="text-blue-500 text-sm" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
          ${currentUser?.role === 'admin' ? `<button onclick="delItem('${i.model}')" class="text-red-500 text-sm" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>` : ''}
        </div>` : ''}
      </div>`;
  });
}

function openAddModal(){ $("modal-form").classList.remove("hidden"); }
function closeModal(){ $("modal-form").classList.add("hidden"); }

function saveItem(){
  const model = ($("m-model").value || "").trim().toLowerCase();
  const type = $("m-type").value;
  const count = parseInt($("m-count").value, 10);
  const imgInput = $("m-img");

  if(!model || Number.isNaN(count)) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

  const reader = new FileReader();
  reader.onload = e=>{
    const img = imgInput.files[0] ? e.target.result : `https://placehold.co/150/png?text=${model.toUpperCase()}`;
    const tx = db.transaction("inventory","readwrite");
    tx.objectStore("inventory").put({ model, type, count, img });
    tx.oncomplete = ()=>{ closeModal(); renderInventory(); updateStats(); speak("ØªÙ… Ø§Ù„Ø­ÙØ¸."); };
  };
  if(imgInput.files[0]) reader.readAsDataURL(imgInput.files[0]);
  else reader.onload({target:{result:null}});
}

function delItem(model){
  if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
  const tx = db.transaction("inventory","readwrite");
  tx.objectStore("inventory").delete(model);
  tx.oncomplete = ()=>{ renderInventory(); updateStats(); };
}

function editItem(model){
  db.transaction("inventory","readonly").objectStore("inventory").get(model).onsuccess = e=>{
    const i = e.target.result;
    if(!i) return;
    $("m-model").value = i.model;
    $("m-type").value = i.type;
    $("m-count").value = i.count;
    openAddModal();
  };
}

/* =========================
   12) Stats + export
========================= */
async function updateStats(){
  const items = await getAll();
  const types = {};
  const low = [];

  items.forEach(i=>{
    const t = i.type || "ØºÙŠØ± Ù…ØµÙ†Ù";
    types[t] = (types[t]||0) + (i.count||0);
    if((i.count||0) < 5) low.push(i);
  });

  if(chartInstance) chartInstance.destroy();
  if($("typeChart")){
    chartInstance = new Chart($("typeChart"), {
      type: 'doughnut',
      data: { labels: Object.keys(types),
        datasets: [{ data: Object.values(types), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }]
      },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  const alerts = $("stock-alerts");
  if(alerts){
    alerts.innerHTML = low.length ? "" : '<p class="text-green-500 text-sm">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù…ØªØ§Ø²</p>';
    low.forEach(i=>{
      alerts.innerHTML += `<div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded text-sm">
        <span>${escapeHtml(i.model)}</span><b>${escapeHtml(i.count)}</b>
      </div>`;
    });
  }
}

async function exportExcel(){
  const items = await getAll();
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Inventory");
  XLSX.writeFile(wb, "Warehouse.xlsx");
}

function exportChatPDF(){
  html2canvas($("chat-box")).then(c=>{
    const pdf = new window.jspdf.jsPDF();
    const img = c.toDataURL('image/png');
    const props = pdf.getImageProperties(img);
    const w = pdf.internal.pageSize.getWidth();
    const h = (props.height * w) / props.width;
    pdf.addImage(img, 'PNG', 0, 0, w, h);
    pdf.save("chat.pdf");
  });
}
function shareWhatsApp(){
  window.open("https://wa.me/?text=" + encodeURIComponent("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø§Ù‡Ø²"), "_blank");
}
</script>
</body>
</html>
