<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ Pro V9 - Ultimate Edition</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { 
            primary: '#2563eb', 
            secondary: '#10b981', 
            dark: '#1e293b',
            accent: '#f59e0b'
          },
          height: { 'screen-dvh': '100dvh' },
          animation: {
            'slide-in': 'slideIn 0.3s ease-out',
            'bounce-soft': 'bounceSoft 0.5s ease-in-out',
            'glow': 'glow 2s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap');
    body { 
      font-family: 'Tajawal', sans-serif; 
      overflow: hidden; 
      touch-action: manipulation;
      -webkit-font-smoothing: antialiased;
    }

    /* Animations */
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes bounceSoft {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); }
      50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.8); }
    }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 14px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .mic-active { 
      animation: pulse-red 1.2s infinite; 
      background-color: #ef4444 !important; 
      color: white !important; 
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .animate-fade-in { animation: fadeIn 220ms ease-out; }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(6px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .chip { 
      display: inline-flex; 
      align-items: center; 
      gap: 0.35rem; 
      padding: 0.35rem 0.65rem; 
      border-radius: 9999px; 
      font-size: 0.75rem; 
    }

    /* Notification Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      z-index: 9999;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease-out forwards;
      min-width: 300px;
      max-width: 90%;
    }
    @keyframes slideDown {
      to { transform: translateX(-50%) translateY(0); }
    }

    /* Print styles */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }

    /* Card hover effect */
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    /* Stats counter animation */
    .counter {
      font-variant-numeric: tabular-nums;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen-dvh w-full flex flex-col">

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="relative bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-[90%] max-w-md animate-bounce-soft">
      <div class="mb-6 bg-gradient-to-br from-blue-500 to-indigo-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-white shadow-lg">
        <i class="fas fa-boxes text-4xl"></i>
      </div>
      <h2 class="text-3xl font-black mb-2 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h2>
      <p class="text-gray-500 mb-6 text-sm">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 9.0 Ultimate Edition</p>

      <div class="space-y-4">
        <select id="user-select" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
          <option value="1">ğŸ‘¤ Ø­Ø³Ù† (Ù…Ø³Ø¤ÙˆÙ„ - Admin)</option>
          <option value="2">ğŸ‘€ Ù…Ø¹ØªØ² (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</option>
          <option value="3">ğŸ“¦ Ù…Ø­Ù…Ø¯ (Ù…Ø¯ÙŠØ± Ù…Ø³ØªÙˆØ¯Ø¹)</option>
        </select>

        <input type="password" id="password-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (123)"
          class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" />

        <button onclick="login()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
          <i class="fas fa-sign-in-alt"></i>
          <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </button>
      </div>

      <div id="env-warning" class="mt-4 text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-xl p-3 hidden text-right">
        <div class="font-bold mb-1">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù… Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
        <div>Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙŠØ¹Ù…Ù„ Ø¹Ø§Ø¯Ø©Ù‹ ÙÙ‚Ø· Ø¹Ù„Ù‰ <b>HTTPS</b> Ø£Ùˆ <b>localhost</b>. Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ/Ø§Ø³ØªØ¶Ø§ÙØ© Ø¢Ù…Ù†Ø©.</div>
      </div>

      <p id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold text-center">âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
  </div>

  <!-- App Interface -->
  <div id="app-interface" class="flex h-full w-full hidden relative">

    <!-- Sidebar (Desktop) -->
    <aside class="hidden lg:flex w-72 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-col shadow-xl z-20">
      <!-- User Profile -->
      <div class="p-6 border-b dark:border-gray-700">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-lg shadow-lg">
            <i class="fas fa-user"></i>
          </div>
          <div class="flex-1">
            <h3 id="user-greeting-pc" class="font-bold text-gray-800 dark:text-white">Ù…Ø±Ø­Ø¨Ø§Ù‹</h3>
            <p id="user-role-pc" class="text-xs text-gray-500 dark:text-gray-400"></p>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-2 text-center">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg">
            <div class="text-xs text-gray-600 dark:text-gray-400">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div id="quick-total" class="text-lg font-bold text-blue-600 counter">0</div>
          </div>
          <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
            <div class="text-xs text-gray-600 dark:text-gray-400">Ù†ÙˆØ§Ù‚Øµ</div>
            <div id="quick-low" class="text-lg font-bold text-red-600 counter">0</div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="switchTab('chat')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium group">
          <i class="fas fa-comments text-blue-500 text-xl w-6 group-hover:scale-110 transition"></i> 
          <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-green-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium group">
          <i class="fas fa-boxes text-green-500 text-xl w-6 group-hover:scale-110 transition"></i> 
          <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-purple-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium group">
          <i class="fas fa-chart-pie text-purple-500 text-xl w-6 group-hover:scale-110 transition"></i> 
          <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </button>
        <button onclick="switchTab('history')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-yellow-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium group">
          <i class="fas fa-history text-yellow-500 text-xl w-6 group-hover:scale-110 transition"></i> 
          <span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span>
        </button>
        <button onclick="switchTab('reports')" class="nav-btn w-full text-right p-4 rounded-xl hover:bg-indigo-50 dark:hover:bg-gray-700 transition flex items-center gap-4 text-gray-600 dark:text-gray-300 font-medium group">
          <i class="fas fa-file-alt text-indigo-500 text-xl w-6 group-hover:scale-110 transition"></i> 
          <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
        </button>
      </nav>

      <!-- Footer Actions -->
      <div class="p-4 border-t dark:border-gray-700 space-y-2">
        <button onclick="openSettings()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition group">
          <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
          <i class="fas fa-sliders text-primary group-hover:rotate-90 transition"></i>
        </button>
        <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
          <i class="fas fa-moon text-yellow-500"></i>
        </button>
        <button onclick="backupData()" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <span>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
          <i class="fas fa-download text-green-500"></i>
        </button>
        <button onclick="logout()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 py-3 rounded-xl font-bold transition shadow-md">
          <i class="fas fa-sign-out-alt ml-2"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-100 dark:bg-gray-900">

      <!-- Mobile Header -->
      <header class="lg:hidden bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center z-10 h-16 shrink-0">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-sm">
            <i class="fas fa-user"></i>
          </div>
          <span id="user-greeting-mobile" class="font-bold text-sm">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
        </div>
        <div class="flex gap-3">
          <button onclick="openNotifications()" class="relative w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-bell text-primary"></i>
            <span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center">0</span>
          </button>
          <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-sliders text-primary"></i>
          </button>
          <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-moon text-yellow-500"></i>
          </button>
          <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden relative w-full">

        <!-- Chat Tab -->
        <section id="tab-chat" class="h-full flex flex-col w-full">
          <div class="px-4 pt-4 pb-2">
            <div class="flex flex-wrap gap-2 items-center">
              <span id="stt-status" class="chip bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-200">
                <i class="fas fa-microphone-slash"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„
              </span>
              <span id="tts-status" class="chip bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-200">
                <i class="fas fa-volume-up"></i> Ø§Ù„ØµÙˆØª: â€”
              </span>
              <span class="chip bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200">
                <i class="fas fa-lightbulb"></i> Ù…Ø«Ø§Ù„: "ÙƒÙ… w334" Ø£Ùˆ "Ù†ÙˆØ§Ù‚Øµ" Ø£Ùˆ "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†"
              </span>
            </div>
          </div>

          <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 lg:pb-4"></div>

          <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3 lg:p-4 shadow-lg z-20 shrink-0">
            <div class="flex justify-center gap-2 mb-3 text-xs overflow-x-auto pb-1">
              <button onclick="clearChat()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 text-gray-600 dark:text-gray-300 transition">
                <i class="fas fa-trash"></i> Ù…Ø³Ø­
              </button>
              <button onclick="exportChatPDF()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-blue-100 text-gray-600 dark:text-gray-300 transition">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="shareWhatsApp()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-green-100 text-gray-600 dark:text-gray-300 transition">
                <i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
              </button>
              <button onclick="exportChatText()" class="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-purple-100 text-gray-600 dark:text-gray-300 transition">
                <i class="fas fa-file-alt"></i> Ù†Øµ
              </button>
            </div>

            <div class="flex items-center gap-2 max-w-3xl mx-auto">
              <button id="mic-btn" onclick="toggleListening()"
                class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-white flex items-center justify-center hover:bg-gray-300 transition shadow-sm active:scale-90"
                title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                <i class="fas fa-microphone text-xl"></i>
              </button>

              <input type="text" id="chat-input"
                placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†â€¦"
                class="flex-1 h-12 px-4 rounded-full bg-gray-100 dark:bg-gray-900 border-none focus:ring-2 focus:ring-primary outline-none transition"
                onkeypress="handleEnter(event)" />

              <button onclick="processInput()" class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex items-center justify-center hover:from-blue-700 hover:to-indigo-700 transition shadow-md active:scale-90">
                <i class="fas fa-paper-plane text-lg"></i>
              </button>
            </div>

            <div class="max-w-3xl mx-auto mt-2 text-xs text-gray-500 dark:text-gray-400 leading-5 text-center">
              <b>Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø©:</b> Ø¬Ø±Ø¯ â€¢ Ù†ÙˆØ§Ù‚Øµ â€¢ Ø¨Ø­Ø«: Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø· â€¢ ÙƒÙ… tv500 â€¢ Ø§Ø¹Ø±Ø¶ w334
            </div>
          </div>
        </section>

        <!-- Inventory Tab -->
        <section id="tab-inventory" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2">
            <h2 class="text-2xl font-black flex items-center gap-2">
              <i class="fas fa-boxes text-primary"></i>
              <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            </h2>
            <div class="flex gap-2 flex-wrap">
              <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
                <i class="fas fa-file-excel"></i>
                <span class="hidden sm:inline">Excel</span>
              </button>
              <button onclick="printInventory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
                <i class="fas fa-print"></i>
                <span class="hidden sm:inline">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
              <button id="btn-add-modal" onclick="openAddModal()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
                <i class="fas fa-plus"></i>
                <span class="hidden sm:inline">Ø¥Ø¶Ø§ÙØ©</span>
              </button>
            </div>
          </div>

          <!-- Search & Filters -->
          <div class="mb-4 space-y-3">
            <div class="relative">
              <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
              <input type="text" id="inventory-search" onkeyup="renderInventory()"
                placeholder="Ø¨Ø­Ø«: Ù…ÙˆØ¯ÙŠÙ„/Ù†ÙˆØ¹/ÙƒÙ„Ù…Ø© (Ù…Ø«Ø§Ù„: w334 Ø£Ùˆ ØªÙ„ÙØ²ÙŠÙˆÙ†)"
                class="w-full p-3 pr-10 rounded-xl border-none shadow-sm dark:bg-gray-800 focus:ring-2 focus:ring-primary transition" />
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2">
              <button onclick="filterByType('all')" class="filter-btn px-4 py-2 rounded-lg bg-primary text-white text-sm whitespace-nowrap transition">
                Ø§Ù„ÙƒÙ„
              </button>
              <button onclick="filterByType('Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm whitespace-nowrap transition">
                Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·
              </button>
              <button onclick="filterByType('Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm whitespace-nowrap transition">
                Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†
              </button>
              <button onclick="filterByType('Ø¯Ø±Ø³ÙˆØ§Ø±')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm whitespace-nowrap transition">
                Ø¯Ø±Ø³ÙˆØ§Ø±
              </button>
              <button onclick="filterByType('low')" class="filter-btn px-4 py-2 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 text-sm whitespace-nowrap transition">
                <i class="fas fa-exclamation-triangle"></i> Ù†ÙˆØ§Ù‚Øµ
              </button>
            </div>
          </div>

          <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </section>

        <!-- Stats Tab -->
        <section id="tab-stats" class="h-full flex flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
            <i class="fas fa-chart-pie text-purple-500"></i>
            <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</span>
          </h2>

          <!-- Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-2xl shadow-lg">
              <div class="text-sm opacity-90 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
              <div id="stat-total" class="text-3xl font-black counter">0</div>
              <i class="fas fa-boxes text-4xl opacity-20 absolute bottom-2 left-2"></i>
            </div>

            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-2xl shadow-lg">
              <div class="text-sm opacity-90 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
              <div id="stat-quantity" class="text-3xl font-black counter">0</div>
              <i class="fas fa-cubes text-4xl opacity-20 absolute bottom-2 left-2"></i>
            </div>

            <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-2xl shadow-lg">
              <div class="text-sm opacity-90 mb-1">Ù†ÙˆØ§Ù‚Øµ</div>
              <div id="stat-low" class="text-3xl font-black counter">0</div>
              <i class="fas fa-exclamation-triangle text-4xl opacity-20 absolute bottom-2 left-2"></i>
            </div>

            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-2xl shadow-lg">
              <div class="text-sm opacity-90 mb-1">Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</div>
              <div id="stat-types" class="text-3xl font-black counter">0</div>
              <i class="fas fa-layer-group text-4xl opacity-20 absolute bottom-2 left-2"></i>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="fas fa-chart-pie text-purple-500"></i>
                ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
              </h3>
              <div class="h-64 flex justify-center"><canvas id="typeChart"></canvas></div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
              <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="fas fa-chart-bar text-blue-500"></i>
                Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
              </h3>
              <div class="h-64 flex justify-center"><canvas id="quantityChart"></canvas></div>
            </div>
          </div>

          <!-- Alerts -->
          <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
            <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-300 flex items-center gap-2">
              <i class="fas fa-bell text-red-500"></i>
              ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†ÙˆØ§Ù‚Øµ
            </h3>
            <div id="stock-alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
          </div>
        </section>

        <!-- History Tab (NEW) -->
        <section id="tab-history" class="h-full flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-black flex items-center gap-2">
              <i class="fas fa-history text-yellow-500"></i>
              <span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span>
            </h2>
            <button onclick="clearHistory()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow transition">
              <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
            </button>
          </div>

          <div id="history-list" class="space-y-3"></div>
        </section>

        <!-- Reports Tab (NEW) -->
        <section id="tab-reports" class="h-full flex-col hidden p-4 overflow-y-auto pb-24 lg:pb-4">
          <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
            <i class="fas fa-file-alt text-indigo-500"></i>
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Report Cards -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="generateFullReport()">
              <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-file-pdf text-2xl text-blue-600"></i>
              </div>
              <h3 class="font-bold mb-2">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">ØªÙ‚Ø±ÙŠØ± PDF ÙƒØ§Ù…Ù„ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="generateLowStockReport()">
              <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
              </div>
              <h3 class="font-bold mb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="generateValueReport()">
              <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
              </div>
              <h3 class="font-bold mb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø©</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ­Ù„ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="generateBarcodeSheet()">
              <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-barcode text-2xl text-purple-600"></i>
              </div>
              <h3 class="font-bold mb-2">Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">ÙˆØ±Ù‚Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="exportAllData()">
              <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-database text-2xl text-yellow-600"></i>
              </div>
              <h3 class="font-bold mb-2">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">ØªØµØ¯ÙŠØ± ÙƒØ§Ù…Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm card-hover cursor-pointer" onclick="importData()">
              <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-upload text-2xl text-indigo-600"></i>
              </div>
              <h3 class="font-bold mb-2">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù Excel</p>
            </div>
          </div>
        </section>

      </div>

      <!-- Bottom Navigation (Mobile) -->
      <nav class="lg:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center h-16 shrink-0 z-30 pb-safe">
        <button onclick="switchTab('chat')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-primary transition">
          <i class="fas fa-comments text-xl mb-1"></i>
          <span class="text-xs font-medium">Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
          <i class="fas fa-boxes text-xl mb-1"></i>
          <span class="text-xs font-medium">Ù…Ø®Ø²ÙˆÙ†</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
          <i class="fas fa-chart-pie text-xl mb-1"></i>
          <span class="text-xs font-medium">Ø¥Ø­ØµØ§Ø¡</span>
        </button>
        <button onclick="switchTab('history')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
          <i class="fas fa-history text-xl mb-1"></i>
          <span class="text-xs font-medium">Ø³Ø¬Ù„</span>
        </button>
        <button onclick="switchTab('reports')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
          <i class="fas fa-file-alt text-xl mb-1"></i>
          <span class="text-xs font-medium">ØªÙ‚Ø§Ø±ÙŠØ±</span>
        </button>
      </nav>
    </main>
  </div>

  <!-- Modal: Add/Edit Product -->
  <div id="modal-form" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-bounce-soft">
      <h3 class="text-xl font-bold mb-4 text-center flex items-center justify-center gap-2">
        <i class="fas fa-box text-primary"></i>
        <span>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬</span>
      </h3>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
          <input type="text" id="m-model" placeholder="Ù…Ø«Ø§Ù„: w334"
            class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none focus:ring-2 focus:ring-primary transition" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="m-type" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none focus:ring-2 focus:ring-primary transition">
            <option value="Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·">Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·</option>
            <option value="Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†">Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†</option>
            <option value="Ø¯Ø±Ø³ÙˆØ§Ø±">Ø¯Ø±Ø³ÙˆØ§Ø±</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input type="number" id="m-count" placeholder="Ø§Ù„Ø¹Ø¯Ø¯"
            class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-none outline-none focus:ring-2 focus:ring-primary transition" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„ØµÙˆØ±Ø©</label>
          <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative">
            <input type="file" id="m-img" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage()" />
            <div id="img-preview">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl font-bold hover:bg-gray-200 transition">
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button onclick="saveItem()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg hover:from-blue-700 hover:to-indigo-700 transition">
          <i class="fas fa-save ml-1"></i> Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div id="modal-settings" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-2xl shadow-2xl my-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-black flex items-center gap-2">
          <i class="fas fa-sliders text-primary"></i>
          <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </h3>
        <button onclick="closeSettings()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="space-y-4">
        <!-- TTS Settings -->
        <div class="p-4 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-900/40 dark:to-gray-800/40 border border-blue-100 dark:border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-volume-up text-blue-600"></i>
                <span>ØµÙˆØª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</span>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</div>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="set-tts-enabled" type="checkbox" class="sr-only peer" onchange="saveSettingsFromUI()">
              <div class="relative w-14 h-7 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:bg-blue-600 transition">
                <div class="absolute top-0.5 right-0.5 bg-white w-6 h-6 rounded-full transition-all peer-checked:translate-x-[-28px] shadow"></div>
              </div>
            </label>
          </div>

          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-2">
                <span>Ø§Ù„Ø³Ø±Ø¹Ø©</span>
                <span id="val-rate" class="font-bold text-blue-600">1.00</span>
              </div>
              <input id="set-rate" type="range" min="0.75" max="1.35" step="0.05" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
                oninput="previewSettingValue('rate')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="flex justify-between text-sm mb-2">
                <span>Ø§Ù„Ù†Ø¨Ø±Ø©</span>
                <span id="val-pitch" class="font-bold text-blue-600">1.00</span>
              </div>
              <input id="set-pitch" type="range" min="0.8" max="1.35" step="0.05" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
                oninput="previewSettingValue('pitch')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="flex justify-between text-sm mb-2">
                <span>Ø¹Ù„Ùˆ Ø§Ù„ØµÙˆØª</span>
                <span id="val-volume" class="font-bold text-blue-600">1.00</span>
              </div>
              <input id="set-volume" type="range" min="0" max="1" step="0.05" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
                oninput="previewSettingValue('volume')" onchange="saveSettingsFromUI()">
            </div>

            <div>
              <div class="text-sm mb-2 font-medium">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª</div>
              <select id="set-voice" 
                class="w-full p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 focus:border-blue-500 outline-none transition"
                onchange="saveSettingsFromUI()">
                <option value="">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª...</option>
              </select>
            </div>

            <div class="flex gap-2">
              <button onclick="testVoice()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold hover:from-green-600 hover:to-green-700 transition shadow">
                <i class="fas fa-play ml-1"></i> Ø§Ø®ØªØ¨Ø§Ø±
              </button>
              <button onclick="resetVoiceSettings()" class="flex-1 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 font-bold hover:bg-gray-300 transition">
                <i class="fas fa-undo ml-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
              </button>
            </div>
          </div>
        </div>

        <!-- STT Settings -->
        <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-emerald-50 dark:from-gray-900/40 dark:to-gray-800/40 border border-green-100 dark:border-gray-700">
          <div class="font-bold text-lg mb-3 flex items-center gap-2">
            <i class="fas fa-microphone text-green-600"></i>
            <span>Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</span>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400 mb-4">Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù. ÙŠØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost</div>

          <div class="space-y-3">
            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600">
              <span class="text-sm font-medium">Ù„ØºØ© Ø§Ù„ØªØ¹Ø±Ù</span>
              <select id="set-stt-lang" class="bg-transparent outline-none font-medium" onchange="saveSettingsFromUI()">
                <option value="ar-SA">ar-SA (Ø³Ø¹ÙˆØ¯ÙŠ)</option>
                <option value="ar">ar (Ø¹Ø§Ù…)</option>
                <option value="ar-EG">ar-EG (Ù…ØµØ±ÙŠ)</option>
              </select>
            </label>

            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition">
              <span class="text-sm font-medium">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ÙÙ‡Ù…</span>
              <input id="set-suggestions" type="checkbox" class="w-5 h-5 accent-green-600 cursor-pointer" onchange="saveSettingsFromUI()">
            </label>

            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition">
              <span class="text-sm font-medium">ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ (Ø£/Ø¥/Ø¢â€¦)</span>
              <input id="set-normalize" type="checkbox" class="w-5 h-5 accent-green-600 cursor-pointer" onchange="saveSettingsFromUI()">
            </label>
          </div>
        </div>

        <!-- Notification Settings -->
        <div class="p-4 rounded-xl bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-gray-900/40 dark:to-gray-800/40 border border-yellow-100 dark:border-gray-700">
          <div class="font-bold text-lg mb-3 flex items-center gap-2">
            <i class="fas fa-bell text-yellow-600"></i>
            <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
          </div>

          <div class="space-y-3">
            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition">
              <span class="text-sm font-medium">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­</span>
              <input id="set-browser-notif" type="checkbox" class="w-5 h-5 accent-yellow-600 cursor-pointer" onchange="saveSettingsFromUI(); requestNotificationPermission()">
            </label>

            <label class="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition">
              <span class="text-sm font-medium">ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</span>
              <input id="set-low-stock-alert" type="checkbox" class="w-5 h-5 accent-yellow-600 cursor-pointer" onchange="saveSettingsFromUI()">
            </label>

            <div class="p-3 rounded-xl bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600">
              <div class="text-sm font-medium mb-2">Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù†ÙˆØ§Ù‚Øµ</div>
              <input id="set-low-threshold" type="number" min="1" max="50" value="5" 
                class="w-full p-2 rounded-lg bg-gray-50 dark:bg-gray-600 border-none outline-none"
                onchange="saveSettingsFromUI()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Print Area (Hidden) -->
  <div id="print-area" class="hidden"></div>

<script>
/* ========================================
   CORE SYSTEM - Enhanced Version 9.0
======================================== */

function $(id){ return document.getElementById(id); }
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ========================================
   USER MANAGEMENT
======================================== */
const USERS = {
  1: { name: "Ø­Ø³Ù†", role: "admin", pass: "123", label: "Ù…Ø³Ø¤ÙˆÙ„" },
  2: { name: "Ù…Ø¹ØªØ²", role: "viewer", pass: "123", label: "Ù…Ø´Ø§Ù‡Ø¯" },
  3: { name: "Ù…Ø­Ù…Ø¯", role: "manager", pass: "123", label: "Ù…Ø¯ÙŠØ±" }
};
let currentUser = null;
let db;
let recognition = null;
let isListening = false;
let chartInstance = null;
let quantityChartInstance = null;
let currentFilter = 'all';

/* ========================================
   SETTINGS MANAGEMENT
======================================== */
const SETTINGS_KEY = "WarehouseV9Settings";
const defaultSettings = {
  ttsEnabled: true,
  rate: 1.0,
  pitch: 1.0,
  volume: 1.0,
  voiceURI: "",
  sttLang: "ar-SA",
  suggestions: true,
  normalizeArabic: true,
  browserNotif: false,
  lowStockAlert: true,
  lowThreshold: 5
};
let settings = loadSettings();

function loadSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(!raw) return { ...defaultSettings };
    return { ...defaultSettings, ...JSON.parse(raw) };
  }catch{ return { ...defaultSettings }; }
}

function saveSettings(){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  updateBadges();
  checkLowStockAlerts();
}

/* ========================================
   TOAST NOTIFICATIONS (NEW)
======================================== */
function showToast(message, type = 'info', duration = 3000) {
  const container = $('toast-container');
  const toast = document.createElement('div');
  
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-times-circle',
    warning: 'fa-exclamation-triangle',
    info: 'fa-info-circle'
  };
  
  toast.className = `toast ${colors[type]} text-white flex items-center gap-3`;
  toast.innerHTML = `
    <i class="fas ${icons[type]} text-xl"></i>
    <span class="flex-1">${escapeHtml(message)}</span>
    <button onclick="this.parentElement.remove()" class="hover:bg-white/20 rounded p-1">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

/* ========================================
   BROWSER NOTIFICATIONS (NEW)
======================================== */
function requestNotificationPermission() {
  if (!('Notification' in window)) {
    showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'warning');
    return;
  }
  
  if (Notification.permission === 'granted') {
    showToast('Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø©', 'success');
  } else if (Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
        new Notification('Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ', {
          body: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø© Ø§Ù„Ø¢Ù†!',
          icon: 'https://via.placeholder.com/128/2563eb/ffffff?text=ğŸ“¦'
        });
      }
    });
  }
}

function sendNotification(title, body) {
  if (!settings.browserNotif) return;
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;
  
  new Notification(title, {
    body: body,
    icon: 'https://via.placeholder.com/128/2563eb/ffffff?text=ğŸ“¦',
    badge: 'https://via.placeholder.com/96/2563eb/ffffff?text=!',
    vibrate: [200, 100, 200]
  });
}

/* ========================================
   LOW STOCK ALERTS (NEW)
======================================== */
async function checkLowStockAlerts() {
  if (!settings.lowStockAlert) return;
  
  const items = await getAll();
  const threshold = settings.lowThreshold || 5;
  const lowItems = items.filter(i => (i.count ?? 0) < threshold);
  
  if (lowItems.length > 0) {
    const message = `ØªÙ†Ø¨ÙŠÙ‡: ${lowItems.length} Ù…Ù†ØªØ¬ Ø£Ù‚Ù„ Ù…Ù† ${threshold}`;
    showToast(message, 'warning', 5000);
    sendNotification('ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', message);
    
    // Update notification badge
    const badge = $('notif-badge');
    if (badge) {
      badge.textContent = lowItems.length;
      badge.classList.remove('hidden');
    }
  }
}

function openNotifications() {
  switchTab('stats');
  setTimeout(() => {
    document.querySelector('#stock-alerts')?.scrollIntoView({ behavior: 'smooth' });
  }, 300);
}

/* ========================================
   ENVIRONMENT WARNING
======================================== */
(function showEnvWarning(){
  const isSecure = window.isSecureContext;
  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  if(!isSecure && !isLocalhost) $("env-warning").classList.remove("hidden");
})();

/* ========================================
   INDEXEDDB SETUP
======================================== */
const request = indexedDB.open("WarehouseV9", 2);

request.onupgradeneeded = (e) => {
  db = e.target.result;
  
  // Inventory store
  if (!db.objectStoreNames.contains('inventory')) {
    const store = db.createObjectStore('inventory', { keyPath: "model" });
    store.add({ model: "w334", type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", count: 15, img: "https://placehold.co/150/2563eb/ffffff?text=W334", addedDate: new Date().toISOString() });
    store.add({ model: "tv500", type: "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", count: 5, img: "https://placehold.co/150/10b981/ffffff?text=TV500", addedDate: new Date().toISOString() });
    store.add({ model: "ds110", type: "Ø¯Ø±Ø³ÙˆØ§Ø±", count: 2, img: "https://placehold.co/150/f59e0b/ffffff?text=DS110", addedDate: new Date().toISOString() });
    store.add({ model: "w120", type: "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·", count: 7, img: "https://placehold.co/150/8b5cf6/ffffff?text=W120", addedDate: new Date().toISOString() });
  }
  
  // Chats store
  if (!db.objectStoreNames.contains('chats')) {
    db.createObjectStore('chats', { keyPath: "id", autoIncrement: true });
  }
  
  // History store (NEW)
  if (!db.objectStoreNames.contains('history')) {
    const historyStore = db.createObjectStore('history', { keyPath: "id", autoIncrement: true });
    historyStore.createIndex("date", "date", { unique: false });
    historyStore.createIndex("type", "type", { unique: false });
  }
};

request.onsuccess = (e) => { 
  db = e.target.result; 
  loadChatHistory();
  loadHistory();
};

request.onerror = (e) => {
  showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
  console.error('DB Error:', e);
};

/* ========================================
   LOGIN & NAVIGATION
======================================== */
function login() {
  const id = $("user-select").value;
  const pass = $("password-input").value;

  if (USERS[id] && USERS[id].pass === pass) {
    currentUser = { ...USERS[id], id: parseInt(id, 10) };

    $("login-screen").classList.add("hidden");
    $("app-interface").classList.remove("hidden");
    $("app-interface").classList.add("flex");

    $("user-greeting-pc").innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø£Ø³ØªØ§Ø° ${currentUser.name}`;
    $("user-role-pc").innerText = currentUser.label;
    $("user-greeting-mobile").innerText = `Ø£Ø³ØªØ§Ø° ${currentUser.name}`;

    if (currentUser.role === "viewer") {
      $("btn-add-modal")?.classList.add("hidden");
    }

    initTTS();
    initSTT();
    renderInventory();
    updateStats();
    updateQuickStats();
    updateBadges();
    checkLowStockAlerts();

    showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    
    speak(buildAssistantReply({
      title: `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø³ØªØ§Ø° ${currentUser.name}`,
      body: `Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.`,
      tips: [`Ù…Ø«Ø§Ù„: ÙƒÙ… w334`, `Ù…Ø«Ø§Ù„: Ù†ÙˆØ§Ù‚Øµ`, `Ù…Ø«Ø§Ù„: Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†`]
    }));
    
    logHistory('login', `ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: ${currentUser.name}`);
  } else {
    $("login-error").classList.remove("hidden");
    showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
  }
}

function logout(){ 
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    logHistory('logout', `ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬: ${currentUser?.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}`);
    showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'info');
    setTimeout(() => location.reload(), 500);
  }
}

function switchTab(tabId) {
  // Hide all tabs
  ['chat','inventory','stats','history','reports'].forEach(id => {
    const tab = $(`tab-${id}`);
    if (tab) {
      tab.classList.add('hidden');
      tab.classList.remove('flex');
    }
  });
  
  // Show selected tab
  const active = $(`tab-${tabId}`);
  if (active) {
    active.classList.remove('hidden');
    active.classList.add('flex');
  }
  
  // Update nav buttons
  document.querySelectorAll('.nav-item, .nav-btn').forEach(btn => {
    btn.classList.remove('active', 'bg-blue-50', 'dark:bg-gray-700', 'text-primary');
    btn.classList.add('text-gray-400');
  });
  
  const activeBtn = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
  if (activeBtn) {
    activeBtn.classList.add('active', 'text-primary');
    if (activeBtn.classList.contains('nav-btn')) {
      activeBtn.classList.add('bg-blue-50', 'dark:bg-gray-700');
    }
  }
  
  // Special actions per tab
  if (tabId === 'stats') updateStats();
  if (tabId === 'history') loadHistory();
  if (tabId === 'inventory') renderInventory();
  
  logHistory('navigation', `Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰: ${tabId}`);
}

function toggleTheme(){ 
  document.documentElement.classList.toggle('dark');
  const isDark = document.documentElement.classList.contains('dark');
  showToast(isDark ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ', 'info', 2000);
  logHistory('theme', `ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±: ${isDark ? 'Ù„ÙŠÙ„ÙŠ' : 'Ù†Ù‡Ø§Ø±ÙŠ'}`);
}

/* ========================================
   SETTINGS MODAL
======================================== */
function openSettings(){
  $("modal-settings").classList.remove("hidden");
  hydrateSettingsUI();
  refreshVoices(true);
}

function closeSettings(){ 
  $("modal-settings").classList.add("hidden"); 
}

function hydrateSettingsUI(){
  $("set-tts-enabled").checked = !!settings.ttsEnabled;
  $("set-rate").value = settings.rate;
  $("set-pitch").value = settings.pitch;
  $("set-volume").value = settings.volume;
  $("set-suggestions").checked = !!settings.suggestions;
  $("set-normalize").checked = !!settings.normalizeArabic;
  $("set-stt-lang").value = settings.sttLang;
  $("set-browser-notif").checked = !!settings.browserNotif;
  $("set-low-stock-alert").checked = !!settings.lowStockAlert;
  $("set-low-threshold").value = settings.lowThreshold || 5;

  $("val-rate").innerText = Number(settings.rate).toFixed(2);
  $("val-pitch").innerText = Number(settings.pitch).toFixed(2);
  $("val-volume").innerText = Number(settings.volume).toFixed(2);
}

function previewSettingValue(which){
  if(which==='rate') $("val-rate").innerText = Number($("set-rate").value).toFixed(2);
  if(which==='pitch') $("val-pitch").innerText = Number($("set-pitch").value).toFixed(2);
  if(which==='volume') $("val-volume").innerText = Number($("set-volume").value).toFixed(2);
}

function saveSettingsFromUI(){
  settings.ttsEnabled = $("set-tts-enabled").checked;
  settings.rate = parseFloat($("set-rate").value);
  settings.pitch = parseFloat($("set-pitch").value);
  settings.volume = parseFloat($("set-volume").value);
  settings.voiceURI = $("set-voice").value || "";
  settings.suggestions = $("set-suggestions").checked;
  settings.normalizeArabic = $("set-normalize").checked;
  settings.sttLang = $("set-stt-lang").value || "ar-SA";
  settings.browserNotif = $("set-browser-notif").checked;
  settings.lowStockAlert = $("set-low-stock-alert").checked;
  settings.lowThreshold = parseInt($("set-low-threshold").value) || 5;
  
  saveSettings();

  if(recognition) recognition.lang = settings.sttLang;
  
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success', 2000);
}

function resetVoiceSettings(){
  settings.ttsEnabled = true;
  settings.rate = 1.0;
  settings.pitch = 1.0;
  settings.volume = 1.0;
  settings.voiceURI = "";
  saveSettings();
  hydrateSettingsUI();
  refreshVoices(true);
  speak("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª.");
  showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª', 'success');
}

function updateBadges(){
  $("tts-status").innerHTML = settings.ttsEnabled
    ? `<i class="fas fa-volume-up"></i> Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù‘Ù„`
    : `<i class="fas fa-volume-mute"></i> Ø§Ù„ØµÙˆØª: Ù…ØªÙˆÙ‚Ù`;
}

/* ========================================
   TTS (TEXT TO SPEECH)
======================================== */
const synth = window.speechSynthesis;
let cachedVoices = [];

function initTTS(){
  if(!('speechSynthesis' in window)) return;
  synth.onvoiceschanged = () => refreshVoices();
  setTimeout(() => refreshVoices(), 200);
  setTimeout(() => refreshVoices(), 1000);
}

function refreshVoices(force=false){
  if(!('speechSynthesis' in window)) return;
  const voices = synth.getVoices();
  if(voices.length === 0 && !force) return;
  cachedVoices = voices;

  const sel = $("set-voice");
  if(!sel) return;
  const prev = settings.voiceURI;

  sel.innerHTML = `<option value="">Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø²)</option>`;

  const ar = voices.filter(v => (v.lang||'').toLowerCase().startsWith('ar'));
  const other = voices.filter(v => !(v.lang||'').toLowerCase().startsWith('ar'));
  
  [...ar, ...other].forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} â€” ${v.lang}${v.default ? " (Ø§ÙØªØ±Ø§Ø¶ÙŠ)" : ""}`;
    sel.appendChild(opt);
  });

  if(prev) sel.value = prev;
}

function getSelectedVoice(){
  if(!settings.voiceURI) return null;
  return cachedVoices.find(v => v.voiceURI === settings.voiceURI) || null;
}

function speak(text){
  if(!('speechSynthesis' in window)) return;
  if(!settings.ttsEnabled) return;

  const cleaned = (text || "")
    .replace(/\s+/g,' ')
    .replace(/\.\s*\./g,'.')
    .trim();

  if(!cleaned) return;

  try{
    if(synth.speaking) synth.cancel();

    const u = new SpeechSynthesisUtterance(cleaned);
    u.lang = settings.sttLang || 'ar-SA';
    u.rate = settings.rate;
    u.pitch = settings.pitch;
    u.volume = settings.volume;

    const v = getSelectedVoice();
    if(v) u.voice = v;

    synth.speak(u);
  }catch(e){
    console.error('TTS Error:', e);
  }
}

function testVoice(){
  const name = currentUser?.name || "ØµØ¯ÙŠÙ‚ÙŠ";
  speak(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}. Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØµÙˆØª. Ø§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø© Ù…Ø¶Ø¨ÙˆØ·ØªØ§Ù† Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ.`);
  showToast('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª...', 'info', 2000);
}

/* ========================================
   STT (SPEECH TO TEXT)
======================================== */
function initSTT(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    setSttStatus("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­", false);
    return;
  }
  
  recognition = new SR();
  recognition.lang = settings.sttLang || 'ar-SA';
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 3;

  recognition.onstart = () => {
    isListening = true;
    $("mic-btn").classList.add("mic-active");
    setSttStatus("ÙŠØ³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†â€¦", true);
    showToast('Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙØ¹Ù‘Ù„', 'info', 2000);
  };
  
  recognition.onend = () => {
    isListening = false;
    $("mic-btn").classList.remove("mic-active");
    setSttStatus("Ù…ØªÙˆÙ‚Ù", false);
  };
  
  recognition.onerror = (e) => {
    isListening = false;
    $("mic-btn").classList.remove("mic-active");

    const msg = ({
      "not-allowed": "Ù…Ø±ÙÙˆØ¶: ÙØ¹Ù‘Ù„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù†Ø¸Ø§Ù….",
      "service-not-allowed": "Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©. Ø¬Ø±Ù‘Ø¨ Chrome/Edge Ø£Ùˆ HTTPS.",
      "audio-capture": "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­.",
      "network": "Ù…Ø´ÙƒÙ„Ø© Ø´Ø¨ÙƒØ© (Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„).",
      "no-speech": "Ù„Ù… Ø£Ù„ØªÙ‚Ø· ØµÙˆØªØ§Ù‹. Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­.",
      "aborted": "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù."
    })[e.error] || `Ø®Ø·Ø£ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${e.error}`;

    setSttStatus(msg, false);
    showToast(msg, 'error', 4000);
    
    addMsg('ai', buildAssistantReply({ 
      title: "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†", 
      body: msg, 
      tips: [
        "ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø¹Ù„Ù‰ HTTPS Ø£Ùˆ localhost",
        "Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹",
        "Ø¬Ø±Ù‘Ø¨ Chrome Ø£Ùˆ Edge"
      ]
    }));
  };

  recognition.onresult = (event) => {
    const results = event.results?.[0];
    if(!results) return;

    let best = "";
    let bestConf = -1;
    for(let i=0;i<results.length;i++){
      const t = results[i].transcript || "";
      const c = results[i].confidence ?? 0;
      if(c > bestConf){ bestConf = c; best = t; }
    }
    
    best = (best || "").trim();
    if(!best) return;

    $("chat-input").value = best;
    showToast(`ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ${best}`, 'success', 2000);
    processInput(best);
  };

  setSttStatus("Ø¬Ø§Ù‡Ø²", false);
}

function setSttStatus(text, active){
  const statusEl = $("stt-status");
  if (statusEl) {
    statusEl.innerHTML = active
      ? `<i class="fas fa-microphone"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${escapeHtml(text)}`
      : `<i class="fas fa-microphone-slash"></i> Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${escapeHtml(text)}`;
  }
}

async function toggleListening(){
  if(!recognition){
    addMsg('ai', buildAssistantReply({
      title: "Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…",
      body: "Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome Ø£Ùˆ Edge.",
      tips: ["Ø¹Ù„Ù‰ iPhone Safari Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„", "Ù„Ø§Ø²Ù… HTTPS Ø£Ùˆ localhost"]
    }));
    return;
  }

  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  if(!window.isSecureContext && !isLocalhost){
    addMsg('ai', buildAssistantReply({
      title: "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†",
      body: "Ù„Ø§Ø²Ù… HTTPS Ø£Ùˆ localhost Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª.",
      tips: ["Ø´ØºÙ‘Ù„ Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ", "Ø£Ùˆ Ø§Ø±ÙØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¶Ø§ÙØ© HTTPS"]
    }));
    return;
  }

  try{
    if(navigator.mediaDevices?.getUserMedia){
      await navigator.mediaDevices.getUserMedia({ audio: true });
    }
  }catch(err){
    addMsg('ai', buildAssistantReply({
      title: "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø±ÙÙˆØ¶Ø©",
      body: "ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¬Ù‡Ø§Ø² Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.",
      tips: ["Settings > Site settings > Microphone", "ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ù…ÙˆØ­"]
    }));
    return;
  }

  try{
    if(isListening){
      recognition.stop();
    }else{
      recognition.start();
    }
  }catch(e){
    setSttStatus("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©", false);
    showToast('Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'warning', 2000);
  }
}

/* ========================================
   SMART UNDERSTANDING
======================================== */
function normalizeArabicText(s){
  if(!settings.normalizeArabic) return (s||"").toLowerCase().trim();
  return (s||"")
    .toLowerCase()
    .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,'')
    .replace(/[Ø¥Ø£Ø¢Ø§]/g,'Ø§')
    .replace(/Ù‰/g,'ÙŠ')
    .replace(/Ø¤/g,'Ùˆ')
    .replace(/Ø¦/g,'ÙŠ')
    .replace(/Ø©/g,'Ù‡')
    .replace(/Ù€/g,'')
    .replace(/[^\p{L}\p{N}\s]/gu,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function tokens(s){ 
  return normalizeArabicText(s).split(' ').filter(Boolean); 
}

const TYPE_SYNONYMS = {
  "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·": ["Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·","Ø·Ø§ÙˆÙ„Ù‡ ÙˆØ³Ø·","Ø·Ø§ÙˆÙ„Ø©","Ø·Ø§ÙˆÙ„Ù‡","ÙˆØ³Ø·","ØªØ±Ø§Ø¨ÙŠØ²Ù‡ ÙˆØ³Ø·","ØªØ±Ø§Ø¨ÙŠØ²Ù‡"],
  "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†": ["Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†","Ø·Ø§ÙˆÙ„Ù‡ ØªÙ„ÙØ²ÙŠÙˆÙ†","ØªÙ„ÙØ²ÙŠÙˆÙ†","tv","ØªÙŠ ÙÙŠ","Ø·Ø§ÙˆÙ„Ø© tv","Ø·Ø§ÙˆÙ„Ù‡ tv","Ø·Ø§ÙˆÙ„Ø© Ø´Ø§Ø´Ù‡","Ø·Ø§ÙˆÙ„Ø© Ø´Ø§Ø´Ø©","Ø´Ø§Ø´Ø©"],
  "Ø¯Ø±Ø³ÙˆØ§Ø±": ["Ø¯Ø±Ø³ÙˆØ§Ø±","Ø¯Ø±ÙŠØ³ÙˆØ§Ø±","ØªØ³Ø±ÙŠØ­Ù‡","ØªØ³Ø±ÙŠØ­Ù‡ Ù…Ø¯Ø®Ù„","ÙƒÙˆÙ†Ø³ÙˆÙ„","ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù…Ø¯Ø®Ù„","Ù…Ø¯Ø®Ù„"]
};

function levenshtein(a,b){
  a = a || ""; b = b || "";
  const m=a.length,n=b.length;
  if(!m) return n; if(!n) return m;
  const dp = Array.from({length:m+1}, (_,i)=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}

function similarity(a,b){
  a = normalizeArabicText(a); b = normalizeArabicText(b);
  if(!a || !b) return 0;
  if(a===b) return 1;
  const dist = levenshtein(a,b);
  return 1 - dist / Math.max(a.length,b.length);
}

function extractModels(raw){
  const m = (raw||"").match(/[a-z]+\d+/gi);
  return m ? m.map(x=>x.toLowerCase()) : [];
}

function detectTypeFromQuery(qNorm){
  let best = { type: null, score: 0 };
  for(const [type, variants] of Object.entries(TYPE_SYNONYMS)){
    for(const v of variants){
      if(qNorm.includes(normalizeArabicText(v))){
        return type;
      }
      const s = similarity(qNorm, v);
      if(s > best.score){
        best = { type, score: s };
      }
    }
  }
  return best.score >= 0.72 ? best.type : null;
}

function parseIntent(raw){
  const q = normalizeArabicText(raw);
  const toks = tokens(raw);

  const isAll = /(Ø§Ù„ÙƒÙ„|Ø¬Ø±Ø¯|Ø¬Ø±Ø¯Ù‡|inventory|ÙƒÙ„ Ø§Ù„Ø§ØµÙ†Ø§Ù|ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)/.test(q);
  const isLow = /(Ù†Ø§Ù‚Øµ|Ù†ÙˆØ§Ù‚Øµ|Ù‚Ù„ÙŠÙ„|Ø§Ù‚Ù„ Ù…Ù†|Ù…Ù†Ø®ÙØ¶|ØªÙ†Ø¨ÙŠÙ‡)/.test(q);
  const isCount = /(ÙƒÙ…|Ø¹Ø¯Ø¯|ÙƒÙ…ÙŠÙ‡|ÙƒÙ…ÙŠØ©)/.test(q);
  const isShow = /(Ø§Ø¹Ø±Ø¶|Ø¹Ø±Ø¶|Ù‡Ø§Øª|Ø¬ÙŠØ¨|Ø·Ù„Ù‘Ø¹|Ø·Ù„Ø¹|ÙˆØ±ÙŠÙ†ÙŠ|Ø§Ø±Ù†ÙŠ)/.test(q);

  let lessThan = null;
  const m = q.match(/Ø§Ù‚Ù„ Ù…Ù†\s*(\d+)/);
  if(m) lessThan = parseInt(m[1],10);

  const models = extractModels(raw);
  const type = detectTypeFromQuery(q);

  return { q, toks, isAll, isLow, isCount, isShow, lessThan, models, type };
}

function buildAssistantReply({title="", body="", tips=[]}){
  let out = "";
  if(title) out += `${title}. `;
  if(body) out += `${body} `;
  if(tips?.length){
    out += "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ";
    out += tips.slice(0,3).map(t=>t.replace(/\.$/,'')).join("ØŒ ");
    out += ".";
  }
  return out.replace(/\s+/g,' ').trim();
}

function scoreItem(item, intent){
  const model = (item.model||"").toLowerCase();
  const type = item.type || "";
  const q = intent.q;
  const toks = intent.toks;

  let score = 0;

  if(intent.models.length && intent.models.includes(model)) score += 120;
  if(q.includes(model)) score += 80;
  if(model.startsWith(q) && q.length>=2) score += 50;

  if(intent.type && item.type === intent.type) score += 70;

  const typeNorm = normalizeArabicText(type);
  toks.forEach(t=>{
    if(t.length<2) return;
    if(model.includes(t)) score += 14;
    if(typeNorm.includes(t)) score += 16;
  });

  if(q.length >= 3){
    score += Math.round(similarity(q, model) * 35);
    score += Math.round(similarity(q, type) * 25);
  }

  return score;
}

/* ========================================
   CHAT FLOW
======================================== */
function handleEnter(e){ 
  if(e.key === 'Enter') processInput(); 
}

async function processInput(forcedText=null){
  const input = $("chat-input");
  const raw = (forcedText ?? input.value ?? "").trim();
  if(!raw) return;

  addMsg('user', raw);
  input.value = "";

  const allItems = await getAll();
  const intent = parseIntent(raw);

  logHistory('chat', `Ø§Ø³ØªØ¹Ù„Ø§Ù…: ${raw}`);

  // Intent: all inventory
  if(intent.isAll){
    const data = allItems;
    const reply = buildAssistantReply({
      title: `ØªÙØ¶Ù„ Ø£Ø³ØªØ§Ø° ${currentUser.name}`,
      body: `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${data.length}.`
    });
    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Intent: low stock
  if(intent.isLow || intent.lessThan !== null){
    const th = intent.lessThan ?? settings.lowThreshold;
    const data = allItems.filter(i => (i.count ?? 0) < th);
    const reply = data.length
      ? buildAssistantReply({ title: "ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙˆØ§Ù‚Øµ", body: `ÙˆØ¬Ø¯Øª ${data.length} Ø£ØµÙ†Ø§Ù Ø£Ù‚Ù„ Ù…Ù† ${th}.` })
      : buildAssistantReply({ title: "ØªÙ…Ø§Ù…", body: `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ø£Ù‚Ù„ Ù…Ù† ${th}.` });

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Model direct query
  if(intent.models.length){
    const found = allItems.filter(i => intent.models.includes((i.model||"").toLowerCase()));
    if(found.length){
      let reply = "";
      if(intent.isCount && found.length === 1){
        reply = buildAssistantReply({
          title: "Ø§Ù„ÙƒÙ…ÙŠØ©",
          body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${found[0].model.toUpperCase()} Ø¹Ø¯Ø¯Ù‡ ${found[0].count}.`
        });
      }else{
        reply = buildAssistantReply({
          title: `ÙˆØ¬Ø¯Øª ${found.length} Ù†ØªÙŠØ¬Ø©`,
          body: `Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø·Ù„Ø¨Ùƒ.`
        });
      }
      speak(reply);
      addMsg('ai', reply, found);
    }else{
      const reply = buildAssistantReply({
        title: "Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„",
        body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„: ${intent.models.join(", ").toUpperCase()}.`,
        tips: ["ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù…Ø«Ù„ w334", "Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†ÙˆØ¹ Ù…Ø«Ù„ Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·"]
      });
      speak(reply);
      addMsg('ai', reply);
    }
    return;
  }

  // Type direct query
  if(intent.type){
    const data = allItems.filter(i => i.type === intent.type);
    const reply = data.length
      ? buildAssistantReply({ title: "Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹", body: `Ù†ÙˆØ¹: ${intent.type}. Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${data.length}.` })
      : buildAssistantReply({ title: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬", body: `Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù†ÙˆØ¹ ${intent.type}.` });

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Ranked fuzzy search
  const ranked = allItems
    .map(item => ({ item, score: scoreItem(item, intent) }))
    .filter(x => x.score >= 25)
    .sort((a,b)=> b.score - a.score);

  if(ranked.length){
    const data = ranked.slice(0, 12).map(x=>x.item);
    const top = ranked[0];
    
    let reply = "";
    if(intent.isCount && top.score >= 90){
      reply = buildAssistantReply({
        title: "Ø£Ù‚Ø±Ø¨ Ù†ØªÙŠØ¬Ø©",
        body: `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${top.item.model.toUpperCase()} Ø¹Ø¯Ø¯Ù‡ ${top.item.count}.`
      });
    }else{
      reply = buildAssistantReply({
        title: "ÙˆØ¬Ø¯Øª Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±ÙŠØ¨Ø©",
        body: `Ù‡Ø°Ù‡ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø·Ù„Ø¨Ùƒ. Ù„Ùˆ ØªÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø£Ø¯Ù‚ ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙØ¶Ù„.`
      });
    }

    speak(reply);
    addMsg('ai', reply, data);
    return;
  }

  // Not understood
  const reply = settings.suggestions
    ? buildAssistantReply({
        title: `Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø·Ù„Ø¨`,
        body: `Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ù†ÙˆØ¹.`,
        tips: ["ÙƒÙ… w334", "Ù†ÙˆØ§Ù‚Øµ", "Ø¬Ø±Ø¯", "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ²ÙŠÙˆÙ†", "Ø¯Ø±Ø³ÙˆØ§Ø±"]
      })
    : `Ù„Ù… Ø£ÙÙ‡Ù….`;

  speak(reply);
  addMsg('ai', reply);
}

function addMsg(sender, text, data=[]){
  const box = $("chat-box");
  const div = document.createElement('div');
  div.className = `flex ${sender==='user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

  const safeText = escapeHtml(text).replaceAll("\n","<br>");
  let html = `<div class="max-w-[85%] p-4 rounded-2xl shadow-md ${sender==='user'
    ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-br-none'
    : 'bg-white dark:bg-gray-700 rounded-bl-none'}">
      <p class="text-sm md:text-base leading-6">${safeText}</p>`;

  if(data?.length){
    html += `<div class="mt-3 grid grid-cols-2 gap-2">`;
    data.forEach(i=>{
      const isLow = (i.count ?? 0) < settings.lowThreshold;
      html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded-lg border ${isLow ? 'border-red-300' : 'border-gray-200'} dark:border-gray-500 text-center hover:shadow-lg transition cursor-pointer" onclick="showItemDetails('${i.model}')">
        <img src="${i.img}" class="w-full h-16 object-cover rounded mb-1" alt="img" onerror="this.src='https://placehold.co/150/cccccc/666666?text=NO+IMG'">
        <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</div>
        <div class="text-xs text-gray-500 dark:text-gray-300 mb-1">${escapeHtml(i.type||'')}</div>
        <div class="font-bold ${isLow ? 'text-red-600' : 'text-green-600'}">${escapeHtml(i.count)}</div>
      </div>`;
    });
    html += `</div>`;
  }

  html += `</div>`;
  div.innerHTML = html;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  if(db){
    const tx = db.transaction("chats","readwrite");
    tx.objectStore("chats").add({ sender, text, data, time: new Date() });
  }
}

function loadChatHistory(){
  if(!db) return;
  const tx = db.transaction("chats","readonly");
  tx.objectStore("chats").getAll().onsuccess = (e)=>{
    const box = $("chat-box");
    box.innerHTML = "";
    (e.target.result||[]).forEach(msg=>{
      const div = document.createElement('div');
      div.className = `flex ${msg.sender==='user' ? 'justify-end' : 'justify-start'}`;
      const safeText = escapeHtml(msg.text).replaceAll("\n","<br>");

      let html = `<div class="max-w-[85%] p-4 rounded-2xl shadow-md ${msg.sender==='user'
        ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-br-none'
        : 'bg-white dark:bg-gray-700 rounded-bl-none'}">
        <p class="text-sm md:text-base leading-6">${safeText}</p>`;

      if(msg.data?.length){
        html += `<div class="mt-3 grid grid-cols-2 gap-2">`;
        msg.data.forEach(i=>{
          const isLow = (i.count ?? 0) < settings.lowThreshold;
          html += `<div class="bg-gray-50 dark:bg-gray-600 p-2 rounded-lg border ${isLow ? 'border-red-300' : 'border-gray-200'} dark:border-gray-500 text-center">
            <img src="${i.img}" class="w-full h-16 object-cover rounded mb-1" alt="img" onerror="this.src='https://placehold.co/150/cccccc/666666?text=NO+IMG'">
            <div class="text-xs font-bold text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</div>
            <div class="text-xs text-gray-500 dark:text-gray-300 mb-1">${escapeHtml(i.type||'')}</div>
            <div class="font-bold ${isLow ? 'text-red-600' : 'text-green-600'}">${escapeHtml(i.count)}</div>
          </div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      div.innerHTML = html;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  };
}

function clearChat(){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§ØªØŸ')) return;
  if(!db) return;
  const tx = db.transaction("chats","readwrite");
  tx.objectStore("chats").clear();
  $("chat-box").innerHTML = "";
  showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª', 'success');
  logHistory('chat', 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª');
}

function exportChatText(){
  if(!db) return;
  const tx = db.transaction("chats","readonly");
  tx.objectStore("chats").getAll().onsuccess = (e)=>{
    let text = "=== Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ ===\n\n";
    (e.target.result||[]).forEach(msg=>{
      text += `[${msg.sender === 'user' ? 'Ø£Ù†Øª' : 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯'}]: ${msg.text}\n`;
      if(msg.data?.length){
        text += `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${msg.data.map(i=>`${i.model} (${i.count})`).join(', ')}\n`;
      }
      text += '\n';
    });
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª', 'success');
    logHistory('export', 'ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (Ù†Øµ)');
  };
}

/* ========================================
   INVENTORY MANAGEMENT
======================================== */
async function getAll(){
  return new Promise(res=>{
    if(!db) return res([]);
    db.transaction("inventory","readonly").objectStore("inventory").getAll().onsuccess = e => res(e.target.result || []);
  });
}

async function renderInventory(){
  const items = await getAll();
  const q = normalizeArabicText($("inventory-search")?.value || "");
  const grid = $("inventory-grid");
  if (!grid) return;
  
  grid.innerHTML = "";

  let filtered = items;
  
  // Apply type filter
  if (currentFilter !== 'all') {
    if (currentFilter === 'low') {
      filtered = items.filter(i => (i.count ?? 0) < settings.lowThreshold);
    } else {
      filtered = items.filter(i => i.type === currentFilter);
    }
  }
  
  // Apply search filter
  if (q) {
    filtered = filtered.filter(i=>{
      const model = (i.model||"").toLowerCase();
      const type = normalizeArabicText(i.type||"");
      return model.includes(q) || type.includes(q) || similarity(q, model) >= 0.72 || similarity(q, type) >= 0.72;
    });
  }

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full text-center py-12">
        <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>
      </div>
    `;
    return;
  }

  filtered.forEach(i=>{
    const isLow = (i.count ?? 0) < settings.lowThreshold;
    grid.innerHTML += `
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 relative border-t-4 ${isLow ? 'border-red-500' : 'border-green-500'} card-hover">
        ${isLow ? '<div class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full"><i class="fas fa-exclamation-triangle"></i> Ù†Ø§Ù‚Øµ</div>' : ''}
        
        <img src="${i.img}" class="w-full h-32 object-cover rounded-lg bg-gray-100 mb-3 cursor-pointer hover:opacity-80 transition" 
          alt="img" 
          onerror="this.src='https://placehold.co/300/cccccc/666666?text=NO+IMAGE'"
          onclick="showItemDetails('${i.model}')">
        
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h3 class="font-bold text-lg text-gray-800 dark:text-white">${escapeHtml((i.model||'').toUpperCase())}</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
              <i class="fas fa-tag"></i>
              ${escapeHtml(i.type||'')}
            </p>
          </div>
          <span class="text-2xl font-black ${isLow ? 'text-red-600' : 'text-green-600'}">${escapeHtml(i.count)}</span>
        </div>

        ${currentUser?.role !== 'viewer' ? `
        <div class="mt-3 flex justify-end gap-2 border-t pt-3 dark:border-gray-700">
          <button onclick="editItem('${i.model}')" class="flex-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 py-2 rounded-lg hover:bg-blue-200 transition text-sm font-medium" title="ØªØ¹Ø¯ÙŠÙ„">
            <i class="fas fa-edit ml-1"></i> ØªØ¹Ø¯ÙŠÙ„
          </button>
          ${currentUser?.role === 'admin' ? `
          <button onclick="delItem('${i.model}')" class="bg-red-100 dark:bg-red-900/30 text-red-600 px-3 py-2 rounded-lg hover:bg-red-200 transition" title="Ø­Ø°Ù">
            <i class="fas fa-trash"></i>
          </button>` : ''}
        </div>` : ''}
      </div>`;
  });
  
  updateQuickStats();
}

function filterByType(type) {
  currentFilter = type;
  
  // Update button styles
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
    btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
  });
  
  event.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
  event.target.classList.add('bg-primary', 'text-white');
  
  renderInventory();
  logHistory('filter', `ØªØµÙÙŠØ© Ø­Ø³Ø¨: ${type}`);
}

function showItemDetails(model) {
  if (!db) return;
  
  db.transaction("inventory","readonly").objectStore("inventory").get(model).onsuccess = e => {
    const item = e.target.result;
    if (!item) return;
    
    const isLow = (item.count ?? 0) < settings.lowThreshold;
    
    const details = `
      <div class="text-center">
        <img src="${item.img}" class="w-48 h-48 object-cover rounded-xl mx-auto mb-4 shadow-lg" onerror="this.src='https://placehold.co/300/cccccc/666666?text=NO+IMAGE'">
        <h3 class="text-2xl font-black mb-2">${escapeHtml(item.model.toUpperCase())}</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">${escapeHtml(item.type)}</p>
        <div class="text-4xl font-black ${isLow ? 'text-red-600' : 'text-green-600'} mb-2">${item.count}</div>
        <p class="text-sm text-gray-500">${isLow ? 'âš ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶' : 'âœ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¬ÙŠØ¯'}</p>
      </div>
    `;
    
    speak(`Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${item.model.toUpperCase()}. Ø§Ù„Ù†ÙˆØ¹ ${item.type}. Ø§Ù„ÙƒÙ…ÙŠØ© ${item.count}.`);
    addMsg('ai', details);
    switchTab('chat');
  };
}

function openAddModal(){ 
  $("m-model").value = "";
  $("m-type").value = "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·";
  $("m-count").value = "";
  $("m-img").value = "";
  $("img-preview").innerHTML = `
    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
    <p class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
  `;
  $("modal-form").classList.remove("hidden"); 
}

function closeModal(){ 
  $("modal-form").classList.add("hidden"); 
}

function previewImage() {
  const file = $("m-img").files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = e => {
    $("img-preview").innerHTML = `
      <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg">
      <p class="text-xs text-green-600 mt-2"><i class="fas fa-check"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p>
    `;
  };
  reader.readAsDataURL(file);
}

function saveItem(){
  const model = ($("m-model").value || "").trim().toLowerCase();
  const type = $("m-type").value;
  const count = parseInt($("m-count").value, 10);
  const imgInput = $("m-img");

  if(!model || Number.isNaN(count)) {
    showToast('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = e=>{
    const img = imgInput.files[0] ? e.target.result : `https://placehold.co/300/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${model.toUpperCase()}`;
    const tx = db.transaction("inventory","readwrite");
    const item = { 
      model, 
      type, 
      count, 
      img,
      addedDate: new Date().toISOString(),
      lastModified: new Date().toISOString()
    };
    
    tx.objectStore("inventory").put(item);
    tx.oncomplete = ()=>{ 
      closeModal(); 
      renderInventory(); 
      updateStats();
      updateQuickStats();
      checkLowStockAlerts();
      
      showToast(`ØªÙ… Ø­ÙØ¸ ${model.toUpperCase()} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      speak(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${model.toUpperCase()}.`);
      logHistory('inventory', `Ø­ÙØ¸ Ù…Ù†ØªØ¬: ${model.toUpperCase()}`);
    };
  };
  
  if(imgInput.files[0]) {
    reader.readAsDataURL(imgInput.files[0]);
  } else {
    reader.onload({target:{result:null}});
  }
}

function delItem(model){
  if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${model.toUpperCase()}ØŸ`)) return;
  
  const tx = db.transaction("inventory","readwrite");
  tx.objectStore("inventory").delete(model);
  tx.oncomplete = ()=>{ 
    renderInventory(); 
    updateStats();
    updateQuickStats();
    
    showToast(`ØªÙ… Ø­Ø°Ù ${model.toUpperCase()}`, 'success');
    logHistory('inventory', `Ø­Ø°Ù Ù…Ù†ØªØ¬: ${model.toUpperCase()}`);
  };
}

function editItem(model){
  db.transaction("inventory","readonly").objectStore("inventory").get(model).onsuccess = e=>{
    const i = e.target.result;
    if(!i) return;
    
    $("m-model").value = i.model;
    $("m-type").value = i.type;
    $("m-count").value = i.count;
    
    if (i.img) {
      $("img-preview").innerHTML = `
        <img src="${i.img}" class="w-full h-32 object-cover rounded-lg">
        <p class="text-xs text-blue-600 mt-2">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
      `;
    }
    
    openAddModal();
    logHistory('inventory', `ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬: ${model.toUpperCase()}`);
  };
}

/* ========================================
   STATISTICS & CHARTS
======================================== */
async function updateQuickStats() {
  const items = await getAll();
  const total = items.length;
  const low = items.filter(i => (i.count ?? 0) < settings.lowThreshold).length;
  
  const totalEl = $("quick-total");
  const lowEl = $("quick-low");
  
  if (totalEl) animateCounter(totalEl, total);
  if (lowEl) animateCounter(lowEl, low);
}

function animateCounter(element, target) {
  const current = parseInt(element.textContent) || 0;
  const increment = target > current ? 1 : -1;
  const duration = 500;
  const steps = Math.abs(target - current);
  const stepDuration = steps > 0 ? duration / steps : 0;
  
  let count = current;
  const timer = setInterval(() => {
    count += increment;
    element.textContent = count;
    
    if (count === target) {
      clearInterval(timer);
    }
  }, stepDuration);
}

async function updateStats(){
  const items = await getAll();
  const types = {};
  const quantities = {};
  const low = [];

  items.forEach(i=>{
    const t = i.type || "ØºÙŠØ± Ù…ØµÙ†Ù";
    types[t] = (types[t]||0) + 1;
    quantities[t] = (quantities[t]||0) + (i.count||0);
    
    if((i.count||0) < settings.lowThreshold) low.push(i);
  });

  // Update summary cards
  $("stat-total").textContent = items.length;
  $("stat-quantity").textContent = items.reduce((sum, i) => sum + (i.count || 0), 0);
  $("stat-low").textContent = low.length;
  $("stat-types").textContent = Object.keys(types).length;

  // Type distribution chart
  if(chartInstance) chartInstance.destroy();
  if($("typeChart")){
    chartInstance = new Chart($("typeChart"), {
      type: 'doughnut',
      data: { 
        labels: Object.keys(types),
        datasets: [{
          data: Object.values(types),
          backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'],
          borderWidth: 0
        }]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Quantity chart
  if(quantityChartInstance) quantityChartInstance.destroy();
  if($("quantityChart")){
    quantityChartInstance = new Chart($("quantityChart"), {
      type: 'bar',
      data: { 
        labels: Object.keys(quantities),
        datasets: [{
          label: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
          data: Object.values(quantities),
          backgroundColor: '#3b82f6',
          borderRadius: 8
        }]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Stock alerts
  const alerts = $("stock-alerts");
  if(alerts){
    alerts.innerHTML = low.length ? "" : '<p class="text-green-500 text-sm flex items-center gap-2"><i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù…ØªØ§Ø²ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ</p>';
    low.forEach(i=>{
      alerts.innerHTML += `
        <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg text-sm hover:bg-red-100 dark:hover:bg-red-900/40 transition cursor-pointer" onclick="showItemDetails('${i.model}')">
          <div class="flex items-center gap-2">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="font-medium">${escapeHtml(i.model.toUpperCase())}</span>
            <span class="text-xs text-gray-500">â€” ${escapeHtml(i.type)}</span>
          </div>
          <b class="text-lg">${escapeHtml(i.count)}</b>
        </div>`;
    });
  }
}

/* ========================================
   HISTORY LOG (NEW)
======================================== */
function logHistory(type, description) {
  if (!db) return;
  
  const tx = db.transaction("history", "readwrite");
  tx.objectStore("history").add({
    type,
    description,
    user: currentUser?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
    date: new Date().toISOString()
  });
}

async function loadHistory() {
  if (!db) return;
  
  const tx = db.transaction("history", "readonly");
  const index = tx.objectStore("history").index("date");
  
  index.openCursor(null, 'prev').onsuccess = e => {
    const cursor = e.target.result;
    const list = $("history-list");
    if (!list) return;
    
    if (!cursor) {
      if (list.innerHTML === "") {
        list.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-history text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª</p>
          </div>
        `;
      }
      return;
    }
    
    if (list.innerHTML.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„')) {
      list.innerHTML = "";
    }
    
    const record = cursor.value;
    const date = new Date(record.date);
    const timeStr = date.toLocaleString('ar-SA', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const icons = {
      login: 'fa-sign-in-alt text-green-500',
      logout: 'fa-sign-out-alt text-red-500',
      chat: 'fa-comments text-blue-500',
      inventory: 'fa-boxes text-purple-500',
      export: 'fa-download text-yellow-500',
      filter: 'fa-filter text-indigo-500',
      navigation: 'fa-compass text-pink-500',
      theme: 'fa-moon text-gray-500'
    };
    
    const icon = icons[record.type] || 'fa-circle text-gray-400';
    
    list.innerHTML += `
      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex items-start gap-3 hover:shadow-md transition">
        <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center shrink-0">
          <i class="fas ${icon}"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-medium text-gray-800 dark:text-white">${escapeHtml(record.description)}</p>
          <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 dark:text-gray-400">
            <span><i class="fas fa-user ml-1"></i>${escapeHtml(record.user)}</span>
            <span><i class="fas fa-clock ml-1"></i>${timeStr}</span>
          </div>
        </div>
      </div>
    `;
    
    cursor.continue();
  };
}

function clearHistory() {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§ØªØŸ')) return;
  
  const tx = db.transaction("history", "readwrite");
  tx.objectStore("history").clear();
  tx.oncomplete = () => {
    $("history-list").innerHTML = `
      <div class="text-center py-12">
        <i class="fas fa-history text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª</p>
      </div>
    `;
    showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'success');
  };
}

/* ========================================
   EXPORT & REPORTS
======================================== */
async function exportExcel(){
  const items = await getAll();
  const data = items.map(i => ({
    'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„': i.model.toUpperCase(),
    'Ø§Ù„Ù†ÙˆØ¹': i.type,
    'Ø§Ù„ÙƒÙ…ÙŠØ©': i.count,
    'Ø§Ù„Ø­Ø§Ù„Ø©': (i.count ?? 0) < settings.lowThreshold ? 'Ù†Ø§Ù‚Øµ' : 'Ø¬ÙŠØ¯'
  }));
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
  XLSX.writeFile(wb, `warehouse-${Date.now()}.xlsx`);
  
  showToast('ØªÙ… ØªØµØ¯ÙŠØ± Excel Ø¨Ù†Ø¬Ø§Ø­', 'success');
  logHistory('export', 'ØªØµØ¯ÙŠØ± Excel');
}

/* ========================================
   EXPORT & REPORTS (ØªØ§Ø¨Ø¹)
======================================== */
function exportChatPDF(){
  const chatBox = $("chat-box");
  if (!chatBox) return;
  
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...', 'info', 2000);
  
  html2canvas(chatBox, { scale: 2 }).then(canvas => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const imgData = canvas.toDataURL('image/png');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    
    let heightLeft = pdfHeight;
    let position = 0;
    
    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
    heightLeft -= pdf.internal.pageSize.getHeight();
    
    while (heightLeft >= 0) {
      position = heightLeft - pdfHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
      heightLeft -= pdf.internal.pageSize.getHeight();
    }
    
    pdf.save(`chat-${Date.now()}.pdf`);
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ù†Ø¬Ø§Ø­', 'success');
    logHistory('export', 'ØªØµØ¯ÙŠØ± Ù…Ø­Ø§Ø¯Ø«Ø§Øª PDF');
  }).catch(err => {
    console.error('PDF Error:', err);
    showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF', 'error');
  });
}

function shareWhatsApp(){
  const text = "ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ\n\nØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…";
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  logHistory('export', 'Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨');
}

async function printInventory() {
  const items = await getAll();
  const printArea = $("print-area");
  
  let html = `
    <div style="font-family: 'Tajawal', Arial, sans-serif; padding: 20px; direction: rtl;">
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px;">
        <h1 style="font-size: 32px; color: #2563eb; margin: 0;">ğŸ“¦ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p style="color: #666; margin: 10px 0;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒØ§Ù…Ù„</p>
        <p style="color: #999; font-size: 14px;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p>
      </div>
      
      <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <div style="background: #eff6ff; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 14px; color: #666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div style="font-size: 28px; font-weight: bold; color: #2563eb;">${items.length}</div>
        </div>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 14px; color: #666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
          <div style="font-size: 28px; font-weight: bold; color: #10b981;">${items.reduce((s,i)=>s+(i.count||0),0)}</div>
        </div>
        <div style="background: #fef2f2; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 14px; color: #666;">Ù†ÙˆØ§Ù‚Øµ</div>
          <div style="font-size: 28px; font-weight: bold; color: #ef4444;">${items.filter(i=>(i.count||0)<settings.lowThreshold).length}</div>
        </div>
      </div>
      
      <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
          <tr style="background: #2563eb; color: white;">
            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">#</th>
            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ù†ÙˆØ¹</th>
            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  items.forEach((item, idx) => {
    const isLow = (item.count ?? 0) < settings.lowThreshold;
    html += `
      <tr style="background: ${idx % 2 === 0 ? '#f9fafb' : 'white'};">
        <td style="padding: 10px; border: 1px solid #ddd;">${idx + 1}</td>
        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${escapeHtml(item.model.toUpperCase())}</td>
        <td style="padding: 10px; border: 1px solid #ddd;">${escapeHtml(item.type)}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${isLow ? '#ef4444' : '#10b981'};">${item.count}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
          <span style="background: ${isLow ? '#fee2e2' : '#d1fae5'}; color: ${isLow ? '#991b1b' : '#065f46'}; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
            ${isLow ? 'âš ï¸ Ù†Ø§Ù‚Øµ' : 'âœ… Ø¬ÙŠØ¯'}
          </span>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #999; font-size: 12px;">
        <p>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser?.name || 'Ø§Ù„Ù†Ø¸Ø§Ù…'} | ${new Date().toLocaleString('ar-SA')}</p>
        <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ Pro V9 - Ultimate Edition</p>
      </div>
    </div>
  `;
  
  printArea.innerHTML = html;
  printArea.classList.remove('hidden');
  
  setTimeout(() => {
    window.print();
    printArea.classList.add('hidden');
    printArea.innerHTML = '';
  }, 500);
  
  logHistory('export', 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
}

/* ========================================
   ADVANCED REPORTS (NEW)
======================================== */
async function generateFullReport() {
  const items = await getAll();
  
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„...', 'info', 2000);
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  // Header
  pdf.setFontSize(24);
  pdf.setTextColor(37, 99, 235);
  pdf.text('Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ', 105, 20, { align: 'center' });
  
  pdf.setFontSize(16);
  pdf.setTextColor(100, 100, 100);
  pdf.text('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', 105, 30, { align: 'center' });
  
  pdf.setFontSize(10);
  pdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`, 105, 38, { align: 'center' });
  pdf.text(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 105, 44, { align: 'center' });
  
  // Summary
  let y = 55;
  pdf.setFontSize(14);
  pdf.setTextColor(0, 0, 0);
  pdf.text('Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', 20, y);
  
  y += 10;
  pdf.setFontSize(11);
  pdf.text(`â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${items.length}`, 25, y);
  y += 7;
  pdf.text(`â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: ${items.reduce((s,i)=>s+(i.count||0),0)}`, 25, y);
  y += 7;
  const lowCount = items.filter(i=>(i.count||0)<settings.lowThreshold).length;
  pdf.text(`â€¢ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ: ${lowCount}`, 25, y);
  
  // Table
  y += 15;
  pdf.setFontSize(12);
  pdf.text('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', 20, y);
  
  y += 10;
  pdf.setFontSize(9);
  
  // Table header
  pdf.setFillColor(37, 99, 235);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(20, y - 5, 170, 8, 'F');
  pdf.text('#', 25, y);
  pdf.text('Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„', 45, y);
  pdf.text('Ø§Ù„Ù†ÙˆØ¹', 85, y);
  pdf.text('Ø§Ù„ÙƒÙ…ÙŠØ©', 135, y);
  pdf.text('Ø§Ù„Ø­Ø§Ù„Ø©', 165, y);
  
  y += 10;
  pdf.setTextColor(0, 0, 0);
  
  items.forEach((item, idx) => {
    if (y > 270) {
      pdf.addPage();
      y = 20;
    }
    
    const isLow = (item.count ?? 0) < settings.lowThreshold;
    
    pdf.text(`${idx + 1}`, 25, y);
    pdf.text(item.model.toUpperCase(), 45, y);
    pdf.text(item.type, 85, y);
    pdf.text(`${item.count}`, 135, y);
    pdf.setTextColor(isLow ? 239 : 16, isLow ? 68 : 185, isLow ? 68 : 129);
    pdf.text(isLow ? 'Ù†Ø§Ù‚Øµ' : 'Ø¬ÙŠØ¯', 165, y);
    pdf.setTextColor(0, 0, 0);
    
    y += 8;
  });
  
  // Footer
  pdf.setFontSize(8);
  pdf.setTextColor(150, 150, 150);
  const pageCount = pdf.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    pdf.setPage(i);
    pdf.text(`ØµÙØ­Ø© ${i} Ù…Ù† ${pageCount}`, 105, 290, { align: 'center' });
  }
  
  pdf.save(`full-report-${Date.now()}.pdf`);
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
  logHistory('export', 'ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ PDF');
}

async function generateLowStockReport() {
  const items = await getAll();
  const lowItems = items.filter(i => (i.count ?? 0) < settings.lowThreshold);
  
  if (lowItems.length === 0) {
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ! Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù…ØªØ§Ø²', 'success');
    return;
  }
  
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ...', 'info', 2000);
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  // Header
  pdf.setFontSize(24);
  pdf.setTextColor(239, 68, 68);
  pdf.text('âš ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ', 105, 20, { align: 'center' });
  
  pdf.setFontSize(12);
  pdf.setTextColor(100, 100, 100);
  pdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`, 105, 30, { align: 'center' });
  pdf.text(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©: ${lowItems.length}`, 105, 38, { align: 'center' });
  
  let y = 55;
  pdf.setFontSize(10);
  pdf.setTextColor(0, 0, 0);
  
  // Alert box
  pdf.setFillColor(254, 226, 226);
  pdf.rect(20, y - 5, 170, 15, 'F');
  pdf.setTextColor(153, 27, 27);
  pdf.text('ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ ÙÙˆØ±ÙŠ', 25, y + 3);
  
  y += 20;
  
  // Table header
  pdf.setFillColor(239, 68, 68);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(20, y - 5, 170, 8, 'F');
  pdf.text('#', 25, y);
  pdf.text('Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„', 50, y);
  pdf.text('Ø§Ù„Ù†ÙˆØ¹', 100, y);
  pdf.text('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 150, y);
  
  y += 10;
  pdf.setTextColor(0, 0, 0);
  
  lowItems.forEach((item, idx) => {
    if (y > 270) {
      pdf.addPage();
      y = 20;
    }
    
    pdf.text(`${idx + 1}`, 25, y);
    pdf.text(item.model.toUpperCase(), 50, y);
    pdf.text(item.type, 100, y);
    pdf.setTextColor(239, 68, 68);
    pdf.setFont(undefined, 'bold');
    pdf.text(`${item.count}`, 150, y);
    pdf.setFont(undefined, 'normal');
    pdf.setTextColor(0, 0, 0);
    
    y += 8;
  });
  
  // Recommendations
  y += 10;
  pdf.setFontSize(12);
  pdf.setTextColor(37, 99, 235);
  pdf.text('Ø§Ù„ØªÙˆØµÙŠØ§Øª:', 20, y);
  
  y += 8;
  pdf.setFontSize(10);
  pdf.setTextColor(0, 0, 0);
  pdf.text('â€¢ ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡', 25, y);
  y += 6;
  pdf.text('â€¢ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª', 25, y);
  y += 6;
  pdf.text('â€¢ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 25, y);
  
  pdf.save(`low-stock-report-${Date.now()}.pdf`);
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ', 'success');
  logHistory('export', 'ØªÙ‚Ø±ÙŠØ± Ù†ÙˆØ§Ù‚Øµ PDF');
}

async function generateValueReport() {
  showToast('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info', 3000);
  // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹
}

async function generateBarcodeSheet() {
  const items = await getAll();
  
  if (items.length === 0) {
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ø±ÙƒÙˆØ¯', 'warning');
    return;
  }
  
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...', 'info', 2000);
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  pdf.setFontSize(18);
  pdf.setTextColor(37, 99, 235);
  pdf.text('Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 105, 15, { align: 'center' });
  
  let x = 20;
  let y = 30;
  const itemsPerRow = 2;
  const itemWidth = 85;
  const itemHeight = 40;
  
  items.forEach((item, idx) => {
    if (y > 260) {
      pdf.addPage();
      y = 20;
      x = 20;
    }
    
    // Box
    pdf.setDrawColor(200, 200, 200);
    pdf.rect(x, y, itemWidth, itemHeight);
    
    // Product info
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    pdf.text(item.model.toUpperCase(), x + 5, y + 8);
    
    pdf.setFontSize(9);
    pdf.setTextColor(100, 100, 100);
    pdf.text(item.type, x + 5, y + 14);
    
    // Barcode placeholder (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© JsBarcode Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ù‚ÙŠÙ‚ÙŠ)
    pdf.setFillColor(0, 0, 0);
    for (let i = 0; i < 30; i++) {
      const barWidth = Math.random() > 0.5 ? 1 : 0.5;
      pdf.rect(x + 5 + (i * 2.5), y + 20, barWidth, 12, 'F');
    }
    
    pdf.setFontSize(8);
    pdf.text(item.model.toUpperCase(), x + itemWidth / 2, y + 36, { align: 'center' });
    
    x += itemWidth + 10;
    
    if ((idx + 1) % itemsPerRow === 0) {
      x = 20;
      y += itemHeight + 5;
    }
  });
  
  pdf.save(`barcodes-${Date.now()}.pdf`);
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', 'success');
  logHistory('export', 'Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯');
}

/* ========================================
   DATA BACKUP & RESTORE (NEW)
======================================== */
async function backupData() {
  try {
    const inventory = await getAll();
    
    const backup = {
      version: '9.0',
      date: new Date().toISOString(),
      user: currentUser?.name || 'unknown',
      inventory: inventory,
      settings: settings
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `warehouse-backup-${Date.now()}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    logHistory('backup', 'Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
  } catch (err) {
    console.error('Backup error:', err);
    showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
  }
}

async function exportAllData() {
  await backupData();
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const backup = JSON.parse(text);
      
      if (!backup.inventory || !Array.isArray(backup.inventory)) {
        throw new Error('Invalid backup file');
      }
      
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${backup.inventory.length} Ù…Ù†ØªØ¬ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©!`)) {
        return;
      }
      
      // Clear current data
      const tx = db.transaction("inventory", "readwrite");
      const store = tx.objectStore("inventory");
      await store.clear();
      
      // Import new data
      backup.inventory.forEach(item => {
        store.add(item);
      });
      
      tx.oncomplete = () => {
        renderInventory();
        updateStats();
        updateQuickStats();
        
        showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${backup.inventory.length} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        logHistory('import', `Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${backup.inventory.length} Ù…Ù†ØªØ¬`);
      };
      
    } catch (err) {
      console.error('Import error:', err);
      showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù', 'error');
    }
  };
  
  input.click();
}

/* ========================================
   INITIALIZATION
======================================== */
document.addEventListener('DOMContentLoaded', () => {
  // Check for saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.classList.add('dark');
  }
  
  // Save theme on change
  const observer = new MutationObserver(() => {
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K: Focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const search = $('inventory-search');
      if (search) {
        search.focus();
        switchTab('inventory');
      }
    }
    
    // Ctrl/Cmd + /: Focus chat
    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
      e.preventDefault();
      const chatInput = $('chat-input');
      if (chatInput) {
        chatInput.focus();
        switchTab('chat');
      }
    }
    
    // Escape: Close modals
    if (e.key === 'Escape') {
      closeModal();
      closeSettings();
    }
  });
  
  console.log('%cğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ V9 - Ultimate Edition', 'font-size: 20px; color: #2563eb; font-weight: bold;');
  console.log('%câœ¨ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'font-size: 14px; color: #10b981;');
});

// Service Worker for offline support (optional)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Service Worker Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
    // navigator.serviceWorker.register('/sw.js');
  });
}

/* ========================================
   PERFORMANCE OPTIMIZATION
======================================== */
// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Apply debounce to search
const searchInput = $('inventory-search');
if (searchInput) {
  const debouncedRender = debounce(renderInventory, 300);
  searchInput.addEventListener('input', debouncedRender);
}

/* ========================================
   ERROR HANDLING
======================================== */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.error);
  showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('Unhandled promise rejection:', e.reason);
  showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
});

/* ========================================
   ANALYTICS & TRACKING (Optional)
======================================== */
function trackEvent(category, action, label) {
  // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Google Analytics Ø£Ùˆ Ø£ÙŠ Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø¢Ø®Ø±
  console.log(`Event: ${category} - ${action} - ${label}`);
}

/* ========================================
   EASTER EGG ğŸ‰
======================================== */
let konamiCode = [];
const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

document.addEventListener('keydown', (e) => {
  konamiCode.push(e.key);
  konamiCode = konamiCode.slice(-10);
  
  if (konamiCode.join(',') === konamiSequence.join(',')) {
    showToast('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø§ÙƒØªØ´ÙØª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ!', 'success', 5000);
    speak('Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø§ÙƒØªØ´ÙØª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ. Ø£Ù†Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ØªØ±Ù!');
    
    // Add some fun animation
    document.body.style.animation = 'rainbow 2s linear infinite';
    setTimeout(() => {
      document.body.style.animation = '';
    }, 5000);
  }
});

// Rainbow animation for easter egg
const style = document.createElement('style');
style.textContent = `
  @keyframes rainbow {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
  }
`;
document.head.appendChild(style);

</script>
</body>
</html>
